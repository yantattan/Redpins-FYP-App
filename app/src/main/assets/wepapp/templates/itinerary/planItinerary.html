{% extends "base.html" %}
{% block title %}Redpins Buffer - Planner{% endblock %}

{% block content %}
<div>
    <label>End Time</label>
    <input id="endTime" type="time" class="form-control"></input>
</div>
<div>Transport mode: Transit</div>
<div>Category: Eateries</div>
<div id="start">Start location: </div>
<div class="btn btn-primary" id="recommend-btn" onclick="recommend(1);">Recommend</div>
<div class="float-right">
    <a href="/itinerary/showTrip">Map</a>
</div>
<div id="recommendation-listings" style="width: 100%;align-items: stretch;
display: flex;
flex-direction: row;
flex-wrap: nowrap;
overflow-x: auto; overflow-y: hidden;">

</div>
<button class="btn btn-primary" id="next-recommend-btn" onclick="nextRecommend();">Next</button>
<br>
<label>End destination</label>
<input type="text" id="endDestination" class="form-control" onkeyup="pauseSearch();"></input>
<div id="show-destinations">   
</div>

<button class="btn btn-primary">Create Trip</button>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
    var post;
    var skipped = [0];
    var pageNum = 2;

    // function initFunctions() {
    //     $("#recommend-btn").on("click", function() {
    //         recommend(1);
    //     })
    //     $("#next-recommend-btn").on("click", function() {
    //         recommend(pageNum);
    //         pageNum += 1;
    //     })
    // }

    function nextRecommend() {
        recommend(pageNum);
        pageNum += 1;
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showRoute)
        }
    }

    function showRoute(position) {
        document.getElementById("start").innerText += position.coords.latitude + "," + position.coords.longitude
        post = position
    }

    function recommend(pageNum) {
        $.ajax({
            type: "POST",
            url: `/funcs/planner-recommend-places?page=${pageNum}`,
            data: {
                latitude: post.coords.latitude,
                longitude: post.coords.longitude,
                timeAllowance: 100,
                category: "Eateries",
                transportMode: "pt",
                skipped: JSON.stringify(skipped)
            },
            success: function(result) {
                cleanedResult = result.replaceAll("\\u", "").replaceAll("NaN", `""`);
                result = JSON.parse(cleanedResult);

                skipped = result.skipped;
                console.log(result)
                console.log(result.skipped);
                div = document.getElementById("recommendation-listings");
                for (var i in result.list) {
                    div.innerHTML += `<div class="card" style="width:150px; height:175px; margin-right: 1em; max-width:
                        flex-basis: 33.333%;
                        flex-grow: 0;
                        flex-shrink: 0;">
                        <h5>${result.list[i].Restaurant_name}</h5>
                        <br />
                        <p>Matching ${result.list[i].RecommendationScore.toFixed(2)}</p>
                    </div>`;
                }
            }
        })
       
    }

    var canSearch = true;

    function pauseSearch() {
        canSearch = false;
        console.log("Here");
        setTimeout(function() {
            canSearch = true;
            search()
        }, 1000)
    }

    function search() {
        if (canSearch) {
            var dropdownMenu = document.getElementById("show-destinations");
            const search = $("#endDestination").val()
            const pageNum = $("#searchPage").val()
            if (!search) {
                dropdownMenu.innerHTML = ""; 
            }
            else {
                $.ajax({
                url: `https://developers.onemap.sg/commonapi/search?searchVal=${search}&returnGeom=Y&getAddrDetails=Y&pageNum=${pageNum}`,
                success: function(result) {
                    dropdownMenu.innerHTML = "";
                    showLength = 6;
                    if (result.results.length > 0) {
                        if (result.results.length < 6) {
                            showLength = result.results.length;
                        }

                        for (var i=0; i<showLength; i++) {
                            record = result.results[i]
                            dropdownMenu.innerHTML += `
                            <div class="dropdown-item" onclick="">
                                <p style="font-size: 14px;"><b>${record.SEARCHVAL}</b></p>
                                <p style="font-size: 11px; max-width: 100%; overflow: auto;">${record.ADDRESS}</p>
                            </div>`;
                        }
                    }
                    else {
                        dropdownMenu.innerHTML = `<div class="dropdown-item">No results found</div>`; 
                    }
                }});
            }
            
        }       
    } 

    function searchNextPage() {
        $("#searchPage").text(parseInt($("#searchPage").text()) + 1)
    }

    // initFunctions();
    getLocation();

</script>
{% endblock %}