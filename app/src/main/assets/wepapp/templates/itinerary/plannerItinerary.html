{% extends "base.html" %}
{% block title %}Redpins Buffer - Planner{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
<script src="https://cdn.onemap.sg/leaflet/onemap-leaflet.js"></script>
<script type="text/javascript" src="https://rawgit.com/jieter/Leaflet.encoded/master/Polyline.encoded.js"></script>


<div class="device" id="reloadingbg" style="display: none;">
    <img src="/static/images/logo.gif" alt="logo" class="relogogif">
    <p>Hang tight while we find the best places for you...</p>
</div>

<div class="main-div">
    {% if itineraries != None %}
    <div id="initForm" style="position: absolute; z-index:2; background-color: white; display: none; bottom: -200vh;">
    {% else %}
    <div id="initForm" style="position: absolute; z-index:2; background-color: white;">
    {% endif %}
        <label for="">Where to?</label>
        <input type="text" id="city" value="Local">
        <label for="startDate">Start Date</label>
        <input type="date" id="startDate" value="{% if itineraries != None %}{{itineraries[0].getDate().strftime('%Y-%m-%d')}}{% endif %}" onchange="checkResetEndDate(); checkInitPage();">
        <label for="endDate">End Date</label>
        <input type="date" id="endDate" value="{% if itineraries != None %}{{itineraries[-1].getDate().strftime('%Y-%m-%d')}}{% endif %}" onchange="checkInitPage();">

        <button class="maincta-disabled" id="initPageNext">Next</button>
    </div>

    <div id="dates-selection" style="display: inline; overflow-x: auto;">
        {% if itineraries != None %}{% for itinerary in itineraries %}
        <div class="card card-date" style="width: 150px;" onclick="toggleDay(this);">
            <h5>{{itinerary.getDate().strftime("%Y-%m-%d")}}</h5>
            <p class="tm-selection">{% if itinerary.getTransportMode() == "pt" %}Public Transport{% else %}{{itinerary.getTransportMode()}}{% endif %}<span hidden>{{itinerary.getTransportMode()}}</span></p>
            <ul class="tm" style="display: block;">
                <li onclick="chooseTransportMode(this);">Drive<span hidden>drive</span></li>
                <li onclick="chooseTransportMode(this);">Public Transport<span hidden>pt</span></li>
                <li onclick="chooseTransportMode(this);">Bus<span hidden>bus</span></li>
                <li onclick="chooseTransportMode(this);">Walk<span hidden>walk</span></li>
                <li onclick="chooseTransportMode(this);">Cycle<span hidden>cycle</span></li>
            </ul>
        </div>
        {% endfor %}{% endif %}
        <div class="card" id="card-date-add" onclick="openInitPage();" style="width: 100px;">
            <h5>+ Add day</h5>
        </div>
    </div>
    
    {% if itineraries == None %}
    <div id="planPage" style="display: none; position: absolute;">
    {% else %}
    <div id="planPage" style="display: block; position: absolute;">
    {% endif %}
        {% if itineraries != None %}
            {% for i in range(itineraries|length) %}
            {% set itinerary = itineraries[i] %}
            <div class="device planSection" style="display: none;">
                <div class="float-right">
                    <p onclick="openMapView();">Map</p>
                </div>
                
                <div class="time-left">Duration left: <span>{{itinerary.getTimeLeft()| int}}</span></div>
                <div class="transport-text">Transport mode: {% if itinerary.getTransportMode() == "pt" %}Public Transport{% else %}{{itinerary.getTransportMode()}}{% endif %}</div>
            
                <div class="recommendation-listings">
                    {% if itinerary.getPlaces()| length == 0 %}
                    <button class="btn-addColor start-location" onclick="openSearch(this, '{{i+1}}');">+ Add start Location</button>
                    {% elif itinerary.getPlaces()| length == 1 %}
                    <div class="card plan-selection start">
                        <h5 class="plan-name">{{itinerary.getPlaces()[0].Name}}</h5>
                        <p class="plan-address" style="font-size:12px">{{itinerary.getPlaces()[0].Address}}</p>
                        <br />
                        <p class="plan-timing"></p>
                        <p class="plan-latlng" hidden>{{itinerary.getPlaces()[0].Latlng}}</p>
                    </div>
                    <button class="btn-addColor" onclick="removeFirstBtn(this); recommend(1, 1, this);">+ Add a place</button>
                        {% if not itinerary.getEnd() %}
                        <button class="btn-addColor end-location" onclick="openSearch(this, '{{i+1}}');">+ Add end Location</button>
                        {% endif %}
                    {% else %}
                        {% for i in range(itinerary.getPlaces()| length) %}
                            <div class="card plan-selection {% if i == itinerary.getPlaces()| length - 1 and itinerary.getEnd() %}end{% endif %}">
                                <h5 class="plan-name">{{itinerary.getPlaces()[i].Name}}</h5>
                                <p class="plan-address" style="font-size:12px">{{itinerary.getPlaces()[i].Address}}</p>
                                <br />
                                <p class="plan-timing"></p>
                                <p class="plan-activity-duration">{% if itinerary.getPlaces()[i].ActivityDuration %}<span>{{itinerary.getPlaces()[i].ActivityDuration}}</span> min{% else %}<span></span>{% endif %}</p>
                                <p class="plan-total-duration">{% if itinerary.getPlaces()[i].TotalDuration %}<span>{{itinerary.getPlaces()[i].TotalDuration|int}}</span> min{% else %}<span></span>{% endif %}</p>
                                <p class="plan-latlng" hidden>{{itinerary.getPlaces()[i].Latlng}}</p>
                                {% if i != itinerary.getPlaces()| length - 1 and i != 0 %}
                                <p class="plan-edit" onclick="editCard(this, parseInt('{{i+1}}'))">Edit</p>
                                <p class="plan-delete" onclick="delCard(this, parseInt('{{i+1}}'))">Delete</p>
                                {% endif %}
                            </div>
                            {% if i != itinerary.getPlaces()| length - 1 %}
                            <button class="btn-addPlan btn-addColor" onclick="recommend(1, parseInt('{{i+1}}'), this);">  +  </button>
                            {% elif not itinerary.getEnd() %}
                            <button class="btn-addPlan btn-addColor" onclick="recommend(1, parseInt('{{i+1}}'), this);">  +  </button>
                            {% endif %}
                        {% endfor %}
                        {% if not itinerary.getEnd() %}
                        <button class="btn-addColor end-location" onclick="openSearch(this, '{{i+1}}');">+ Add end Location</button>
                        {% endif %}
                    {% endif %}
                </div>
                <button class="btn btn-primary" id="next-recommend-btn" onclick="nextRecommend();">Next</button>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    

    <!-- Map View -->
    <div class="device" id="mapView" style="position: fixed; z-index:-2;">
        <div id='mapdiv' style='height:80vh;'></div>
        <div id="map-selection" style="height:20vh; z-index:-1; overflow-x: auto;">
            <button class="btn-addColor" onclick="dismissMapView();">x</button>
            <div id="map-sections" style="display: inline; overflow-x: auto; overflow-y: auto;">

            </div>
        </div>
    </div>

    <!-- Popup -->
    <div id="changesPopup" style="display: none; position: absolute; top: 50%;">
        <p id="changes-text">You've changed the starting date of your itinerary. What action do you wish to perform ?</p>
        <p class="text-primary" onclick="dateChangesAction(1)">Leave itinerary in their respective pages</p>
        <p class="text-danger" onclick="dateChangesAction(2)">Reset itinerary</p>
    </div>

    <form method="POST">
        <input id="planner-id" name="plannerId" value="{% if itineraries != None %}{{itineraries[0].getPlannerId()}}{% endif %}" hidden readonly>
        <input type="submit" value="Review Trip" class="btn btn-primary">
    </form>
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
    var skipped = [0];
    var pendingChooseList = {};
    var startTime = new Date("2022-01-01T08:00:00");
    var allowanceLeft;
    var originalDuration;
    const currentDate = new Date();

    var requests = [];

    function initFunctions() {
        getLocation();
        const todayDate = currentDate.toISOString().split("T")[0]
        document.getElementById("startDate").min = todayDate;
        document.getElementById("startDate").value = todayDate;

        document.getElementById("endDate").min = todayDate;

        toggleDay(0);
        initAllowance();
        reAssignValues();
    }
    function initAllowance() {
            // Set time allowance
            var startTmeArr = ["08", "00"];
            var endTmeArr = ["23", "59"];
            var startDate = new Date(0, 0, 0, startTmeArr[0], startTmeArr[1], 0);
            var endDate = new Date(0, 0, 0, endTmeArr[0], endTmeArr[1], 0);
            var diff = endDate.getTime() - startDate.getTime();
            allowanceLeft = Math.floor(diff / 1000 / 60);
            originalDuration = Math.floor(diff / 1000 / 60);

            var allSections = document.getElementsByClassName("planSection");
            for (var i=0; i<allSections.length; i++) {
                if (allSections[i].querySelector(".time-left").querySelector("span").innerText.length > 0)
                    allSections[i].querySelector(".time-left").querySelector("span").innerText = allowanceLeft;
            }
        }

    function openInitPage() {
        $("#initForm").show();
        $("#initForm").animate({
            bottom: "0"
        });
        checkInitPage();
    }

    function checkInitPage() {
        var valid = true;
        var initDiv = document.getElementById("initForm");
        var allInps = initDiv.getElementsByTagName("input");
        var nextBtn = document.getElementById("initPageNext");

        for (var i=0; i<allInps.length; i++) {
            if (allInps[i].value.trim() == "") {
                valid = false;
                break;
            }
        }

        var startDateVal = $("#startDate").val();
        if (isNaN(Date.parse(startDateVal)))
            valid = false;
        if (isNaN(Date.parse(endDate.value)))
            valid = false;

        if (valid) {
            nextBtn.setAttribute("onclick", "dismissInit();")
            nextBtn.classList.remove("maincta-disabled");
            nextBtn.classList.add("maincta");
        }
        else {
            nextBtn.removeAttribute("onclick");
            nextBtn.classList.remove("maincta");
            nextBtn.classList.add("maincta-disabled");
        }
    }
    var oldVal;
    function checkResetEndDate() {
        var startDateVal = $("#startDate").val();
        var endDateVal = $("#endDate").val();

        if (startDateVal.trim()) {
            if (startDateVal != oldVal) {
                $("#endDate").val("");
                $("#endDate").attr("min", new Date(startDateVal).toISOString().split("T")[0]);
                oldVal = startDateVal;
            }
        }
    }
    async function dismissInit() {
        var initDiv = document.getElementById("initForm");
        var datesDiv = document.getElementById("dates-selection");
        var plansDiv = document.getElementById("planPage");
        var firstDiv = document.getElementById("firstSelection");
        var startDate = new Date($("#startDate").val());
        var endDate = new Date($("#endDate").val());

        var days = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 3600 * 24)) + 1;
        var datesSelection = document.querySelector("#dates-selection");
        var dateCards = [].slice.call(document.getElementsByClassName("card-date"));
        var diff = days - dateCards.length;
        
        if (dateCards.length > 0) {
            // Prompt for action
            if (startDate > new Date(dateCards[0].querySelector("h5").innerText)) {
                $("#changesPopup").fadeIn(150);
            }

            datesSelection.innerHTML = 
            `<div class="card" id="card-date-add" onclick="openInitPage();" style="width: 100px;">
                <h5>+ Add day</h5>
            </div>`;
        }

        // Pull form down
        $("#initForm").animate({
            bottom: "-200vh"
        }, 350, function() {
            $("#initForm").hide();
        });
        $("#planPage").show();

        var checkDate = startDate;
        for (var i=0; i<days; i++) {
            await new Promise(resolve => setTimeout(resolve, 150));
            var cardDate = new DOMParser().parseFromString(`
            <div class="card card-date" style="width: 150px;" onclick="toggleDay(this);">
                <h5>${checkDate.toISOString().slice(0, 10)}</h5>
                <p class="tm-selection">drive<span hidden>drive</span></p>
                <ul class="tm" style="display: block;">
                    <li onclick="chooseTransportMode(this);">Drive<span hidden>drive</span></li>
                    <li onclick="chooseTransportMode(this);">Public Transport<span hidden>pt</span></li>
                    <li onclick="chooseTransportMode(this);">Bus<span hidden>bus</span></li>
                    <li onclick="chooseTransportMode(this);">Walk<span hidden>walk</span></li>
                    <li onclick="chooseTransportMode(this);">Cycle<span hidden>cycle</span></li>
                </ul>
            </div>`, "text/html").body.firstElementChild;

            datesDiv.insertBefore(cardDate, document.querySelector("#card-date-add"));
            checkDate.setDate(checkDate.getDate() + 1);  
        }

        datesDiv.querySelector(".card-date").classList.add("addColor");

        // Add days card
        var plansSec = new DOMParser().parseFromString(
        `<div class="device planSection" style="display: none;">
            <div class="float-right">
                <a href="/itinerary/showTrip">Map</a>
            </div>

            <div class="time-left">Duration left: <span></span></div>
            <div class="transport-text">Transport mode: </div>

            <div class="recommendation-listings">
                <button class="btn-addColor start-location" onclick="openSearch(this, '1');">+ Add start Location</button>
            </div>
        </div>`, "text/html").body.firstElementChild.cloneNode(true);
        var allSections = document.getElementsByClassName("planSection");
        for (var i=0; i<Math.abs(diff); i++) {
            if (diff > 0) {
                var clonedPlansSec = plansSec.cloneNode(true);
                clonedPlansSec.style.display = "none";
                plansDiv.appendChild(clonedPlansSec);
            }
            else if (diff < 0) {
                // TODO: Change query selector h5 change in the future
                if (startDate > new Date(dateCards[0].querySelector("h5").innerText)) {
                    allSections[i].remove();
                }
                else {
                    allSections[dateCards.length-1].remove();
                }
            }
        }

        plansDiv.querySelector(".planSection").style.display = "block";
        initAllowance();

        saveTrips();
    }

    function dateChangesAction(actionNum) {
        if (actionNum == 2) {
            var div = document.getElementsByClassName("recommendation-listings");
            for (i=0; i<div.length; i++) {
                div.innerHTML = `<button class="btn-addColor start-location" onclick="openSearch(this, '${i+1}');">+ Add start Location</button>`;
            }
        }

        saveTrips();
        $("#changesPopup").fadeOut(150);
    }

    function removeFirstBtn(btn) {
        btn.classList.add("btn-addPlan")
        btn.innerText = " +  ";
    }

    function nextRecommend() {
        recommend(pageNum);
        pageNum += 1;
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(showYourPosition, positioningError, {
                timeout: 500,
                enableHighAccuracy: true
            });
        }
    }

    // Choose transport mode
    function chooseTransportMode(btn) {
        var cardDate = btn.closest(".card-date");
        cardDate.querySelector(".tm-selection").innerHTML = btn.innerHTML;

        saveTrips();
    }

    // Order - the positional order of the button in DOM
    function recommend(pageNum, order, btn) {
        // Stop pending ajax req
        if (requests.length > 0) {
            while (requests.length > 0) {
                try {
                    requests[0].abort();
                }
                catch (e) {}
                finally {
                    requests.pop(0);
                }
            }
        }

        var planSection = btn.closest(".planSection")
        var div = planSection.querySelector(".recommendation-listings");
        var allCards = div.getElementsByClassName("plan-selection");

        var beforeDiv = document.getElementsByClassName("plan-selection")[order-1];
        if (beforeDiv && order > 1) {
            calStartTme = startTime;
            for (var i=1; i<order; i++) {
                calStartTme = new Date(calStartTme.getTime() + parseFloat(allCards[i].querySelector(".plan-total-duration").querySelector("span").innerText)*60000);
            }
            
            var startTmeUn = calStartTme.toLocaleTimeString('en-SG', {hour12: false});
            startTme = startTmeUn.substring(0, startTmeUn.length-3);
            if (startTme.length == 4) {
                startTme = 0 + startTme;
            }
        }

        transportMde = "pt";

        $("#reloadingbg").show();
        // Get place before and registered places
        var registeredPlaces = [].slice.call(allCards).slice(1, allCards.length - 1).map(x => x.querySelector(".plan-address").innerText);
        if (order - 1 > 0) {
            var placeBefore = allCards[order-1].querySelector(".plan-address").innerText;
            var latlng = allCards[order-1].querySelector(".plan-latlng").innerText.split(",");
        }
        else {
            var placeBefore;
            var latlng = document.getElementById("start-latlng").innerText.split(",");
        }

        if (order < allCards.length) {
            var placeAfter = allCards[order].querySelector(".plan-address").innerText;
        }
        else {
            var placeAfter;
        }
        
        console.log(allowanceLeft);
        request = $.ajax({
            type: "POST",
            url: `/funcs/planner-recommend-places?page=${pageNum}`,
            data: {
                date: "2022-05-12",
                startTime: "05:00",
                endTime: "23:59",
                timeLeft: allowanceLeft,
                latitude: latlng[0],
                longitude: latlng[1],
                category: "Eateries",
                transportMode: transportMde,
                skipped: JSON.stringify(skipped),
                placesAdded: registeredPlaces,
                abovePlace: placeBefore,
                belowPlace: placeAfter
            },
            success: function(result) {
                cleanedResult = result.replaceAll("\\u", "").replaceAll("NaN", `""`);
                result = JSON.parse(cleanedResult);
                pendingChooseList[order] = result;
                pendingChooseList[order].pageNum = 2;

                var listing = new DOMParser().parseFromString(
                    `<div class="plan-choices-list">
                    </div>`, "text/html").body.firstElementChild;

                var allAddBtns = div.getElementsByClassName("btn-addPlan");
                console.log(order+", "+allAddBtns.length)
                
                div.insertBefore(listing, allAddBtns[order-1].nextSibling);

                if (result.list.length > 0) {
                    for (var i in result.list) {
                        listing.innerHTML += 
                        `<div class="card plan-choice" style="width:150px; height:175px; margin-right: 1em; max-width:
                            flex-basis: 33.333%;
                            flex-grow: 0;
                            flex-shrink: 0;" onclick="choosePlace(this, ${order}, ${i});">
                            <h5>${result.list[i].Name}</h5>
                            <p style="font-size:12px">${result.list[i].Address}</p>
                            <br />
                            <p>Matching ${result.list[i].RecommendationScore.toFixed(2)}</p>
                        </div>`;

                    }
                }
                else {
                    listing.innerHTML += `<div class="card">There isn't any available places to be added</div>`;
                    var allBtns = div.getElementsByClassName("btn-addPlan");
                    for (var i=0; i<allBtns.length; i++) {
                        allBtns[i].disabled = true;
                        allBtns[i].classList.remove("btn-addColor");
                    }
                }

                listing.innerHTML += `<p onclick="nextRecommend()" class="list-load-more">Load more</p>`;
            },
            error: function(jq, status, errorMsg) {
                div.innerHTML = 
                `<div class="plan-choices-list">
                    Something went wrong. Try again
                </div>`;
            },
            complete: function(result) {
                $("#reloadingbg").hide();
            }
        });
    }

    function choosePlace(btn, order, itemNo) {
        var div = btn.closest(".recommendation-listings");
        btn.parentElement.remove();
        var info = pendingChooseList[order].list[itemNo];

        var newPlace = new DOMParser().parseFromString(`
            <div class="card plan-selection">
                <h5 class="plan-name">${info.Name}</h5>
                <p class="plan-address" style="font-size:12px">${info.Address}</p>
                <br />
                <p class="plan-timing"></p>
                <p class="plan-activity-duration"><span>${Math.round(info.ActivityDuration)}</span> min</p>
                <p class="plan-total-duration"><span>${Math.round(info.Duration)}</span> min</p>
                <p class="plan-latlng" hidden>${info.Latlng}</p>
            </div>`, "text/html").body.firstElementChild;
        var newBtn = new DOMParser().parseFromString(`   
            <button class="btn-addPlan btn-addColor" onclick="recommend(1, ${order+1});">  +  </button>`, "text/html").body.firstElementChild;

        var allAddBtns = div.getElementsByClassName("btn-addPlan");
        console.log(order, allAddBtns.length)
        
        div.insertBefore(newBtn, allAddBtns[order-1].nextSibling);
        div.insertBefore(newPlace, allAddBtns[order-1].nextSibling);
        var timeLeft = div.parentElement.querySelector(".time-left").querySelector("span")
        
        timeLeft.innerText = parseInt(timeLeft) - info.Duration;
        
        // Fill up info for autosaving data
        saveTrips();
        reAssignValues();
    }

    // Edit/delete/rearrange
    async function editCard(btn, order) {
        var card = btn.closest(".plan-selection");
        var timeLeft = card.parentElement.parentElement.querySelector(".time-left").querySelector("span");
        card.closest(".recommendation-listings").getElementsByClassName("btn-addPlan")[order-1].remove();
        reAssignValues();

        timeLeft.innerText = parseInt(timeLeft.innerText) + parseInt(card.querySelector(".plan-total-duration").querySelector("span").innerText);
        await recommend(1, order-1, card);
        card.remove();
    }

    function delCard(btn, order) {
        var card = btn.closest(".plan-selection");
        var div = btn.closest(".recommendation-listings");
        div.getElementsByClassName("btn-addPlan")[order-1].remove();
        card.remove();

        var timeLeft = div.parentElement.querySelector(".time-left").querySelector("span");
        timeLeft.innerText = parseInt(timeLeft.innerText) + parseInt(card.querySelector(".plan-total-duration").querySelector("span").innerText);

        reAssignValues();
        reCal2Places(div, order-1);
    }

    // Recalculate route and travel time
    async function reCal2Places(div, order) {
        var cards = div.getElementsByClassName("plan-selection");
        var index = [].slice.call(document.getElementsByClassName("recommendation-listings")).indexOf(div);
        var aboveCard = cards[order-1];
        var belowCard = cards[order];
        var totalDuration = 0;
        for (var i=1; i<order-1; i++) {
            var duration = parseFloat(cards[i].querySelector(".plan-total-duration").querySelector("span").innerText);
            totalDuration += duration;
        }
        var divDate = new Date($("#startDate").val());
        divDate = new Date(divDate.setDate(divDate.getDate() + (order-1)));

        await $.ajax({
            type: "POST",
            url: `/funcs/reCalculate`,
            data: {
                latlngs: [aboveCard.querySelector(".plan-latlng").innerText, belowCard.querySelector(".plan-latlng").innerText],
                routeType: "pt",
                date: divDate.toISOString().slice(0, 10),
                topDuration: totalDuration,
                startTime: aboveCard.querySelector(".plan-timing")
            },
            success: function(result) {
                result = JSON.parse(result);
                var belowCardTDuration = belowCard.querySelector(".plan-total-duration").querySelector("span");
                var belowCardADuration = belowCard.querySelector(".plan-activity-duration").querySelector("span");
                var timeDiff = result[0] + parseInt(belowCardADuration.innerText) - parseInt(belowCardTDuration.innerText);
                belowCardTDuration.innerText = parseInt(belowCardADuration.innerText) + result[0];
                div.parentElement.parentElement.querySelector(".time-left").querySelector("span").innerText = parseInt(div.parentElement.parentElement.querySelector("#time-left").querySelector("span").innerText) + timeDiff;
            }
        })

        saveTrips();
    }

    function reAssignValues() {
        var div = document.getElementsByClassName("recommendation-listings");

        for (var i=0; i<div.length; i++) {
            var btn = div[i].getElementsByClassName("btn-add-place");
            for (var j=0; j<btn.length; j++) {
                btn[j].setAttribute("onclick", `recommend(1, ${j+1}, this);`);
            }

            var plansCards = div[i].getElementsByClassName("plan-selection");

            var startTme = startTime;
            var currTime = startTme.toLocaleTimeString('en-SG', {hour12: false})
            if (plansCards.length > 0) {
                plansCards[0].querySelector(".plan-timing").innerText = currTime.substring(0, currTime.length-3);
                for (var j=1; j<plansCards.length-1; j++) {
                    startTme.setTime(startTme.getTime() + parseInt(plansCards[j].querySelector(".plan-total-duration").querySelector("span").innerText)*60000);

                    currTime = startTime.toLocaleTimeString('en-SG', {hour12: false})
                    plansCards[j].querySelector(".plan-timing").innerText = currTime.substring(0, currTime.length-3);
                }
            }

        }
    }

    async function saveTrips() {
        var div = document.getElementsByClassName("recommendation-listings");
        var cardDates = document.getElementsByClassName("card-date");
        var checkDate = new Date($("#startDate").val());

        var plannerIdStr = document.querySelector("#planner-id").value; 
        if (plannerIdStr.trim().length == 0)
            plannerIdStr = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
        document.querySelector("#planner-id").value = plannerIdStr;

        async function reset() {
            await $.ajax({
                type: "POST",
                url: `/funcs/clear-planner?id=${$("#planner-id").val()}`,
                data: {},
                success: function(result) {
                    console.log("System: Reset planner. Waiting for new planner ...");
                }
            });
        }
        async function save(index) {
            await $.ajax({
                type: "POST",
                url: `/funcs/save-trip`,
                data: {
                    tripType: "Planner",
                    tripName: "Hello",
                    date: checkDate.toISOString().slice(0, 10),
                    names: placesName,
                    addresses: placesAddress,
                    activityDuration: placesActivityDuration,
                    duration: placesDuration,
                    latlngs: placesLatlng,
                    transportMode: cardDates[index].querySelector(".tm-selection").querySelector("span").innerText,
                    confirmed: false,
                    status: "Planning",
                    plannerId: plannerIdStr,
                    hasEnd: hasE
                },
                success: function(result) {
                    result = JSON.parse(result);
                    document.querySelector("#planner-id").value = result.plannerId;
                    console.log("System: Trip "+(index+1)+" saved.");
                }
            });
        }

        reset();
        for (var i=0; i<div.length; i++) {
            // Update db function
            var allPlacesDiv = div[i].getElementsByClassName("plan-selection");
            var placesName = [];
            var placesAddress = [];
            var placesActivityDuration = [];
            var placesDuration = [];
            var placesLatlng = [];

            for (var j=0; j<allPlacesDiv.length; j++) {
                placesName.push(allPlacesDiv[j].querySelector(".plan-name").innerText);
                placesAddress.push(allPlacesDiv[j].querySelector(".plan-address").innerText);
                if (j == 0 || allPlacesDiv[j].classList.contains("end")) {
                    placesActivityDuration.push(null);
                    placesDuration.push(null);
                }
                else {
                    placesActivityDuration.push(parseInt(allPlacesDiv[j].querySelector(".plan-activity-duration").querySelector("span").innerText));
                    placesDuration.push(parseInt(allPlacesDiv[j].querySelector(".plan-total-duration").querySelector("span").innerText));
                }
                placesLatlng.push(allPlacesDiv[j].querySelector(".plan-latlng").innerText);
            }

            var hasE = false;
            if (allPlacesDiv.length > 0) {
                hasE = allPlacesDiv[allPlacesDiv.length-1].classList.contains("end")
            }

            await save(i);

            checkDate.setDate(checkDate.getDate() + 1);
        }
    }

    var canSearch = true;
    var dropdownCooldown = false;

    // Searching - for adding start and end location
    function openSearch(btn, order) {
        // Pull screen up
        $("#searchTab").show();
        $("#searchTab").animate({
            bottom: "0vh"
        }, 350, function () {
            document.querySelector("#searchBar").focus();
        });
        var btnClassList = btn.classList;
        var idClass;
        for (var i=0; i<btnClassList.length; i++) {
            if (btnClassList[i].substring(btnClassList[i].length - 9, btnClassList[i].length) == "-location") {
                idClass = btnClassList[i];
                break;
            }
        }

        $("#search-btnId").text(idClass);
        $("#search-divOrder").text(order);
    }
    function closeSearch() {
        // Pull screen down
        $("#searchTab").animate({
            bottom: "-200vh"
        }, 350, function() {
            $("#searchTab").hide();
        });
    }

    function pauseSearch() {
        canSearch = false;
        setTimeout(function() {
            canSearch = true;
            search();
        }, 350);
    }
    
    function search() {
        if (canSearch) {
            var dropdownMenu = document.querySelector("#search-results");
            const search = document.querySelector("#searchBar").value;
            const pageNum = $("#searchPage").val()

            if (!search.trim()) {
                dropdownMenu.innerHTML = "";
            }
            else {
                $.ajax({
                    url: `https://developers.onemap.sg/commonapi/search?searchVal=${search}&returnGeom=Y&getAddrDetails=Y&pageNum=${pageNum}`,
                    success: function(result) {
                        dropdownMenu.innerHTML = "";
                        if (result.results.length > 0) {
                            dropdownMenu.style.display = "block";
                            showLength = 10;
                            if (result.results.length < 10) {
                                showLength = result.results.length;
                            }

                            for (var i=0; i<showLength; i++) {
                                dropdownCooldown = true;
                                record = result.results[i]
                                dropdownMenu.innerHTML += `
                                <div class="dropdown-item" onclick="addSE(this);">
                                    <p style="font-size: 14px; margin-bottom: 3px; font-weight: bold;">${capitalize(record.SEARCHVAL)}</p>
                                    <p style="font-size: 11px; max-width: 100%; overflow: auto; margin-bottom: 3px;">${capitalize(record.ADDRESS)}</p>
                                    <p hidden>${record.LATITUDE},${record.LONGITUDE}</p>
                                </div>`;

                                setTimeout(function () { dropdownCooldown = false; }, 126)
                            }
                        }
                        else {
                            dropdownMenu.innerHTML = `<div class="dropdown-item">No results found</div>`; 
                        }
                    }
                });
            }

        }     
    }

    function searchNextPage() {
        $("#searchPage").text(parseInt($("#searchPage").text()) + 1)
    }

    function addSE(card) {
        var btnId = $("#search-btnId").text();
        var divOrder = parseInt($("#search-divOrder").text());
        var div = document.getElementsByClassName("recommendation-listings")[divOrder-1];
        var btn = div.querySelector(`.${btnId}`);
        
        var allP = card.getElementsByTagName("p");
        var newCard = new DOMParser().parseFromString(
            `<div class="card plan-selection">
                <h5 class="plan-name">${allP[0].innerText}</h5>
                <p class="plan-address" style="font-size:12px">${allP[1].innerText}</p>
                <br />
                <p class="plan-latlng" hidden>${allP[2].innerText}</p>
            </div>`, "text/html").body.firstElementChild;

        if (btnId == "start-location") {
            newCard.classList.add("start");
        }
        else
            newCard.classList.add("end");

        div.replaceChild(newCard, btn);
        if (btnId == "start-location") 
            div.innerHTML += 
                `<button class="btn-addColor" onclick="removeFirstBtn(this); recommend(1, 1, this);">+ Add a place</button>
                <button class="btn-addColor end-location" onclick="openSearch(this, '${divOrder}');">+ Add end Location</button>`;

        closeSearch();
        saveTrips();
    }

    function toggleDay(card) {
        var dateCards = document.getElementsByClassName("card-date");
        var index = card;
        if (!Number.isInteger(card))
            index = [].slice.call(dateCards).indexOf(card);
        var planSections = document.getElementsByClassName("planSection");

        for (var i=0; i<dateCards.length; i++) {
            if (i == index) {
                planSections[i].style.display = "block";
                dateCards[i].classList.add("addColor");
            }
            else {
                planSections[i].style.display = "none";
                dateCards[i].classList.remove("addColor");
            }
        }

        
    }

    // Map settings
    // Map display init
    const apiKey = "{{apiKey}}";
    L.Icon.Default.imagePath = "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/images";
    var center = L.bounds([1.56073, 104.11475], [1.16, 103.502]).getCenter();
    var map = L.map('mapdiv').setView([center.x, center.y], 12);
    var yourMarker;
    var startMarker;
    var endMarker;

    var routeTextures = {
        WALK: {color: "black", dashArray: "10, 10"},
        SUBWAY: {
            NE: {color: "purple"},
            NS: {color: "red"},
            DT: {color: "blue"},
            EW: {color: "green"},
            CC: {color: "yellow"},
            TE: {color: "brown"},
            Default: {color: "grey"}
        },
        DRIVE: {color: "black"}
    }

    var basemap = L.tileLayer(`http://maps-{s}.onemap.sg/v2/Default/{z}/{x}/{y}.png`, {
        detectRetina: true,
        maxZoom: 18,
        minZoom: 12,
    });

    map.setMaxBounds([[1.56073, 104.1147], [1.16, 103.502]]);

    basemap.addTo(map);

    var updatePosition = false;
    var repeatedBuildings = {};

    function openMapView() {
        // Make toggle cards
        var activeSection;
        var index;
        var allSections = document.getElementsByClassName("planSection");
        for (var i=0; i<allSections.length; i++) {
            if (allSections[i].style.display == "block") {
                activeSection = allSections[i];
                index = i;
                break;
            }
        }

        var planCards = activeSection.getElementsByClassName("plan-selection");
        var mapDiv = document.getElementById("map-selection");
        mapDiv.innerHTML = "";
        for (var i=1; i<planCards.length; i++) {
            mapDiv.innerHTML += 
            `<div class="trip-place" style="border: 1px solid grey ;width: 250px; margin: 5px;" onclick="showRoute(${index}, '${planCards[i-1].querySelector(".plan-latlng").innerText}', '${planCards[i].querySelector(".plan-latlng").innerText}')">
                <h5>${planCards[i].querySelector(".plan-name").innerText}</h5>
                <p>${planCards[i].querySelector(".plan-address").innerText}</p>
            </div>`;
        }

        // Default show 1st part trip
        var firstCard = document.querySelector(".trip-place")
        if (typeof firstCard.onclick == "function")
            firstCard.onclick.apply(firstCard);

        // Pull plan page down
        $("#planPage").animate({
            bottom: "-200vh"
        }, 350, function () {
            $("#planPage").hide()
        });
    }

    function dismissMapView() {
        // Pull plan page up
        $("#planPage").show();
        $("#planPage").animate({
            bottom: "0"
        }, 350);
    }

    function showYourPosition(position) {  
        updatePosition = true;  
        // Mark marker
        if (yourMarker) {
            map.removeLayer(yourMarker);
        }
        
        yourMarker = new L.Marker([position.coords.latitude, position.coords.longitude], {bounceOnAdd: false, customId: "YouMarker"}).addTo(map); 

        latLngStr = position.coords.latitude + "," + position.coords.longitude;
        document.getElementById("start-latlng").innerText = latLngStr;

        var post = document.getElementById("start-latlng").innerText.split(",");
    }

    function positioningError(error) {

    }

    function showRoute(index, position1, position2) {
        // Routing display
        var today = new Date();
        var routeType = document.getElementsByClassName("tm-selection")[index].querySelector("span").innerText;
        if (routeType == "Public Transport") {
            routeType = "pt";
        }

        var position1 = position1.split(",");
        var position2 = position2.split(",");

        function decodeGeo(encodedRoute) {
            if (encodedRoute !== undefined || encodedRoute !== '' || encodedRoute != null ) {
                var routeGeo = L.Polyline.fromEncoded(encodedRoute, {
                    precision: 6
                });

                return routeGeo;
            }
        }

        $.ajax({
            url: `https://developers.onemap.sg/privateapi/routingsvc/route?start=${position1[0]},${position1[1]}&end=${position2[0]},${position2[1]}&routeType=${routeType}&token=${apiKey}&date=${String(today.getFullYear())}-${String(today.getMonth()+1)}-${String(today.getDate())}&time=${String(today.getHours())}:${String(today.getMinutes())}:${String(today.getSeconds())}&mode=TRANSIT`,
            success: function(result) {
                //Set result to a variable for writing
                var encodedRoute;
                var modes = [];

                // Remove previous markings and route paths
                if (startMarker) {
                    map.removeLayer(startMarker);
                }
                if (endMarker) {
                    map.removeLayer(endMarker);
                }
                pathPieces = [].slice.call(document.getElementsByTagName("path")).map(x => x.parentElement);
                for (var i=0; i<pathPieces.length; i++) {
                    pathPieces[i].remove();
                }

                startMarker = new L.Marker([position1[0], position1[1]], {bounceOnAdd: true}).addTo(map);
                endMarker = new L.Marker([position2[0], position2[1]], {bounceOnAdd: true}).addTo(map);
                 
                if (routeType == "pt") {
                    var allRoutes = result.plan.itineraries;
                    for (var i in allRoutes) {
                        var transportMeans = allRoutes[i].legs;
                        for (var j in transportMeans) {
                            var details = transportMeans[j];
                            var mode = details.mode;

                            encodedRoute = details.legGeometry.points
                            var routeGeo = decodeGeo(encodedRoute);
                            modes = {endpoints: routeGeo._latlngs, mode: mode};

                            if (mode == "SUBWAY") {
                                var subwayLine = details.route;
                                L.polyline(modes.endpoints, routeTextures.SUBWAY[subwayLine]).addTo(map);
                            }
                            else {
                                L.polyline(modes.endpoints, routeTextures[modes.mode]).addTo(map);
                            }
                        }

                        // Remove for the next time, only take 1st route
                        break
                    }
                }
                else {
                    encodedRoute = result.route_geometry;
                    var routeGeo = decodeGeo(encodedRoute);
                    modes = {endpoints: routeGeo._latlngs, mode: routeType.toUpperCase()};

                    L.polyline(modes.endpoints, routeTextures[modes.mode]).addTo(map);
                }
            }
        });
    }

    window.addEventListener('load', function () {
        /*document.addEventListener('click', function (event) {
            const allTabs = document.getElementsById;
            const endInp = document.getElementById("end-location");
            const startInp = document.getElementById("start-location");

            if (![].slice.call(allTabs).find(x => x === event.target) && event.target != endInp && event.target != startInp) {
                if (!dropdownCooldown) {
                    for (var i in allTabs) {
                        allTabs.item(i).style.display = "none";
                    }
                }
            }
        });*/

        initFunctions();
    });

</script>
{% endblock %}
