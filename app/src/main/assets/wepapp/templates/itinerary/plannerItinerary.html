{% extends "base.html" %}
{% block title %}Redpins Buffer - Planner{% endblock %}

{% block content %}
<div class="device" id="reloadingbg" style="display: none;">
    <img src="/static/images/logo.gif" alt="logo" class="relogogif">
    <p>Hang tight while we find the best places for you...</p>
</div>

<div class="main-div">
    {% if itinerary != None %}
    <div class="device" id="firstSelection" style="position: absolute; z-index:2; background-color: white; display: none;">
    {% else %}
    <div class="device" id="firstSelection" style="position: absolute; z-index:2; background-color: white;">
    {% endif %}
        {% if itinerary != None %}
        <div id="itinerary-id" hidden>{{itinerary.getId()}}</div>
        <div>
            <label>Start Time</label>
            <input id="start-time" type="time" class="form-control" value="{{itinerary.getStartTime()}}" onkeyup="checkFirstPage();" required>
        </div>
        <div>
            <label>End Time</label>
            <input id="end-time" type="time" class="form-control" value="{{itinerary.getEndTime()}}" onkeyup="checkFirstPage();" required>
        </div>
        {% else %}
            <div id="itinerary-id" hidden></div>
            <div>
                <label>Start Time</label>
                <input id="start-time" type="time" class="form-control" onkeyup="checkFirstPage();" required>
            </div>
            <div>
                <label>End Time</label>
                <input id="end-time" type="time" class="form-control" onkeyup="checkFirstPage();" required>
            </div>
        {% endif %}
        <div>
            <h5>Select mode of transport</h5>
            <div style="display: inline;" onclick="checkFirstPage();">
                <label for="trans-walk">Walk</label>
                {% if itinerary != None %}
                    {% if itinerary.getTransportMode() == "walk" %} <input type="radio" name="transportMode" id="trans-walk" value="walk" checked>
                    {% else %} <input type="radio" name="transportMode" id="trans-walk" value="walk"> {% endif %}
                    <label for="trans-publicTransport">Public Transport</label>
                    {% if itinerary.getTransportMode() == "pt" %} <input type="radio" name="transportMode" id="trans-publicTransport" value="pt" checked>
                    {% else %} <input type="radio" name="transportMode" id="trans-publicTransport" value="pt">{% endif %}
                    <label for="trans-drive">Drive</label>
                    {% if itinerary.getTransportMode() == "drive" %} <input type="radio" name="transportMode" id="trans-drive" value="drive" checked>
                    {% else %} <input type="radio" name="transportMode" id="trans-drive" value="drive">{% endif %}
                    <label for="trans-cycle">Cycle</label>
                    {% if itinerary.getTransportMode() == "cycle" %} <input type="radio" name="transportMode" id="trans-cycle" value="cycle" checked>
                    {% else %} <input type="radio" name="transportMode" id="trans-cycle" value="cycle">{% endif %}
                {% else %}
                <input type="radio" name="transportMode" id="trans-walk" value="walk">
                <label for="trans-publicTransport">Public Transport</label>
                <input type="radio" name="transportMode" id="trans-publicTransport" value="pt">
                <label for="trans-drive">Drive</label>
                <input type="radio" name="transportMode" id="trans-drive" value="drive">
                <label for="trans-cycle">Cycle</label>
                <input type="radio" name="transportMode" id="trans-cycle" value="cycle">
                {% endif %}
            </div>
        </div>

        <button class="next" id="firstPageNext" onclick="dismissFirst();" disabled>Next</button>
    </div>

    {% if itinerary != None %}
    <div class="device" id="planPage">
    {% else %}
    <div class="device" id="planPage" style="display: none;">
    {% endif %}
        <div class="float-right">
            <a href="/itinerary/showTrip">Map</a>
        </div>
    
        {% if itinerary != None %}
        <div id="startTime-text">Start time: {{itinerary.getStartTime()}}</div>
        <div id="endTime-text">End time: {{itinerary.getEndTime()}}</div>
        <div id="time-left">Duration left: <span>{{itinerary.getTimeLeft()}}</span></div>
    
        <div id="transport-text">Transport mode: {{itinerary.getTransportMode()}}</div>
        <div>Category: Eateries</div>
        {% else %}
        <div id="startTime-text">Start time: </div>
        <div id="endTime-text">End time: </div>
        <div id="time-left">Duration left: <span></span></div>
    
        <div id="transport-text">Transport mode: </div>
        <div>Category: Eateries</div>
        {% endif %}

        <div id="start">Start location: </div>
    
        <div id="recommendation-listings">
            {% if itinerary != None %}
            <button class="btn-addColor" onclick="recommend(1, 1);">  +  </button>
                {% for i in range(itinerary.getPlaces()| length) %}
                <div class="card plan-selection">
                    <h5 class="plan-name">{{itinerary.getPlaces()[i]["Name"]}}</h5>
                    <p class="plan-address" style="font-size:12px">{{itinerary.getPlaces()[i]["Address"]}}</p>
                    <br />
                    <p class="plan-activity-duration"><span>{{itinerary.getPlaces()[i].ActivityDuration}}</span> min</p>
                    <p class="plan-total-duration"><span>{{itinerary.getPlaces()[i]["TotalDuration"]|int}}</span> min</p>
                </div>
                <button class="btn-addColor" onclick="recommend(1, parseInt('{{i+2}}'));">  +  </button>
                {% endfor %}
            {% else %}
            <button style="background: linear-gradient(193.74deg, #E4002B 3.02%, #E82038 31.9%, #F8A36F 95.45%); color: white;" onclick="removeFirstBtn(this);recommend(1, 1);">+ Add place</button>
            {% endif %}
        </div>
        <button class="btn btn-primary" id="next-recommend-btn" onclick="nextRecommend();">Next</button>
        <br>
        <label>End destination</label>
        <input type="text" id="endDestination" class="form-control" onkeyup="pauseSearch();"></input>
        <div id="show-destinations">   
        </div>
    
        <form method="POST">
            <input type="submit" value="Create Trip" class="btn btn-primary">
        </form>
    </div>
    
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
    var post;
    var skipped = [0];
    var allowanceLeft = parseInt(document.getElementById("time-left").querySelector("span").innerText) || 0;
    var pendingChooseList = {};

    /*function initFunctions() {
        $("#recommend-btn").on("click", function() {
            recommend(1);
        })
        $("#next-recommend-btn").on("click", function() {
            recommend(pageNum);
            pageNum += 1;
        })
    }*/

    function checkFirstPage() {
        var firstSelection = document.getElementById("firstSelection");
        var allInps = firstSelection.getElementsByTagName("input");
        var radioChecked = firstSelection.querySelector('input[type="radio"]:checked');

        var nextBtn = document.getElementById("firstPageNext");
        if (allInps[0].value != "" && allInps[1].value != "" && radioChecked) {
            nextBtn.style.background = "linear-gradient(193.74deg, #E4002B 3.02%, #E82038 31.9%, #F8A36F 95.45%)";
            nextBtn.style.color = "white";
            nextBtn.disabled = false;
        }
        else {
            nextBtn.style.background = "#EEEEEE";
            nextBtn.style.color = "#BBBBBB";
            nextBtn.disabled = true;
        }
    }

    function dismissFirst() {
        startTme = $("#start-time").val();
        endTme = $("#end-time").val();
        if (startTme == "") {
            $("#start-time").focus()
        }
        else if (endTme == "") {
            $("#end-time").focus()
        }
        else if ($("input[type=radio]:checked").length == 0) {
            console.log("Check checkboxes");
        }
        else {
            document.getElementById("startTime-text").innerText += startTme;
            document.getElementById("endTime-text").innerText += endTme;
            document.getElementById("transport-text").innerText += document.querySelector(`label[for="${document.querySelector('input[name="transportMode"]:checked').id}"]`).innerText;
            startTmeArr = startTme.split(":");
            endTmeArr = endTme.split(":");
            var startDate = new Date(0, 0, 0, startTmeArr[0], startTmeArr[1], 0);
            var endDate = new Date(0, 0, 0, endTmeArr[0], endTmeArr[1], 0);
            var diff = endDate.getTime() - startDate.getTime();
            allowanceLeft = Math.floor(diff / 1000 / 60);
            document.getElementById("time-left").querySelector("span").innerText = allowanceLeft;

            $("#firstSelection").animate({
                bottom: "-200vh"
            }, 350, function() {
                $("#firstSelection").hide();
            })
            $("#planPage").show();
        }
    }

    function removeFirstBtn(btn) {
        btn.classList.add("btn-add-place")
        btn.innerText = " +  ";
    }

    function nextRecommend() {
        recommend(pageNum);
        pageNum += 1;
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showRoute)
        }
    }

    function showRoute(position) {
        document.getElementById("start").innerText += position.coords.latitude + "," + position.coords.longitude
        post = position
    }

    // Order - the positional order of the button in DOM
    function recommend(pageNum, order) {
        startTme = $("#start-time").val();
        endTme = $("#end-time").val();
        transportMde = document.querySelector('input[name="transportMode"]:checked').value;

        div = document.getElementById("recommendation-listings");

        $("#reloadingbg").show();

        $.ajax({
            type: "POST",
            url: `/funcs/planner-recommend-places?page=${pageNum}`,
            data: {
                startTime: startTme,
                endTime: endTme,
                timeLeft: allowanceLeft,
                latitude: post.coords.latitude,
                longitude: post.coords.longitude,
                category: "Eateries",
                transportMode: transportMde,
                skipped: JSON.stringify(skipped)
            },
            success: function(result) {
                cleanedResult = result.replaceAll("\\u", "").replaceAll("NaN", `""`);
                result = JSON.parse(cleanedResult);
                pendingChooseList[order] = result;
                pendingChooseList[order].pageNum = 2;

                var listing = new DOMParser().parseFromString(
                    `<div class="plan-choices-list">
                    </div>`, "text/xml").documentElement;
                var beforeDiv = div.getElementsByClassName("plan-selection")[order-2];
                console.log(order);
                if (order-2 == -1) {
                    div.insertBefore(listing, div.children[1]);
                }
                else if (beforeDiv && beforeDiv.nextSibling) {
                    div.insertBefore(listing, beforeDiv.nextSibling);
                }
                else {
                    div.appendChild(listing);
                }

                for (var i in result.list) {
                    listing.innerHTML += 
                    `<div class="card plan-selection" style="width:150px; height:175px; margin-right: 1em; max-width:
                        flex-basis: 33.333%;
                        flex-grow: 0;
                        flex-shrink: 0;" onclick="choosePlace(this, ${order}, ${i});">
                        <h5>${result.list[i].Name}</h5>
                        <p style="font-size:12px">${result.list[i].Address}</p>
                        <br />
                        <p>Matching ${result.list[i].RecommendationScore.toFixed(2)}</p>
                    </div>`;

                }

                listing.innerHTML += `<p onclick="nextRecommend()" class="list-load-more">Load more</p>`;
                reAssignValues();
            },
            complete: function(result) {
                $("#reloadingbg").hide();
            }
        })
       
    }

    function choosePlace(btn, order, itemNo) {
        btn.parentElement.remove()
        div = document.getElementById("recommendation-listings");
        var info = pendingChooseList[order].list[itemNo];

        var newPlace = new DOMParser().parseFromString(`
            <div class="card plan-selection">
                <h5 class="plan-name">${info.Name}</h5>
                <p class="plan-address" style="font-size:12px">${info.Address}</p>
                <br />
                <p class="plan-activity-duration"><span>${Math.round(info.ActivityDuration)}</span> min</p>
                <p class="plan-total-duration"><span>${Math.round(info.Duration)}</span> min</p>
            </div>
            <button class="btn-addColor" onclick="recommend(1, ${order+1});">  +  </button>`).documentElement;

        var beforeDiv = div.getElementsByClassName("plan-selection")[order-2];
        
        if (order-2 == -1) {
            div.insertBefore(listing, div.children[1]);
        }
        else if (beforeDiv && beforeDiv.nextSibling) {
            div.insertBefore(newPlace, beforeDiv.nextSibling);
        }
        else {
            div.appendChild(newPlace);
        }
        
        allowanceLeft -= info.Duration;
        document.getElementById("time-left").querySelector("span").innerText = parseInt(allowanceLeft);
        
        // Fill up info for autosaving data

        saveTrips();
    }

    function reAssignValues() {
        var div = document.getElementsByClassName("btn-add-place");
        for (var i=0; i<div.length; i++) {
            div[i].setAttribute("onclick", `recommend(1, ${i+1});`);
        }
    }

    function saveTrips() {
        startTme = $("#start-time").val();
        endTme = $("#end-time").val();

        // Update db function
        itineraryId = document.getElementById("itinerary-id").innerText;
        var allPlacesDiv = document.getElementsByClassName("plan-selection");
        var placesName = [];
        var placesAddress = [];
        var placesActivityDuration = [];
        var placesDuration = [];

        for (var i=0; i<allPlacesDiv.length; i++) {
            placesName.push(allPlacesDiv[i].querySelector(".plan-name").innerText);
            placesAddress.push(allPlacesDiv[i].querySelector(".plan-address").innerText);
            parseInt(placesActivityDuration.push(allPlacesDiv[i].querySelector(".plan-activity-duration").querySelector("span").innerText));
            parseInt(placesDuration.push(allPlacesDiv[i].querySelector(".plan-total-duration").querySelector("span").innerText));
        }

        $.ajax({
            type: "POST",
            url: `/funcs/save-trip`,
            data: {
                id: itineraryId,
                tripType: "Planner",
                tripName: "Hello",
                date: "Today",
                startTime: startTme,
                endTime: endTme,
                names: placesName,
                addresses: placesAddress,
                activityDuration: placesActivityDuration,
                duration: placesDuration,
                timeAllowance: 360,
                timeLeft: 360,
                transportMode: "pt",
                confirmed: false,
                status: "Planned"
            },
            success: function(result) {
                console.log("System: Trip has been autosaved");
                document.getElementById("itinerary-id").innerText = result.id;
            }
        })
    }

    var canSearch = true;

    function pauseSearch() {
        canSearch = false;
        console.log("Here");
        setTimeout(function() {
            canSearch = true;
            search()
        }, 1000)
    }

    function search() {
        if (canSearch) {
            var dropdownMenu = document.getElementById("show-destinations");
            const search = $("#endDestination").val()
            const pageNum = $("#searchPage").val()
            if (!search) {
                dropdownMenu.innerHTML = ""; 
            }
            else {
                $.ajax({
                    url: `https://developers.onemap.sg/commonapi/search?searchVal=${search}&returnGeom=Y&getAddrDetails=Y&pageNum=${pageNum}`,
                    success: function(result) {
                        dropdownMenu.innerHTML = "";
                        showLength = 6;
                        if (result.results.length > 0) {
                            if (result.results.length < 6) {
                                showLength = result.results.length;
                            }

                            for (var i=0; i<showLength; i++) {
                                record = result.results[i]
                                dropdownMenu.innerHTML += `
                                <div class="dropdown-item" onclick="">
                                    <p style="font-size: 14px;"><b>${record.SEARCHVAL}</b></p>
                                    <p style="font-size: 11px; max-width: 100%; overflow: auto;">${record.ADDRESS}</p>
                                </div>`;
                            }
                        }
                        else {
                            dropdownMenu.innerHTML = `<div class="dropdown-item">No results found</div>`; 
                        }
                }});
            }
            
        }       
    } 

    function searchNextPage() {
        $("#searchPage").text(parseInt($("#searchPage").text()) + 1)
    }

    // initFunctions();
    getLocation();

</script>
{% endblock %}