{% extends "base.html" %}
{% block title %}Redpins Buffer - Planner{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
<script src="https://cdn.onemap.sg/leaflet/onemap-leaflet.js"></script>
<script type="text/javascript" src="https://rawgit.com/jieter/Leaflet.encoded/master/Polyline.encoded.js"></script>


<div class="device" id="reloadingbg" style="display: none;">
    <img src="/static/images/logo.gif" alt="logo" class="relogogif">
    <p>Hang tight while we find the best places for you...</p>
</div>

<div class="main-div">
    {% if itineraries != None %}
    <div id="initForm" style="position: absolute; z-index:2; background-color: white; display: none; bottom: -200vh;">
    {% else %}
    <div id="initForm" style="position: absolute; z-index:2; background-color: white;">
    {% endif %}
        <p id="start-latlng" hidden></p>
        <label for="">Where to?</label>
        <input type="text" id="city" value="Local">
        <label for="startDate">Start Date</label>
        <input type="date" id="startDate" value="{% if itineraries != None %}{{itineraries[0].getDate().strftime('%Y-%m-%d')}}{% endif %}" onchange="checkResetEndDate(); checkInitPage();">
        <label for="endDate">End Date</label>
        <input type="date" id="endDate" value="{% if itineraries != None %}{{itineraries[-1].getDate().strftime('%Y-%m-%d')}}{% endif %}" onchange="checkInitPage();">

        <button class="maincta-disabled" id="initPageNext">Next</button>
    </div>

    <div id="dates-selection" style="display: inline; overflow-x: auto;">
        {% if itineraries != None %}{% for itinerary in itineraries %}
        <div class="card card-date" style="width: 150px;" onclick="toggleDay(this);">
            <h5>{{itinerary.getDate().strftime("%Y-%m-%d")}}</h5>
            <p class="tm-selection">{% if itinerary.getTransportMode() == "pt" %}Public Transport{% else %}{{itinerary.getTransportMode()}}{% endif %}<span hidden>{{itinerary.getTransportMode()}}</span></p>
            <ul class="tm" style="display: block;">
                <li onclick="chooseTransportMode(this);">Drive<span hidden>drive</span></li>
                <li onclick="chooseTransportMode(this);">Public Transport<span hidden>pt</span></li>
                <li onclick="chooseTransportMode(this);">Bus<span hidden>bus</span></li>
                <li onclick="chooseTransportMode(this);">Walk<span hidden>walk</span></li>
                <li onclick="chooseTransportMode(this);">Cycle<span hidden>cycle</span></li>
            </ul>
        </div>
        {% endfor %}{% endif %}
        <div class="card" id="card-date-add" onclick="openInitPage();" style="width: 100px;">
            <h5>+ Add day</h5>
        </div>
    </div>
    
    {% if itineraries == None %}
    <div id="planPage" style="display: none; position: absolute;">
    {% else %}
    <div id="planPage" style="display: block; position: absolute;">
    {% endif %}
        {% if itineraries != None %}
            {% for i in range(itineraries|length) %}
            {% set itinerary = itineraries[i] %}
            <div class="device planSection" style="display: none;">
                <div class="float-right">
                    <p onclick="openMapView();">Map</p>
                </div>
                
                <div class="time-left">Duration left: <span>{{itinerary.getTimeLeft()| int}}</span></div>
                <div class="transport-text">Transport mode: {% if itinerary.getTransportMode() == "pt" %}Public Transport{% else %}{{itinerary.getTransportMode()}}{% endif %}</div>
            
                <div class="recommendation-listings">
                    {% if itinerary.getPlaces()| length == 0 %}
                    <button class="btn-addColor start-location" onclick="openSearch(this, '{{i+1}}');">+ Add start Location</button>
                    {% elif itinerary.getPlaces()| length == 1 %}
                    <div class="card plan-selection start">
                        <h5 class="plan-name">{{itinerary.getPlaces()[0].Name}}</h5>
                        <p class="plan-address" style="font-size:12px">{{itinerary.getPlaces()[0].Address}}</p>
                        <br />
                        <p class="plan-timing"></p>
                        <p class="plan-latlng" hidden>{{itinerary.getPlaces()[0].Latlng}}</p>
                    </div>
                    <button class="btn-addColor" onclick="removeFirstBtn(this); openRecommendTab(1, this);">+ Add a place</button>
                        {% if not itinerary.getEnd() %}
                        <button class="btn-addColor end-location" onclick="openSearch(this, '{{i+1}}');">+ Add end Location</button>
                        {% endif %}
                    {% else %}
                        {% for i in range(itinerary.getPlaces()| length) %}
                            <div class="card plan-selection {% if i == itinerary.getPlaces()| length - 1 and itinerary.getEnd() %}end{% endif %}">
                                <h5 class="plan-name">{{itinerary.getPlaces()[i].Name}}</h5>
                                <p class="plan-address" style="font-size:12px">{{itinerary.getPlaces()[i].Address}}</p>
                                <br />
                                <p class="plan-timing"></p>
                                <p class="plan-activity-duration">{% if itinerary.getPlaces()[i].ActivityDuration %}<span>{{itinerary.getPlaces()[i].ActivityDuration}}</span> min{% else %}<span></span>{% endif %}</p>
                                <p class="plan-total-duration">{% if itinerary.getPlaces()[i].TotalDuration %}<span>{{itinerary.getPlaces()[i].TotalDuration|int}}</span> min{% else %}<span></span>{% endif %}</p>
                                <p class="plan-latlng" hidden>{{itinerary.getPlaces()[i].Latlng}}</p>
                                {% if i != itinerary.getPlaces()| length - 1 and i != 0 %}
                                <p class="plan-edit" onclick="editCard(this, parseInt('{{i+1}}'))">Edit</p>
                                <p class="plan-delete" onclick="delCard(this, parseInt('{{i+1}}'))">Delete</p>
                                {% endif %}
                            </div>
                            {% if i != itinerary.getPlaces()| length - 1 %}
                            <button class="btn-addPlan btn-addColor" onclick="openRecommendTab(parseInt('{{i+1}}'), this);">  +  </button>
                            {% elif not itinerary.getEnd() %}
                            <button class="btn-addPlan btn-addColor" onclick="recommend(1, parseInt('{{i+1}}'), this);">  +  </button>
                            {% endif %}
                        {% endfor %}
                        {% if not itinerary.getEnd() %}
                        <button class="btn-addColor end-location" onclick="openSearch(this, '{{i+1}}');">+ Add end Location</button>
                        {% endif %}
                    {% endif %}
                </div>
                <button class="btn btn-primary" id="next-recommend-btn" onclick="nextRecommend();">Next</button>
            </div>
            {% endfor %}
        {% endif %}
    </div>

    <!-- Search Page -->
    <div class="device" id="searchTab" style="position: absolute; z-index:2; background-color: white; display: none; bottom: -200vh;">
        <input type="text" class="form-control" id="searchBar" onkeyup="pauseSearch();" autocomplete="off">
        <div id="searchPage" hidden>1</div>
        <div id="search-btnId" hidden></div>
        <div id="search-divOrder" hidden></div>
        <div class="dropdown-item" id="start" onclick="addSE(this);">
            <p style="font-size: 14px; margin-bottom: 3px; font-weight: bold;">Your Location</p>
            <p style="font-size: 11px; max-width: 100%; overflow: auto; margin-bottom: 3px; display: none;">Current Location</p>
            <p id="start-latlng" hidden></p>
        </div>
        <div id="search-results">
        </div>
    </div>
    
    <!-- Recommendation tab -->
    <div class="device" id="recommendationTab" style="position: absolute; z-index:2; background-color: white; display: none; bottom: -200vh;">
        <div id="sectionIndex" hidden></div>
        <!-- header -->
        <div class="explorerheader">
            <svg width="12" height="20" onclick="closeRecommendTab();">
            <path
                d="M10.2642 0C10.8582 0.203504 11.2215 0.68581 11.6052 1.12894C11.9081 1.47897 11.8687 2.05183 11.5761 2.4156C11.5052 2.50072 11.4295 2.58174 11.3494 2.65828C8.94914 5.0464 6.54751 7.43334 4.14452 9.81909C4.0819 9.87251 4.01519 9.92099 3.94498 9.96409C4.03554 10.0582 4.08722 10.1167 4.14145 10.1676C6.56048 12.5737 8.9795 14.9796 11.3985 17.3854C11.8298 17.8148 11.9613 18.3439 11.6385 18.7738C11.3346 19.1709 10.9778 19.5251 10.5779 19.8264C10.2074 20.1093 9.70807 20.0259 9.34174 19.7247C9.28648 19.6794 9.23276 19.6311 9.18211 19.5807L0.412125 10.8636C-0.0248138 10.4296 -0.119978 9.92084 0.153748 9.45024C0.222198 9.33957 0.304744 9.23817 0.399334 9.14854C3.33272 6.23165 6.26697 3.31661 9.20206 0.403448C9.37602 0.231995 9.61905 0.132787 9.8324 0H10.2642Z"
                fill="#2B2B2B" />
            </svg>
            <h1>Edit Plan</h1>
            <svg onclick="document.getElementById('recommendSearch').style.display = 'block';" width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
                d="M0.773438 8.20312V9.29688C0.829688 9.68802 0.867708 10.0828 0.944792 10.4703C1.69479 14.225 4.80156 17.0578 8.6276 17.45C10.6422 17.6568 12.5146 17.2036 14.2292 16.1182C14.3974 16.0115 14.5609 15.8979 14.7516 15.7708C14.8031 15.8349 14.8427 15.8958 14.8938 15.9458C16.0599 17.0984 17.2307 18.2464 18.3917 19.4042C18.6635 19.675 18.9448 19.913 19.3281 20H19.7188C19.8984 19.9188 20.0901 19.8562 20.2547 19.7521C20.5469 19.5672 20.6839 19.2682 20.7734 18.9453V18.5156C20.6651 18.1245 20.3984 17.8469 20.1198 17.5703C18.974 16.4339 17.8354 15.2896 16.6943 14.1484C16.6406 14.0948 16.5896 14.0385 16.5438 13.9901C16.5568 13.9573 16.5599 13.9443 16.5667 13.9339C16.5995 13.8854 16.6339 13.838 16.6677 13.7901C17.9063 12.0109 18.4297 10.0365 18.2224 7.88333C18.0396 5.98698 17.3 4.31823 16.0214 2.90365C14.6906 1.43229 13.0453 0.507812 11.0891 0.152083C10.7391 0.0885417 10.3839 0.05 10.0312 0C9.69271 0 9.35417 0 9.01562 0C8.96563 0.0109375 8.91563 0.0291667 8.8651 0.0322917C7.66771 0.114063 6.53125 0.426042 5.4776 0.997396C3.00156 2.34062 1.47344 4.39531 0.924479 7.16458C0.85677 7.50729 0.822917 7.85729 0.773438 8.20312ZM3.27344 8.75052C3.27344 5.30208 6.0724 2.50104 9.51979 2.50156C12.9656 2.50156 15.7698 5.30469 15.7698 8.74948C15.7698 12.1937 12.9646 14.999 9.52083 14.9984C6.0724 14.9979 3.27396 12.1995 3.27344 8.75052Z"
                fill="#2B2B2B" />
            </svg>
        </div>

        <section id="recommendPage" class="homecontent">
            <div class="categories">
                <div id="selectedCat" hidden>Eateries</div>
                <ul id="categories">
                    {% for cat in catInfo %}
                    <li>
                        <div class="categoriesbutton">
                            <svg>
                            </svg>
                        </div>
                        <p>{{cat}}</p>
                    </li>
                    {% endfor %}
                    {% for i in range(8 - catInfo|length) %}
                    <li>
                        <div class="categoriesbutton">
                            <svg>
                            </svg>
                        </div>
                        <p>Lorem</p>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            
            <div id="recommendcon">
                <div class="sectionheader manyheadertags">
                    <div>
                        <h1>Recommended For You</h1>
                        <h2>Specially tailored for you!</h2>
                    </div>
            
                    <div class="view">
                        <h3>View All</h3>
                    </div>
                </div>
        
                <div id="recommend-main" class="plan-choices-list maincardcon attractionscon">
                </div>
            
                <!-- Places Near You -->
                <div class="sectionheader manyheadertags">
                    <div>
                        <h1>Places Near You</h1>
                        <h2>We thought you might like...</h2>
                    </div>
            
                    <div class="view">
                        <h3>View All</h3>
                    </div>
                </div>
        
                <div id="recommend-ratings" class="plan-choices-list maincardcon attractionscon">
                </div>
        
                <!-- Recommended By Us -->
                <div class="sectionheader manyheadertags">
                    <div>
                        <h1>Recommended By Us</h1>
                        <h2>We thought you might like...</h2>
                    </div>
            
                    <div class="view">
                        <h3>View All</h3>
                    </div>
                </div>
        
                <div id="recommend-partners" class="plan-choices-list maincardcon attractionscon">
                </div>
            </div>
        </section>

        <section id="recommendSearch" class="device" style="position:absolute; z-index: 4; display: none;">
            <div id="search">
                <div class="searchheader">
                  <svg onclick="document.getElementById('recommendSearch').style.display = 'none';" width="12" height="20" viewBox="0 0 12 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M10.2642 0C10.8582 0.203504 11.2215 0.68581 11.6052 1.12894C11.9081 1.47897 11.8687 2.05183 11.5761 2.4156C11.5052 2.50072 11.4295 2.58174 11.3494 2.65828C8.94914 5.0464 6.54751 7.43334 4.14452 9.81909C4.0819 9.87251 4.01519 9.92099 3.94498 9.96409C4.03554 10.0582 4.08722 10.1167 4.14145 10.1676C6.56048 12.5737 8.9795 14.9796 11.3985 17.3854C11.8298 17.8148 11.9613 18.3439 11.6385 18.7738C11.3346 19.1709 10.9778 19.5251 10.5779 19.8264C10.2074 20.1093 9.70807 20.0259 9.34174 19.7247C9.28648 19.6794 9.23276 19.6311 9.18211 19.5807L0.412125 10.8636C-0.0248138 10.4296 -0.119978 9.92084 0.153748 9.45024C0.222198 9.33957 0.304744 9.23817 0.399334 9.14854C3.33272 6.23165 6.26697 3.31661 9.20206 0.403448C9.37602 0.231995 9.61905 0.132787 9.8324 0H10.2642Z"
                      fill="#2B2B2B" />
                  </svg>
            
                  <h1>Search</h1>
            
            
                  <svg onclick="window.open('saved.html','_self')" width="15" height="20" viewBox="0 0 15 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M12.8569 0H2.14312C1.57629 0.00205569 1.03339 0.237205 0.633538 0.653854C0.233688 1.0705 0.00954761 1.63462 0.0102946 2.22244L0 20L7.5 16.6663L15 20V2.22244C14.9975 1.6338 14.771 1.06999 14.3696 0.653759C13.9682 0.237523 13.4245 0.00255379 12.8569 0V0Z"
                      fill="#2B2B2B" />
                  </svg>
                </div>
            
                <input type="text" id="recSearchBar" class="Username" value="" onkeyup="recSearch();" placeholder="Search Activities, Restaurants, Cafes" autocomplete="off">
            
                <div id="recSearch-results" class="searchcardscon">
                    <div style="position: relative; right: 5px;" class="sectionheader recentheader">
                        <h1>Recent Searches</h1>
                        <h3>Clear</h3>
                    </div>
                    <div id="recSearch-results-recent">
                        {% for i in range(recentSearches|length) %}
                        <div class="recentcards searchcard">
                            <div class="cardimg" style="background-image: url('{{recentInfo[i].Image_url}}');">
                            </div>
                    
                            <div class="cardinfo">
                                <h1 class="recentname">{{recentSearches[i].getPlaceName()}}</h1>
                                <div class="recenttype">
                                    <h3 class="recentcat">{{recentSearches[i].getCategory()}}</h3>
                                    <div class="rating">
                                        {% for rating in range(recentInfo[i]["Rating"]|round) %}
                                        <svg width="12" height="12" fill="none">
                                            <rect x="0.5" y="0.5" width="11" height="11" rx="1.5" stroke="#E4002B" />
                                        </svg>
                                        {% endfor %}
                                        {% for rating in range(5 - recentInfo[i]["Rating"]|round) %}
                                        <svg width="12" height="12" fill="none">
                                            <rect x="0.5" y="0.5" width="11" height="11" rx="1.5" stroke="#C4C4C4" />
                                        </svg>
                                        {% endfor %}
                                        <p class="ratingvalue">{{recentInfo[i]["Review_no"]}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div style="position: relative; right: 5px;" class="sectionheader resultsheader" style="display: none;">
                        <h1>Results</h1>
                    </div>
                    <div id="recSearch-results-results" style="display: none;">

                    </div>
                </div>
            
            </div>
        </section>
    </div>

    <!-- Map View -->
    <div class="device" id="mapView" style="position: fixed; z-index:-2;">
        <div id='mapdiv' style='height:80vh;'></div>
        <div id="map-selection" style="height:20vh; z-index:-1; overflow-x: auto;">
            <button class="btn-addColor" onclick="dismissMapView();">x</button>
            <div id="map-sections" style="display: inline; overflow-x: auto; overflow-y: auto;">

            </div>
        </div>
    </div>

    <!-- Popup -->
    <div id="changesPopup" style="display: none; position: absolute; top: 50%;">
        <p id="changes-text">You've changed the starting date of your itinerary. What action do you wish to perform ?</p>
        <p class="text-primary" onclick="dateChangesAction(1)">Leave itinerary in their respective pages</p>
        <p class="text-danger" onclick="dateChangesAction(2)">Reset itinerary</p>
    </div>

    <form method="POST">
        <input id="planner-id" name="plannerId" value="{% if itineraries != None %}{{itineraries[0].getPlannerId()}}{% endif %}" hidden readonly>
        <input type="submit" value="Review Trip" class="btn btn-primary">
    </form>
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
    var skipped = [0];
    var pendingChooseList = {};
    var startTime = new Date("2022-01-01T08:00:00");
    var originalDuration;
    const currentTime = new Date();

    var requests = [];

    function initFunctions() {
        getLocation();
        const todayDate = currentTime.toISOString().split("T")[0]
        document.getElementById("startDate").min = todayDate;
        document.getElementById("startDate").value = todayDate;

        document.getElementById("endDate").min = todayDate;

        toggleDay(0);
        initAllowance();
        reAssignValues();
    }
    function initAllowance() {
        // Set time allowance
        var startTmeArr = ["08", "00"];
        var endTmeArr = ["23", "59"];
        var startDate = new Date(0, 0, 0, startTmeArr[0], startTmeArr[1], 0);
        var endDate = new Date(0, 0, 0, endTmeArr[0], endTmeArr[1], 0);
        var diff = endDate.getTime() - startDate.getTime();
        var allowanceLeft = Math.floor(diff / 1000 / 60);

        var allSections = document.getElementsByClassName("planSection");
        for (var i=0; i<allSections.length; i++) {
            if (allSections[i].querySelector(".time-left").querySelector("span").innerText.length > 0)
                allSections[i].querySelector(".time-left").querySelector("span").innerText = allowanceLeft;
        }
    }

    function openInitPage() {
        $("#initForm").show();
        $("#initForm").animate({
            top: "0",
            bottom: "0"
        });
        checkInitPage();
    }

    function checkInitPage() {
        var valid = true;
        var initDiv = document.getElementById("initForm");
        var allInps = initDiv.getElementsByTagName("input");
        var nextBtn = document.getElementById("initPageNext");

        for (var i=0; i<allInps.length; i++) {
            if (allInps[i].value.trim() == "") {
                valid = false;
                break;
            }
        }

        var startDateVal = $("#startDate").val();
        if (isNaN(Date.parse(startDateVal)))
            valid = false;
        if (isNaN(Date.parse(endDate.value)))
            valid = false;

        if (valid) {
            nextBtn.setAttribute("onclick", "dismissInit();")
            nextBtn.classList.remove("maincta-disabled");
            nextBtn.classList.add("maincta");
        }
        else {
            nextBtn.removeAttribute("onclick");
            nextBtn.classList.remove("maincta");
            nextBtn.classList.add("maincta-disabled");
        }
    }
    var oldVal;
    function checkResetEndDate() {
        var startDateVal = $("#startDate").val();
        var endDateVal = $("#endDate").val();

        if (startDateVal.trim()) {
            if (startDateVal != oldVal) {
                $("#endDate").val("");
                $("#endDate").attr("min", new Date(startDateVal).toISOString().split("T")[0]);
                oldVal = startDateVal;
            }
        }
    }
    async function dismissInit() {
        var initDiv = document.getElementById("initForm");
        var datesDiv = document.getElementById("dates-selection");
        var plansDiv = document.getElementById("planPage");
        var firstDiv = document.getElementById("firstSelection");
        var startDate = new Date($("#startDate").val());
        var endDate = new Date($("#endDate").val());

        var days = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 3600 * 24)) + 1;
        var datesSelection = document.querySelector("#dates-selection");
        var dateCards = [].slice.call(document.getElementsByClassName("card-date"));
        var diff = days - dateCards.length;
        
        if (dateCards.length > 0) {
            // Prompt for action
            if (startDate > new Date(dateCards[0].querySelector("h5").innerText)) {
                $("#changesPopup").fadeIn(150);
            }

            datesSelection.innerHTML = 
            `<div class="card" id="card-date-add" onclick="openInitPage();" style="width: 100px;">
                <h5>+ Add day</h5>
            </div>`;
        }

        // Pull form down
        $("#initForm").animate({
            bottom: "-200vh"
        }, 350, function() {
            $("#initForm").hide();
        });
        $("#planPage").show();

        var checkDate = startDate;
        for (var i=0; i<days; i++) {
            await new Promise(resolve => setTimeout(resolve, 150));
            var cardDate = new DOMParser().parseFromString(`
            <div class="card card-date" style="width: 150px;" onclick="toggleDay(this);">
                <h5>${checkDate.toISOString().slice(0, 10)}</h5>
                <p class="tm-selection">drive<span hidden>drive</span></p>
                <ul class="tm" style="display: block;">
                    <li onclick="chooseTransportMode(this);">Drive<span hidden>drive</span></li>
                    <li onclick="chooseTransportMode(this);">Public Transport<span hidden>pt</span></li>
                    <li onclick="chooseTransportMode(this);">Bus<span hidden>bus</span></li>
                    <li onclick="chooseTransportMode(this);">Walk<span hidden>walk</span></li>
                    <li onclick="chooseTransportMode(this);">Cycle<span hidden>cycle</span></li>
                </ul>
            </div>`, "text/html").body.firstElementChild;

            datesDiv.insertBefore(cardDate, document.querySelector("#card-date-add"));
            checkDate.setDate(checkDate.getDate() + 1);  
        }

        datesDiv.querySelector(".card-date").classList.add("addColor");

        // Add days card
        var plansSec = new DOMParser().parseFromString(
        `<div class="device planSection" style="display: none;">
            <div class="float-right">
                <a href="/itinerary/showTrip">Map</a>
            </div>

            <div class="time-left">Duration left: <span></span></div>
            <div class="transport-text">Transport mode: </div>

            <div class="recommendation-listings">
                <button class="btn-addColor start-location" onclick="openSearch(this, '1');">+ Add start Location</button>
            </div>
        </div>`, "text/html").body.firstElementChild.cloneNode(true);
        var allSections = document.getElementsByClassName("planSection");
        for (var i=0; i<Math.abs(diff); i++) {
            if (diff > 0) {
                var clonedPlansSec = plansSec.cloneNode(true);
                clonedPlansSec.style.display = "none";
                plansDiv.appendChild(clonedPlansSec);
            }
            else if (diff < 0) {
                // TODO: Change query selector h5 change in the future
                if (startDate > new Date(dateCards[0].querySelector("h5").innerText)) {
                    allSections[i].remove();
                }
                else {
                    allSections[dateCards.length-1].remove();
                }
            }
        }

        plansDiv.querySelector(".planSection").style.display = "block";
        initAllowance();

        saveTrips();
    }

    function dateChangesAction(actionNum) {
        if (actionNum == 2) {
            var div = document.getElementsByClassName("recommendation-listings");
            for (i=0; i<div.length; i++) {
                div.innerHTML = `<button class="btn-addColor start-location" onclick="openSearch(this, '${i+1}');">+ Add start Location</button>`;
            }
        }

        saveTrips();
        $("#changesPopup").fadeOut(150);
    }

    function removeFirstBtn(btn) {
        btn.classList.add("btn-addPlan")
        btn.innerText = " +  ";
    }

    function nextRecommend(pageNum, order, cat, sectionNo, btn) {
        recommend(pageNum+1, order, cat, sectionNo, true);
        btn.remove();
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(showYourPosition, positioningError, {
                timeout: 500,
                enableHighAccuracy: true
            });
        }
    }

    // Choose transport mode
    function chooseTransportMode(btn) {
        var cardDate = btn.closest(".card-date");
        cardDate.querySelector(".tm-selection").innerHTML = btn.innerHTML;

        saveTrips();
    }

    function openRecommendTab(order, btn) {
        // Pull screen up
        $("#recommendationTab").show();
        $("#recommendationTab").animate({
            top: "0",
            bottom: "0"
        }, 350);

        sectionIndex = [].slice.call(document.getElementsByClassName("recommendation-listings")).indexOf(btn.closest(".recommendation-listings"));
        document.getElementById("sectionIndex").innerText = sectionIndex;

        allCat = document.getElementById("categories").getElementsByTagName("li");
        for (var i=0; i<allCat.length; i++) {
            var li = allCat[i];
            li.setAttribute("onclick", `recommend(1, ${order}, '${li.querySelector("p").innerText}')`)
        }
        recommend(1, order, "Eateries");
    }
    function closeRecommendTab() {
        // Pull screen down
        $("#recommendationTab").animate({
            bottom: "-200vh"
        }, 350, function () {
            $("#recommendationTab").hide();
        });
    }
    // Order - the positional order of the button in DOM
    async function recommend(pageNum, order, cat, sectionNo=0, append=false) {
        // Stop pending ajax req
        if (requests.length > 0) {
            while (requests.length > 0) {
                try {
                    requests[0].abort();
                }
                catch (e) {}
                finally {
                    requests.pop(0);
                }
            }
        }

        var sectionIndex = parseInt(document.getElementById("sectionIndex").innerText);

        transportMde = document.getElementsByClassName("tm-selection")[sectionIndex].querySelector("span").innerText;

        div = document.getElementsByClassName("recommendation-listings")[sectionIndex];
        var allCards = div.getElementsByClassName("plan-selection");

        $("#reloadingbg").show();
        console.log(pageNum+", "+order);
        // Get place before, after and registered places
        var registeredPlaces = [].slice.call(allCards).slice(1, allCards.length - 1).map(x => x.querySelector(".plan-address").innerText);
        if (order - 1 > 0) {
            var placeBefore = allCards[order-2].querySelector(".plan-address").innerText;
            var latlng = allCards[order-2].querySelector(".plan-latlng").innerText.split(",");
        }
        else {
            var placeBefore;
            var latlng = allCards[0].querySelector(".plan-latlng").innerText.split(",");
        }
    
        var placeAfter = allCards[order-1].querySelector(".plan-address").innerText;
        startTme = new Date();
        startTme = new Date(startTme.getFullYear(), startTme.getMonth(), startTme.getDate(), 8, 0, 0);
        // TODO
        for (var i=1; i<allCards.length-1; i++) {
            startTme.setTime(startTime.getTime() + parseInt(allCards[i].querySelector(".plan-total-duration").innerText));
        }
        var allowanceLeft = div.closest(".planSection").querySelector(".time-left").querySelector("span").innerText;

        async function fetchDisplay(sectionNo) {
            console.log(startTme.getHours())
            request = await $.ajax({
                type: "POST",
                url: `/funcs/planner-recommend-places?page=${pageNum}`,
                data: {
                    date: currentTime.toISOString().slice(0, 10),
                    startTime: startTme.getHours() + ":" + startTme.getMinutes(),
                    timeLeft: allowanceLeft,
                    latitude: latlng[0],
                    longitude: latlng[1],
                    category: cat,
                    transportMode: transportMde,
                    skipped: JSON.stringify(skipped),
                    placesAdded: registeredPlaces,
                    abovePlace: placeBefore,
                    belowPlace: placeAfter,
                    section: sectionNo
                },
                success: function(result) {
                    cleanedResult = result.replaceAll("\\u", "").replaceAll("NaN", `""`);
                    result = JSON.parse(cleanedResult);

                    listingIndex = [document.getElementById("recommend-main"), document.getElementById("recommend-ratings"), document.getElementById("recommend-partners")]
                    pendingChooseList[sectionNo] = result;
                    listing = listingIndex[sectionNo-1]
                    if (!append)
                        listing.innerHTML = "";

                    if (result.list.length > 0) {
                        for (var i in result.list) {
                            var recommendCard = 
                            `<div class="maincard attractioncard plan-choice" onclick="choosePlace(this, ${sectionNo}, ${order}, ${i});">
                                <div class="cardimg" style="background-image: url('${result.list[i].Image_url}');">
                                </div>
                    
                                <div class="maincardinfo attractioncardinfo">
                                <h1 class="recentname">${result.list[i].Name}</h1>
                    
                                <div class="recenttype">
                                    <h3 class="recentcat">${result.list[i].Category.replace(/,/g, "â€¢")}</h3>
                                    <div class="rating">`
                            for (var i=0; i< Math.round(result.list[i].Rating); i++) {
                                recommendCard += 
                                    `<svg width="12" height="12" fill="none">
                                        <rect x="0.5" y="0.5" width="11" height="11" rx="1.5" stroke="#E4002B" />
                                    </svg>`
                            }
                            for (var i=0; i< 5 - Math.round(result.list[i].Rating); i++) {
                                recommendCard +=
                                    `<svg width="12" height="12" fill="none">
                                        <rect x="0.5" y="0.5" width="11" height="11" rx="1.5" stroke="#C4C4C4" />
                                    </svg>`
                            }
                            recommendCard +=
                                `       <p class="ratingvalue">${result.list[i].Review_no}</p>
                                    </div>
                                </div>
                    
                                </div>
                            </div>`;
                            listing.innerHTML += recommendCard;
                        }
                    }
                    else {
                        listing.innerHTML += `<div class="card">There isn't any available places to be added</div>`;
                        var allBtns = div.getElementsByClassName("btn-addPlan");
                        for (var i=0; i<allBtns.length; i++) {
                            allBtns[i].disabled = true;
                            allBtns[i].classList.remove("btn-addColor");
                        }
                    }

                    if (result.list.length == 10)
                        listing.innerHTML += `<p onclick="nextRecommend(${pageNum}, ${order}, '${cat}', ${sectionNo}, this);" class="list-load-more">Load more</p>`;

                    console.log(skipped);
                    
                },
                error: function(jq, status, errorMsg) {
                    div.innerHTML = 
                    `<div class="plan-choices-list">
                        Something went wrong. Try again
                    </div>`;
                },
                complete: function(result) {
                    $("#reloadingbg").hide();
                }
            });

            requests.push(request);
        }

        if (sectionNo == 0) {
            for (var i=1; i<4; i++) {
                fetchDisplay(i)
            }
        }
        else
            fetchDisplay(sectionNo)
    }

    function choosePlace(btn, index, order, itemNo) {
        btn.parentElement.remove();
        sectionIndex = parseInt(document.getElementById("sectionIndex").innerText);
        div = document.getElementsByClassName("recommendation-listings")[sectionIndex];
        var info = pendingChooseList[index].list[itemNo];

        var newPlace = new DOMParser().parseFromString(`
            <div class="card plan-selection">
                <h5 class="plan-name">${info.Name}</h5>
                <p class="plan-address" style="font-size:12px">${info.Address}</p>
                <br />
                <p class="plan-activity-duration"><span>${Math.round(info.ActivityDuration)}</span> min</p>
                <p class="plan-total-duration"><span>${Math.round(info.Duration)}</span> min</p>
                <p class="plan-timing"></p>
                <p class="plan-latlng" hidden>${info.Latlng}</p>
                <p class="plan-edit" onclick="editCard(this, ${order})">Edit</p>
                <p class="plan-delete" onclick="delCard(this, ${order})">Delete</p>
            </div>`, "text/html").body.firstElementChild;
        var newBtn = new DOMParser().parseFromString(`   
            <button class="btn-addPlan btn-addColor" onclick="recommend(1, ${order+1});">  +  </button>`, "text/html").body.firstElementChild;

        var allAddBtns = div.getElementsByClassName("btn-addPlan");
        console.log(order, allAddBtns.length)
        
        div.insertBefore(newBtn, allAddBtns[order-1].nextSibling);
        div.insertBefore(newPlace, allAddBtns[order-1].nextSibling);
        
        var timeLeft = document.getElementsByClassName("time-left")[sectionIndex].querySelector("span");
        var allowanceLeft = timeLeft - info.Duration;
        timeLeft.innerText = allowanceLeft;
        
        // Fill up info for autosaving data
        reCal2Places(div, order);
        reAssignValues();
        saveTrips();

        closeRecommendTab();
    }

    // Edit/delete/rearrange
    async function editCard(btn, order) {
        var card = btn.closest(".plan-selection");
        var timeLeft = card.parentElement.parentElement.querySelector(".time-left").querySelector("span");
        card.closest(".recommendation-listings").getElementsByClassName("btn-addPlan")[order-1].remove();
        reAssignValues();

        timeLeft.innerText = parseInt(timeLeft.innerText) + parseInt(card.querySelector(".plan-total-duration").querySelector("span").innerText);
        openRecommendTab(order-1);
        card.remove();
    }

    function delCard(btn, order) {
        var card = btn.closest(".plan-selection");
        
        var div = btn.closest(".recommendation-listings");
        div.getElementsByClassName("btn-addPlan")[order-1].remove();
        var timeLeft = div.parentElement.querySelector(".time-left").querySelector("span");
        timeLeft.innerText = parseInt(timeLeft.innerText) + parseInt(card.querySelector(".plan-total-duration").querySelector("span").innerText);
        card.remove();

        reAssignValues();
        reCal2Places(div, order-1);
    }

    // Recalculate route and travel time
    async function reCal2Places(div, order) {
        var cards = div.getElementsByClassName("plan-selection");
        var index = [].slice.call(document.getElementsByClassName("recommendation-listings")).indexOf(div);
        var aboveCard = cards[order-1];
        var belowCard = cards[order];
        var totalDuration = 0;
        for (var i=1; i<order-1; i++) {
            var duration = parseFloat(cards[i].querySelector(".plan-total-duration").querySelector("span").innerText);
            totalDuration += duration;
        }
        var divDate = new Date($("#startDate").val());
        divDate = new Date(divDate.setDate(divDate.getDate() + (order-1)));

        await $.ajax({
            type: "POST",
            url: `/funcs/reCalculate`,
            data: {
                latlngs: [aboveCard.querySelector(".plan-latlng").innerText, belowCard.querySelector(".plan-latlng").innerText],
                routeType: document.getElementsByClassName("tm-selection")[index].innerText,
                date: divDate.toISOString().slice(0, 10),
                topDuration: totalDuration,
                startTime: aboveCard.querySelector(".plan-timing").innerText
            },
            success: function(result) {
                result = JSON.parse(result);
                var belowCardTDuration = belowCard.querySelector(".plan-total-duration").querySelector("span");
                var belowCardADuration = belowCard.querySelector(".plan-activity-duration").querySelector("span");
                var timeDiff = result[0] + parseInt(belowCardADuration.innerText) - parseInt(belowCardTDuration.innerText);
                belowCardTDuration.innerText = parseInt(belowCardADuration.innerText) + result[0];
                div.parentElement.parentElement.querySelector(".time-left").querySelector("span").innerText = parseInt(div.parentElement.parentElement.querySelector(".time-left").querySelector("span").innerText) + timeDiff;
            }
        })

        saveTrips();
    }

    function reAssignValues() {
        var div = document.getElementsByClassName("recommendation-listings");

        for (var i=0; i<div.length; i++) {
            var btn = div[i].getElementsByClassName("btn-add-place");
            for (var j=0; j<btn.length; j++) {
                btn[j].setAttribute("onclick", `recommend(1, ${j+1}, this);`);
            }

            var plansCards = div[i].getElementsByClassName("plan-selection");

            var startTme = startTime;
            var currTime = startTme.toLocaleTimeString('en-SG', {hour12: false})
            if (plansCards.length > 0) {
                plansCards[0].querySelector(".plan-timing").innerText = currTime.substring(0, currTime.length-3);
                for (var j=1; j<plansCards.length-1; j++) {
                    startTme.setTime(startTme.getTime() + parseInt(plansCards[j].querySelector(".plan-total-duration").querySelector("span").innerText)*60000);

                    currTime = startTime.toLocaleTimeString('en-SG', {hour12: false})
                    plansCards[j].querySelector(".plan-timing").innerText = currTime.substring(0, currTime.length-3);
                }
            }

        }
    }

    async function saveTrips() {
        var div = document.getElementsByClassName("recommendation-listings");
        var cardDates = document.getElementsByClassName("card-date");
        var checkDate = new Date($("#startDate").val());

        var plannerIdStr = document.querySelector("#planner-id").value; 
        if (plannerIdStr.trim().length == 0)
            plannerIdStr = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
        document.querySelector("#planner-id").value = plannerIdStr;

        async function reset() {
            await $.ajax({
                type: "POST",
                url: `/funcs/clear-planner?id=${$("#planner-id").val()}`,
                data: {},
                success: function(result) {
                    console.log("System: Reset planner. Waiting for new planner ...");
                }
            });
        }
        async function save(index) {
            await $.ajax({
                type: "POST",
                url: `/funcs/save-trip`,
                data: {
                    tripType: "Planner",
                    tripName: "Hello",
                    date: checkDate.toISOString().slice(0, 10),
                    names: placesName,
                    addresses: placesAddress,
                    categories: placesCategory,
                    images: placesImg,
                    activityDuration: placesActivityDuration,
                    duration: placesDuration,
                    latlngs: placesLatlng,
                    transportMode: cardDates[index].querySelector(".tm-selection").querySelector("span").innerText,
                    confirmed: false,
                    status: "Planning",
                    plannerId: plannerIdStr,
                    hasEnd: hasE
                },
                success: function(result) {
                    result = JSON.parse(result);
                    document.querySelector("#planner-id").value = result.plannerId;
                    console.log("System: Trip "+(index+1)+" saved.");
                }
            });
        }

        reset();
        for (var i=0; i<div.length; i++) {
            // Update db function
            var allPlacesDiv = div[i].getElementsByClassName("plan-selection");
            var placesName = [];
            var placesAddress = [];
            var placesActivityDuration = [];
            var placesCategory = [];
            var placesImg = [];
            var placesDuration = [];
            var placesLatlng = [];

            var hasE = false;
            if (allPlacesDiv.length > 0) {
                hasE = allPlacesDiv[allPlacesDiv.length-1].classList.contains("end")
            }

            for (var j=0; j<allPlacesDiv.length; j++) {
                placesName.push(allPlacesDiv[j].querySelector(".plan-name").innerText);
                placesAddress.push(allPlacesDiv[j].querySelector(".plan-address").innerText);
                if (i == 0 || (i == allPlacesDiv.length-1 && hasE)) {
                    placesCategory.push(null);
                    placesImg.push(null);
                    placesActivityDuration.push(null);
                    placesDuration.push(null);
                }
                else {
                    placesCategory.push(allPlacesDiv[i].querySelector(".plan-category").innerText);
                    placesImg.push(allPlacesDiv[i].querySelector(".plan-img").querySelector("span").innerText);
                    placesActivityDuration.push(parseInt(allPlacesDiv[j].querySelector(".plan-activity-duration").querySelector("span").innerText));
                    placesDuration.push(parseInt(allPlacesDiv[j].querySelector(".plan-total-duration").querySelector("span").innerText));
                }
                placesLatlng.push(allPlacesDiv[j].querySelector(".plan-latlng").innerText);
            }

            await save(i);

            checkDate.setDate(checkDate.getDate() + 1);
        }
    }

    var canSearch = true;
    var dropdownCooldown = false;

    // Searching - for adding start and end location
    function openSearch(btn, order) {
        // Pull screen up
        $("#searchTab").show();
        $("#searchTab").animate({
            top: "0",
            bottom: "0"
        }, 350, function () {
            document.querySelector("#searchBar").focus();
        });
        var btnClassList = btn.classList;
        var idClass;
        for (var i=0; i<btnClassList.length; i++) {
            if (btnClassList[i].substring(btnClassList[i].length - 9, btnClassList[i].length) == "-location") {
                idClass = btnClassList[i];
                break;
            }
        }

        $("#search-btnId").text(idClass);
        $("#search-divOrder").text(order);
    }
    function closeSearch() {
        // Pull screen down
        $("#searchTab").animate({
            bottom: "-200vh"
        }, 350, function() {
            $("#searchTab").hide();
        });
    }

    function pauseSearch() {
        canSearch = false;
        setTimeout(function() {
            canSearch = true;
            search();
        }, 350);
    }
    
    function search() {
        if (canSearch) {
            var dropdownMenu = document.querySelector("#search-results");
            const search = document.querySelector("#searchBar").value;
            const pageNum = $("#searchPage").val()

            if (!search.trim()) {
                dropdownMenu.innerHTML = "";
            }
            else {
                $.ajax({
                    url: `https://developers.onemap.sg/commonapi/search?searchVal=${search}&returnGeom=Y&getAddrDetails=Y&pageNum=${pageNum}`,
                    success: function(result) {
                        dropdownMenu.innerHTML = "";
                        if (result.results.length > 0) {
                            dropdownMenu.style.display = "block";
                            showLength = 10;
                            if (result.results.length < 10) {
                                showLength = result.results.length;
                            }

                            for (var i=0; i<showLength; i++) {
                                dropdownCooldown = true;
                                record = result.results[i]
                                dropdownMenu.innerHTML += `
                                <div class="dropdown-item" onclick="addSE(this);">
                                    <p style="font-size: 14px; margin-bottom: 3px; font-weight: bold;">${capitalize(record.SEARCHVAL)}</p>
                                    <p style="font-size: 11px; max-width: 100%; overflow: auto; margin-bottom: 3px;">${capitalize(record.ADDRESS)}</p>
                                    <p hidden>${record.LATITUDE},${record.LONGITUDE}</p>
                                </div>`;

                                setTimeout(function () { dropdownCooldown = false; }, 126)
                            }
                        }
                        else {
                            dropdownMenu.innerHTML = `<div class="dropdown-item">No results found</div>`; 
                        }
                    }
                });
            }

        }     
    }

    function searchNextPage() {
        $("#searchPage").text(parseInt($("#searchPage").text()) + 1)
    }

    function addSE(card) {
        var btnId = $("#search-btnId").text();
        var divOrder = parseInt($("#search-divOrder").text());
        var div = document.getElementsByClassName("recommendation-listings")[divOrder-1];
        var btn = div.querySelector(`.${btnId}`);
        
        var allP = card.getElementsByTagName("p");
        var newCard = new DOMParser().parseFromString(
            `<div class="card plan-selection">
                <h5 class="plan-name">${allP[0].innerText}</h5>
                <p class="plan-address" style="font-size:12px">${allP[1].innerText}</p>
                <br />
                <p class="plan-latlng" hidden>${allP[2].innerText}</p>
            </div>`, "text/html").body.firstElementChild;

        if (btnId == "start-location") {
            newCard.classList.add("start");
        }
        else
            newCard.classList.add("end");

        div.replaceChild(newCard, btn);
        if (btnId == "start-location") 
            div.innerHTML += 
                `<button class="btn-addColor" onclick="removeFirstBtn(this); recommend(1, 1, this);">+ Add a place</button>
                <button class="btn-addColor end-location" onclick="openSearch(this, '${divOrder}');">+ Add end Location</button>`;

        closeSearch();
        saveTrips();
    }

    function toggleDay(card) {
        var dateCards = document.getElementsByClassName("card-date");
        var index = card;
        if (!Number.isInteger(card))
            index = [].slice.call(dateCards).indexOf(card);
        var planSections = document.getElementsByClassName("planSection");

        for (var i=0; i<dateCards.length; i++) {
            if (i == index) {
                planSections[i].style.display = "block";
                dateCards[i].classList.add("addColor");
            }
            else {
                planSections[i].style.display = "none";
                dateCards[i].classList.remove("addColor");
            }
        }

        
    }

    // Map settings
    // Map display init
    const apiKey = "{{apiKey}}";
    L.Icon.Default.imagePath = "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/images";
    var center = L.bounds([1.56073, 104.11475], [1.16, 103.502]).getCenter();
    var map = L.map('mapdiv').setView([center.x, center.y], 12);
    var yourMarker;
    var startMarker;
    var endMarker;

    var routeTextures = {
        WALK: {color: "black", dashArray: "10, 10"},
        SUBWAY: {
            NE: {color: "purple"},
            NS: {color: "red"},
            DT: {color: "blue"},
            EW: {color: "green"},
            CC: {color: "yellow"},
            TE: {color: "brown"},
            Default: {color: "grey"}
        },
        DRIVE: {color: "black"}
    }

    var basemap = L.tileLayer(`http://maps-{s}.onemap.sg/v2/Default/{z}/{x}/{y}.png`, {
        detectRetina: true,
        maxZoom: 18,
        minZoom: 12,
    });

    map.setMaxBounds([[1.56073, 104.1147], [1.16, 103.502]]);

    basemap.addTo(map);

    var updatePosition = false;
    var repeatedBuildings = {};

    function openMapView() {
        // Make toggle cards
        var activeSection;
        var index;
        var allSections = document.getElementsByClassName("planSection");
        for (var i=0; i<allSections.length; i++) {
            if (allSections[i].style.display == "block") {
                activeSection = allSections[i];
                index = i;
                break;
            }
        }

        var planCards = activeSection.getElementsByClassName("plan-selection");
        var mapDiv = document.getElementById("map-selection");
        mapDiv.innerHTML = "";
        for (var i=1; i<planCards.length; i++) {
            mapDiv.innerHTML += 
            `<div class="trip-place" style="border: 1px solid grey ;width: 250px; margin: 5px;" onclick="showRoute(${index}, '${planCards[i-1].querySelector(".plan-latlng").innerText}', '${planCards[i].querySelector(".plan-latlng").innerText}')">
                <h5>${planCards[i].querySelector(".plan-name").innerText}</h5>
                <p>${planCards[i].querySelector(".plan-address").innerText}</p>
            </div>`;
        }

        // Default show 1st part trip
        var firstCard = document.querySelector(".trip-place")
        if (typeof firstCard.onclick == "function")
            firstCard.onclick.apply(firstCard);

        // Pull plan page down
        $("#planPage").animate({
            bottom: "-200vh"
        }, 350, function () {
            $("#planPage").hide()
        });
    }

    function dismissMapView() {
        // Pull plan page up
        $("#planPage").show();
        $("#planPage").animate({
            top: "0",
            bottom: "0"
        }, 350);
    }

    function showYourPosition(position) {  
        updatePosition = true;  
        // Mark marker
        if (yourMarker) {
            map.removeLayer(yourMarker);
        }
        
        yourMarker = new L.Marker([position.coords.latitude, position.coords.longitude], {bounceOnAdd: false, customId: "YouMarker"}).addTo(map); 

        latLngStr = position.coords.latitude + "," + position.coords.longitude;
        document.getElementById("start-latlng").innerText = latLngStr;
    }

    function positioningError(error) {

    }

    function showRoute(index, position1, position2) {
        // Routing display
        var today = new Date();
        var routeType = document.getElementsByClassName("tm-selection")[index].querySelector("span").innerText;
        if (routeType == "Public Transport") {
            routeType = "pt";
        }

        var position1 = position1.split(",");
        var position2 = position2.split(",");

        function decodeGeo(encodedRoute) {
            if (encodedRoute !== undefined || encodedRoute !== '' || encodedRoute != null ) {
                var routeGeo = L.Polyline.fromEncoded(encodedRoute, {
                    precision: 6
                });

                return routeGeo;
            }
        }

        $.ajax({
            url: `https://developers.onemap.sg/privateapi/routingsvc/route?start=${position1[0]},${position1[1]}&end=${position2[0]},${position2[1]}&routeType=${routeType}&token=${apiKey}&date=${String(today.getFullYear())}-${String(today.getMonth()+1)}-${String(today.getDate())}&time=${String(today.getHours())}:${String(today.getMinutes())}:${String(today.getSeconds())}&mode=TRANSIT`,
            success: function(result) {
                //Set result to a variable for writing
                var encodedRoute;
                var modes = [];

                // Remove previous markings and route paths
                if (startMarker) {
                    map.removeLayer(startMarker);
                }
                if (endMarker) {
                    map.removeLayer(endMarker);
                }
                pathPieces = [].slice.call(document.getElementsByTagName("path")).map(x => x.parentElement);
                for (var i=0; i<pathPieces.length; i++) {
                    pathPieces[i].remove();
                }

                startMarker = new L.Marker([position1[0], position1[1]], {bounceOnAdd: true}).addTo(map);
                endMarker = new L.Marker([position2[0], position2[1]], {bounceOnAdd: true}).addTo(map);
                 
                if (routeType == "pt") {
                    var allRoutes = result.plan.itineraries;
                    for (var i in allRoutes) {
                        var transportMeans = allRoutes[i].legs;
                        for (var j in transportMeans) {
                            var details = transportMeans[j];
                            var mode = details.mode;

                            encodedRoute = details.legGeometry.points
                            var routeGeo = decodeGeo(encodedRoute);
                            modes = {endpoints: routeGeo._latlngs, mode: mode};

                            if (mode == "SUBWAY") {
                                var subwayLine = details.route;
                                L.polyline(modes.endpoints, routeTextures.SUBWAY[subwayLine]).addTo(map);
                            }
                            else {
                                L.polyline(modes.endpoints, routeTextures[modes.mode]).addTo(map);
                            }
                        }

                        // Remove for the next time, only take 1st route
                        break
                    }
                }
                else {
                    encodedRoute = result.route_geometry;
                    var routeGeo = decodeGeo(encodedRoute);
                    modes = {endpoints: routeGeo._latlngs, mode: routeType.toUpperCase()};

                    L.polyline(modes.endpoints, routeTextures[modes.mode]).addTo(map);
                }
            }
        });
    }

    window.addEventListener('load', function () {
        /*document.addEventListener('click', function (event) {
            const allTabs = document.getElementsById;
            const endInp = document.getElementById("end-location");
            const startInp = document.getElementById("start-location");

            if (![].slice.call(allTabs).find(x => x === event.target) && event.target != endInp && event.target != startInp) {
                if (!dropdownCooldown) {
                    for (var i in allTabs) {
                        allTabs.item(i).style.display = "none";
                    }
                }
            }
        });*/

        initFunctions();
    });

</script>
{% endblock %}
