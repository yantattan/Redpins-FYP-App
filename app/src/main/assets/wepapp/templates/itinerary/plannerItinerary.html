{% extends "base.html" %}
{% block title %}Redpins Buffer - Planner{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
<script src="https://cdn.onemap.sg/leaflet/onemap-leaflet.js"></script>
<script type="text/javascript" src="https://rawgit.com/jieter/Leaflet.encoded/master/Polyline.encoded.js"></script>


<div class="device" id="reloadingbg" style="display: none;">
    <img src="/static/images/logo.gif" alt="logo" class="relogogif">
    <p>Hang tight while we find the best places for you...</p>
</div>

<div class="main-div">
    {% if itineraries != None %}
    <div id="initForm" class="device" style="position: absolute; z-index:2; background-color: white; display: none; bottom: -200vh;">
    {% else %}
    <div id="initForm" class="device" style="position: absolute; z-index:2; background-color: white;">
    {% endif %}
        <!-- header -->
        <div class="explorerheader">
            <svg width="12" height="20" onclick="window.open('explore.html','_self')">
            <path
                d="M10.2642 0C10.8582 0.203504 11.2215 0.68581 11.6052 1.12894C11.9081 1.47897 11.8687 2.05183 11.5761 2.4156C11.5052 2.50072 11.4295 2.58174 11.3494 2.65828C8.94914 5.0464 6.54751 7.43334 4.14452 9.81909C4.0819 9.87251 4.01519 9.92099 3.94498 9.96409C4.03554 10.0582 4.08722 10.1167 4.14145 10.1676C6.56048 12.5737 8.9795 14.9796 11.3985 17.3854C11.8298 17.8148 11.9613 18.3439 11.6385 18.7738C11.3346 19.1709 10.9778 19.5251 10.5779 19.8264C10.2074 20.1093 9.70807 20.0259 9.34174 19.7247C9.28648 19.6794 9.23276 19.6311 9.18211 19.5807L0.412125 10.8636C-0.0248138 10.4296 -0.119978 9.92084 0.153748 9.45024C0.222198 9.33957 0.304744 9.23817 0.399334 9.14854C3.33272 6.23165 6.26697 3.31661 9.20206 0.403448C9.37602 0.231995 9.61905 0.132787 9.8324 0H10.2642Z"
                fill="#2B2B2B" />
            </svg>
            <h1>Plan a Trip</h1>
            &nbsp
        </div>

        <section class="plannerinput">
            <p id="start-latlng" hidden></p>

            <h1>Where To?</h1>
            <input type="text" class="Username" name="Username" value="Local" placeholder="City or State" readonly>
        
            <h1>Start & End Date</h1>
            <div class="startend">
                <input type="date" id="startDate" class="plannerdate inputstartdate" value="{% if itineraries != None %}{{itineraries[0].getDate().strftime('%Y-%m-%d')}}{% endif %}" onchange="checkResetEndDate(); checkInitPage();" placeholder="Start">
                <input type="date" id="endDate" class="plannerdate inputenddate" value="{% if itineraries != None %}{{itineraries[-1].getDate().strftime('%Y-%m-%d')}}{% endif %}" onchange="checkInitPage();" placeholder="End">
            </div>
        
            <h1>Add a Description</h1>
            <input type="text" class="describetrip" id="description" value="" placeholder="Describe your trip">
        
            <div class="plannerbanner">
                <img src="../../static/images/buffcar.png" alt="">
        
            </div>
        </section>

        <section class="bottom">
            <div class="maincta-disabled" id="initPageNext">
              <h1>Create Trip!</h1>
            </div>
          </section>
    </div>

    <section class="explorertripitinerary" id="pageMain">
        <div id="dates-selection" style="display: inline; overflow-x: auto;">
            {% if itineraries != None %}{% for itinerary in itineraries %}
            <div class="card card-date" style="width: 150px;" onclick="toggleDay(this);">
                <h5>{{itinerary.getDate().strftime("%Y-%m-%d")}}</h5>
                <p class="tm-selection">{% if itinerary.getTransportMode() == "pt" %}Public Transport{% else %}{{itinerary.getTransportMode()}}{% endif %}<span hidden>{{itinerary.getTransportMode()}}</span></p>
                <ul class="tm" style="display: block;">
                    <li onclick="chooseTransportMode(this);">Drive<span hidden>drive</span></li>
                    <li onclick="chooseTransportMode(this);">Public Transport<span hidden>pt</span></li>
                    <li onclick="chooseTransportMode(this);">Bus<span hidden>bus</span></li>
                    <li onclick="chooseTransportMode(this);">Walk<span hidden>walk</span></li>
                    <li onclick="chooseTransportMode(this);">Cycle<span hidden>cycle</span></li>
                </ul>
            </div>
            {% endfor %}{% endif %}
            <div class="card" id="card-date-add" onclick="openInitPage();" style="width: 100px;">
                <h5>+ Add day</h5>
            </div>
        </div>

        {% if itineraries == None %}
        <div id="planPage" style="display: none; position: absolute; background-color: white;">
        {% else %}
        <div id="planPage" style="display: block; position: absolute; background-color: white;">
        {% endif %}
            <section class="req-info" hidden>
                {% if itineraries != None %}
                <div class="time-left">Duration left: <span>{{itinerary.getTimeLeft()| int}}</span></div>
                {% else %}
                <div class="time-left">Duration left: <span></span></div>
                {% endif %}
            </section>

            {% if itineraries != None %}
                {% for i in range(itineraries|length) %}
                {% set itinerary = itineraries[i] %}
                <div class="device planSection" style="display: none;">
                    <div class="recommendation-listings" style="overflow-y: scroll;">
                        {% if itinerary.getPlaces()| length == 0 %}
                        <button class="btn-addColor start-location" onclick="openSearch(this, '{{i+1}}');">+ Add start Location</button>

                        {% elif itinerary.getPlaces()| length == 1 %}
                        <div class="plan-selection start">
                            <div class="explorerstart">
                                <div class="explorerstartpoint">
                                    <svg width="31" height="31" viewBox="0 0 31 31" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path
                                        d="M0.888672 15.5C0.888672 12.5333 1.76841 9.63319 3.41663 7.16645C5.06485 4.69972 7.40753 2.77713 10.1484 1.64181C12.8893 0.506499 15.9053 0.209449 18.815 0.788228C21.7247 1.36701 24.3975 2.79562 26.4953 4.8934C28.5931 6.99119 30.0217 9.66394 30.6004 12.5737C31.1792 15.4834 30.8822 18.4994 29.7469 21.2403C28.6115 23.9811 26.689 26.3238 24.2222 27.972C21.7555 29.6203 18.8554 30.5 15.8887 30.5C13.9188 30.5 11.9683 30.112 10.1484 29.3582C8.32853 28.6044 6.67495 27.4995 5.28207 26.1066C2.46902 23.2936 0.888672 19.4783 0.888672 15.5ZM15.8887 24.5C17.6687 24.5 19.4088 23.9722 20.8888 22.9832C22.3688 21.9943 23.5224 20.5887 24.2036 18.9442C24.8848 17.2996 25.063 15.49 24.7157 13.7442C24.3685 11.9984 23.5113 10.3947 22.2526 9.13604C20.994 7.87737 19.3903 7.0202 17.6445 6.67294C15.8987 6.32567 14.0891 6.5039 12.4445 7.18509C10.8 7.86628 9.39438 9.01983 8.40544 10.4999C7.41651 11.9799 6.88867 13.72 6.88867 15.5C6.88867 17.887 7.83688 20.1761 9.52471 21.864C11.2125 23.5518 13.5017 24.5 15.8887 24.5Z"
                                        fill="#06A122" />
                                    </svg>
                                    <h1 class="plan-name">{{itinerary.getPlaces()[i].Name}}</h1>
                                    <p class="plan-address" hidden>{{itinerary.getPlaces()[i].Address}}</p>
                                    <p class="plan-latlng" hidden>{{itinerary.getPlaces()[i].Latlng}}</p>
                                </div>
        
                                <div class="explorerstarttime">
                                    <h1 class="plan-timing"></h1>
                                </div>
                            </div>
                        </div>

                        <button class="btn-addColor" onclick="removeFirstBtn(this); openRecommendTab(1, this);">+ Add a place</button>
                        {% if not itinerary.getEnd() %}
                        <button class="btn-addColor end-location" onclick="openSearch(this, '{{i+1}}');">+ Add end Location</button>
                        {% endif %}
                        
                        {% else %}
                            <div class="plan-selection start">
                                <div class="explorerstart">
                                    <div class="explorerstartpoint">
                                        <svg width="31" height="31" viewBox="0 0 31 31" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path
                                            d="M0.888672 15.5C0.888672 12.5333 1.76841 9.63319 3.41663 7.16645C5.06485 4.69972 7.40753 2.77713 10.1484 1.64181C12.8893 0.506499 15.9053 0.209449 18.815 0.788228C21.7247 1.36701 24.3975 2.79562 26.4953 4.8934C28.5931 6.99119 30.0217 9.66394 30.6004 12.5737C31.1792 15.4834 30.8822 18.4994 29.7469 21.2403C28.6115 23.9811 26.689 26.3238 24.2222 27.972C21.7555 29.6203 18.8554 30.5 15.8887 30.5C13.9188 30.5 11.9683 30.112 10.1484 29.3582C8.32853 28.6044 6.67495 27.4995 5.28207 26.1066C2.46902 23.2936 0.888672 19.4783 0.888672 15.5ZM15.8887 24.5C17.6687 24.5 19.4088 23.9722 20.8888 22.9832C22.3688 21.9943 23.5224 20.5887 24.2036 18.9442C24.8848 17.2996 25.063 15.49 24.7157 13.7442C24.3685 11.9984 23.5113 10.3947 22.2526 9.13604C20.994 7.87737 19.3903 7.0202 17.6445 6.67294C15.8987 6.32567 14.0891 6.5039 12.4445 7.18509C10.8 7.86628 9.39438 9.01983 8.40544 10.4999C7.41651 11.9799 6.88867 13.72 6.88867 15.5C6.88867 17.887 7.83688 20.1761 9.52471 21.864C11.2125 23.5518 13.5017 24.5 15.8887 24.5Z"
                                            fill="#06A122" />
                                        </svg>
                                        <h1 class="plan-name">{{itinerary.getPlaces()[0].Name}}</h1>
                                        <p class="plan-address" hidden>{{itinerary.getPlaces()[0].Address}}</p>
                                        <p class="plan-latlng" hidden>{{itinerary.getPlaces()[0].Latlng}}</p>
                                    </div>
            
                                    <div class="explorerstarttime">
                                        <h1 class="plan-timing"></h1>
                                    </div>
                                </div>
                            </div>
                            {% for i in range(1, itinerary.getPlaces()| length) %}
                                <div class="card plan-selection {% if i == itinerary.getPlaces()| length - 1 and itinerary.getEnd() %}end{% endif %}">
                                    <h5 class="plan-name">{{itinerary.getPlaces()[i].Name}}</h5>
                                    <p class="plan-address" style="font-size:12px">{{itinerary.getPlaces()[i].Address}}</p>
                                    <br />
                                    <p class="plan-timing"></p>
                                    <p class="plan-activity-duration">{% if itinerary.getPlaces()[i].ActivityDuration %}<span>{{itinerary.getPlaces()[i].ActivityDuration}}</span> min{% else %}<span></span>{% endif %}</p>
                                    <p class="plan-total-duration">{% if itinerary.getPlaces()[i].TotalDuration %}<span>{{itinerary.getPlaces()[i].TotalDuration|int}}</span> min{% else %}<span></span>{% endif %}</p>
                                    <p class="plan-latlng" hidden>{{itinerary.getPlaces()[i].Latlng}}</p>
                                    {% if i != itinerary.getPlaces()| length - 1 and i != 0 %}
                                    <p class="plan-edit" onclick="editCard(this, parseInt('{{i+1}}'))">Edit</p>
                                    <p class="plan-delete" onclick="delCard(this, parseInt('{{i+1}}'))">Delete</p>
                                    {% endif %}
                                </div>

                                <div class="plan-selection {% if i == itinerary.getPlaces()| length - 1 and itinerary.getEnd() %}end{% endif %}">
                                    <hr>
                                    <!-- explorerdirections -->
                                    <div class="explorerdirections">
                                        <div class="explorertransport">
                                        </div>
                
                                        <!-- explorertravelduration -->
                                        <div class="explorertravelduration">
                                        <h1><span class="plan-travel-duration">{{itinerary.getPlaces()[i].TravelDuration|int}}</span>min</a>
                                        <a data-toggle="collapse" href="#details-{{i+1}}"><h2>Details<svg width="9" height="5" viewBox="0 0 9 5" fill="none" xmlns="http://www.w3.org/2000/svg"></svg>
                                            <path
                                                d="M0.78125 0.657445C0.862652 0.406133 1.05557 0.252445 1.23283 0.0900984C1.37284 -0.0380473 1.60198 -0.0213795 1.74749 0.102437C1.78154 0.132408 1.81395 0.164424 1.84456 0.198329C2.79981 1.21383 3.75459 2.2299 4.70889 3.24655C4.73025 3.27304 4.74965 3.30127 4.76688 3.33097C4.80453 3.29266 4.82794 3.27079 4.84829 3.24785C5.81073 2.22441 6.7731 1.20098 7.7354 0.177549C7.90716 -0.00492803 8.11881 -0.0605592 8.29077 0.0760284C8.44962 0.204574 8.59127 0.355537 8.71182 0.524754C8.82497 0.681473 8.79159 0.89274 8.67112 1.04773C8.65301 1.0711 8.63367 1.09383 8.61352 1.11526L5.12668 4.82564C4.95309 5.0105 4.74959 5.05076 4.56134 4.93495C4.51708 4.90599 4.47652 4.87107 4.44067 4.83105C3.27391 3.59 2.1079 2.34859 0.942629 1.10682C0.874048 1.03322 0.834365 0.930405 0.78125 0.84014L0.78125 0.657445Z"
                                                fill="#E4002B" />
                                            </svg>
                                        </h2></a>
                                        </div>
                                    </div>
                
                                    <!-- showExpandedRoute -->
                                    <div class="showexpandedroute collapse" id="details-{{i+1}}">
                                        
                                        <div class="detailedwalking">
                                        
                                        <svg width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path
                                            d="M0.0078125 10C0.0078125 8.02219 0.594302 6.08879 1.69312 4.4443C2.79193 2.79981 4.35372 1.51809 6.18098 0.761209C8.00824 0.00433284 10.0189 -0.1937 11.9587 0.192152C13.8985 0.578004 15.6804 1.53041 17.0789 2.92894C18.4774 4.32746 19.4298 6.10929 19.8157 8.0491C20.2015 9.98891 20.0035 11.9996 19.2466 13.8268C18.4897 15.6541 17.208 17.2159 15.5635 18.3147C13.919 19.4135 11.9856 20 10.0078 20C8.69459 20 7.39423 19.7413 6.18098 19.2388C4.96772 18.7362 3.86533 17.9997 2.93674 17.0711C1.06138 15.1957 0.0078125 12.6522 0.0078125 10ZM10.0078 16C11.1945 16 12.3545 15.6481 13.3412 14.9888C14.3279 14.3295 15.097 13.3925 15.5511 12.2961C16.0052 11.1997 16.124 9.99335 15.8925 8.82946C15.661 7.66558 15.0896 6.59648 14.2504 5.75736C13.4113 4.91825 12.3422 4.3468 11.1784 4.11529C10.0145 3.88378 8.80807 4.0026 7.71171 4.45673C6.61535 4.91085 5.67828 5.67989 5.01899 6.66658C4.35971 7.65328 4.00781 8.81332 4.00781 10C4.00781 11.5913 4.63995 13.1174 5.76517 14.2426C6.89039 15.3679 8.41651 16 10.0078 16Z"
                                            fill="#BBBBBB" />
                                        </svg>
                
                                        
                                        <svg width="14" height="20" viewBox="0 0 14 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path
                                            d="M8.79073 3.72093C9.12694 3.72093 9.4556 3.61182 9.73514 3.40739C10.0147 3.20296 10.2326 2.91239 10.3612 2.57244C10.4899 2.23248 10.5236 1.8584 10.458 1.49751C10.3924 1.13661 10.2305 0.805109 9.99274 0.544918C9.75501 0.284728 9.45211 0.107536 9.12236 0.0357492C8.79262 -0.0360373 8.45082 0.000806104 8.14021 0.14162C7.82959 0.282435 7.5641 0.520895 7.37731 0.826847C7.19053 1.1328 7.09083 1.4925 7.09083 1.86047C7.09217 2.35344 7.2717 2.8258 7.5902 3.17439C7.90871 3.52297 8.3403 3.71946 8.79073 3.72093ZM5.73091 16.6512L6.58086 12.5581L8.36575 14.4186V20H10.0657V13.0233L8.28076 11.1628L8.79073 8.37209C9.3739 9.10142 10.0926 9.68613 10.8987 10.0872C11.7049 10.4882 12.5799 10.6964 13.4655 10.6977V8.83721C12.7307 8.84941 12.0061 8.64946 11.3644 8.25751C10.7228 7.86557 10.1869 7.29547 9.81067 6.60465L8.96072 5.11628C8.81006 4.84145 8.59888 4.61233 8.34647 4.44983C8.09407 4.28733 7.80848 4.19664 7.5158 4.18605C7.26082 4.18605 7.09083 4.27907 6.83584 4.27907L2.4161 6.32558V10.6977H4.116V7.53489L5.64591 6.88372L4.28599 14.4186L0.12123 13.4884L-0.21875 15.3488L5.73091 16.6512Z"
                                            fill="#707070" />
                                        </svg>
                
                                        <h1>7 mins (550 m)</h1>
                                        </div>
                
                                        
                                        <svg class="walkingdots" width="5" height="41" viewBox="0 0 5 41" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <circle cx="2.00781" cy="2" r="2" fill="#2B2B2B" />
                                        <circle cx="2.00781" cy="39" r="2" fill="#2B2B2B" />
                                        <circle cx="2.00781" cy="19" r="2" fill="#2B2B2B" />
                                        </svg>
                
                                        
                                        <div class="detailedtransportation">
                                        <div class="stationname">
                                            
                                            <svg width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path
                                                d="M0.0078125 10C0.0078125 8.02219 0.594302 6.08879 1.69312 4.4443C2.79193 2.79981 4.35372 1.51809 6.18098 0.761209C8.00824 0.00433284 10.0189 -0.1937 11.9587 0.192152C13.8985 0.578004 15.6804 1.53041 17.0789 2.92894C18.4774 4.32746 19.4298 6.10929 19.8157 8.0491C20.2015 9.98891 20.0035 11.9996 19.2466 13.8268C18.4897 15.6541 17.208 17.2159 15.5635 18.3147C13.919 19.4135 11.9856 20 10.0078 20C8.69459 20 7.39423 19.7413 6.18098 19.2388C4.96772 18.7362 3.86533 17.9997 2.93674 17.0711C1.06138 15.1957 0.0078125 12.6522 0.0078125 10ZM10.0078 16C11.1945 16 12.3545 15.6481 13.3412 14.9888C14.3279 14.3295 15.097 13.3925 15.5511 12.2961C16.0052 11.1997 16.124 9.99335 15.8925 8.82946C15.661 7.66558 15.0896 6.59648 14.2504 5.75736C13.4113 4.91825 12.3422 4.3468 11.1784 4.11529C10.0145 3.88378 8.80807 4.0026 7.71171 4.45673C6.61535 4.91085 5.67828 5.67989 5.01899 6.66658C4.35971 7.65328 4.00781 8.81332 4.00781 10C4.00781 11.5913 4.63995 13.1174 5.76517 14.2426C6.89039 15.3679 8.41651 16 10.0078 16Z"
                                                fill="#BBBBBB" />
                                            </svg>
                
                                            
                                            <svg width="13" height="15" viewBox="0 0 13 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path
                                                d="M0.929688 10.875C0.929688 11.5712 1.20261 12.2389 1.68842 12.7312C2.17422 13.2234 2.83312 13.5 3.52015 13.5L2.40995 14.625V15H11.2915V14.625L10.1813 13.5C10.8684 13.5 11.5273 13.2234 12.0131 12.7312C12.4989 12.2389 12.7718 11.5712 12.7718 10.875V3C12.7718 0.375 10.1221 0 6.85074 0C3.57936 0 0.929688 0.375 0.929688 3V10.875ZM6.85074 12C6.55797 12 6.27178 11.912 6.02835 11.7472C5.78492 11.5824 5.59519 11.3481 5.48316 11.074C5.37112 10.7999 5.3418 10.4983 5.39892 10.2074C5.45604 9.91639 5.59702 9.64912 5.80404 9.43934C6.01105 9.22956 6.27481 9.0867 6.56195 9.02882C6.8491 8.97094 7.14673 9.00065 7.41721 9.11418C7.68769 9.22771 7.91888 9.41997 8.08153 9.66665C8.24419 9.91332 8.331 10.2033 8.331 10.5C8.32983 10.8975 8.1735 11.2783 7.89615 11.5593C7.6188 11.8404 7.24297 11.9988 6.85074 12ZM11.2915 6.75H2.40995V3H11.2915V6.75Z"
                                                fill="#707070" />
                                            </svg>
                
                                            <h1>Yio Chu Kang</h1>
                                        </div>
                
                                        </div>
                                    </div>
                                    <hr>
                
                                    <button class="btn-addPlan btn-addColor" onclick="openRecommendTab(parseInt('{{i+1}}'));">  +  </button>
                                    <hr>
                
                                    <div class="explorerevent">
                                        <div class="eventdetails">
                                            <div class="eventimg plan-img" style="background-image: url('{{itinerary.getPlaces()[i].Image}}');">
                                                <span hidden>{{itinerary.getPlaces()[i].Img}}</span>
                                            </div>
                                
                                            <div class="eventinfo">
                                                <h1 class="eventname plan-name">{{itinerary.getPlaces()[i].Name}}</h1>
                                                <h2 class="eventtype plan-category">{{itinerary.getPlaces()[i].Category}}</h2>
                                                <p class="plan-address" hidden>{{itinerary.getPlaces()[i].Address}}</p>
                                                <p class="plan-activity-duration" hidden><span>{{itinerary.getPlaces()[i].ActivityDuration}}</span> min</p>
                                                <p class="plan-total-duration" hidden><span>{{itinerary.getPlaces()[i].TotalDuration|int}}</span> min</p>
                                                <p class="plan-timing" hidden></p>
                                                <p class="plan-latlng" hidden>{{itinerary.getPlaces()[i].Latlng}}</p>
                                            </div>
                                        </div>
                                
                                        <div class="eventedit">
                                            <svg class="editevent plan-edit" width="21" height="21" viewBox="0 0 21 21" fill="none" xmlns="http://www.w3.org/2000/svg"
                                            onclick="editCard(this, parseInt('{{i+1}}'));">
                                            <path
                                                d="M0.333984 16.3335V20.5H4.49963L16.7872 8.21241L12.6208 4.04593L0.333984 16.3335ZM20.0091 4.9905C20.1121 4.88775 20.1938 4.76571 20.2495 4.63135C20.3053 4.49699 20.334 4.35295 20.334 4.20748C20.334 4.06202 20.3053 3.91798 20.2495 3.78362C20.1938 3.64926 20.1121 3.52721 20.0091 3.42447L17.4095 0.82485C17.3068 0.721875 17.1847 0.640178 17.0504 0.584435C16.916 0.528693 16.772 0.5 16.6265 0.5C16.481 0.5 16.337 0.528693 16.2026 0.584435C16.0683 0.640178 15.9462 0.721875 15.8435 0.82485L13.8101 2.8574L17.9725 7.02387L20.0058 4.9905H20.0091Z"
                                                fill="#2B2B2B" />
                                            </svg>
                                
                                            <svg class="deleteevent plan-delete" width="17" height="21" viewBox="0 0 17 21" fill="none" xmlns="http://www.w3.org/2000/svg"
                                            onclick="delCard(this, parseInt('{{i+1}}'));">
                                            <path
                                                d="M2.01977 18.2776C2.02236 18.8662 2.26154 19.43 2.68522 19.8462C3.1089 20.2625 3.68278 20.4974 4.28195 20.5H13.3297C13.9289 20.4974 14.5028 20.2625 14.9264 19.8462C15.3501 19.43 15.5893 18.8662 15.5919 18.2776V4.94391H2.01977V18.2776ZM16.722 1.61122H12.7637L11.6326 0.5H5.9781L4.84701 1.61122H0.888672V3.83366H16.722V1.61122Z"
                                                fill="#E4002B" />
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                                {% if i != itinerary.getPlaces()| length - 1 %}
                                <button class="btn-addPlan btn-addColor" onclick="openRecommendTab(parseInt('{{i+1}}'), this);">  +  </button>
                                {% elif not itinerary.getEnd() %}
                                <button class="btn-addPlan btn-addColor" onclick="recommend(1, parseInt('{{i+1}}'), this);">  +  </button>
                                {% endif %}
                            {% endfor %}
                            <hr>
                            <!-- explorerdirections -->
                            <div class="explorerdirections">
                                <div class="explorertransport">
                                </div>

                                <!-- explorertravelduration -->
                                <div class="explorertravelduration">
                                <h1><span class="plan-travel-duration">{{itinerary.getPlaces()[i].TotalDuration|int}}</span>min</h1>
                                <h2 onclick="showExpandedRoute">Details <svg width="9" height="5" viewBox="0 0 9 5" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                        d="M0.78125 0.657445C0.862652 0.406133 1.05557 0.252445 1.23283 0.0900984C1.37284 -0.0380473 1.60198 -0.0213795 1.74749 0.102437C1.78154 0.132408 1.81395 0.164424 1.84456 0.198329C2.79981 1.21383 3.75459 2.2299 4.70889 3.24655C4.73025 3.27304 4.74965 3.30127 4.76688 3.33097C4.80453 3.29266 4.82794 3.27079 4.84829 3.24785C5.81073 2.22441 6.7731 1.20098 7.7354 0.177549C7.90716 -0.00492803 8.11881 -0.0605592 8.29077 0.0760284C8.44962 0.204574 8.59127 0.355537 8.71182 0.524754C8.82497 0.681473 8.79159 0.89274 8.67112 1.04773C8.65301 1.0711 8.63367 1.09383 8.61352 1.11526L5.12668 4.82564C4.95309 5.0105 4.74959 5.05076 4.56134 4.93495C4.51708 4.90599 4.47652 4.87107 4.44067 4.83105C3.27391 3.59 2.1079 2.34859 0.942629 1.10682C0.874048 1.03322 0.834365 0.930405 0.78125 0.84014L0.78125 0.657445Z"
                                        fill="#E4002B" />
                                    </svg>
                                </h2>
                                </div>
                            </div>
                            <hr>

                            <button class="btn-addPlan btn-addColor" onclick="openRecommendTab(parseInt('{{i+1}}'));">  +  </button>
                            <hr>

                            <div class="explorerend">
                                <div class="explorerendpoint">
                                    <svg width="31" height="31" viewBox="0 0 31 31" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path
                                        d="M0.333984 15.9771C0.333984 13.0103 1.21372 10.1102 2.86194 7.6435C4.51016 5.17677 6.85284 3.25418 9.59373 2.11886C12.3346 0.98355 15.3506 0.6865 18.2603 1.26528C21.17 1.84406 23.8428 3.27267 25.9406 5.37046C28.0384 7.46824 29.467 10.141 30.0458 13.0507C30.6245 15.9604 30.3275 18.9764 29.1922 21.7173C28.0569 24.4582 26.1343 26.8009 23.6675 28.4491C21.2008 30.0973 18.3007 30.9771 15.334 30.9771C13.3642 30.9771 11.4136 30.5891 9.59373 29.8352C7.77385 29.0814 6.12026 27.9765 4.72738 26.5837C1.91434 23.7706 0.333984 19.9553 0.333984 15.9771ZM15.334 24.9771C17.114 24.9771 18.8541 24.4492 20.3341 23.4603C21.8142 22.4713 22.9677 21.0657 23.6489 19.4212C24.3301 17.7767 24.5083 15.9671 24.161 14.2212C23.8138 12.4754 22.9566 10.8718 21.6979 9.6131C20.4393 8.35442 18.8356 7.49726 17.0898 7.14999C15.344 6.80272 13.5344 6.98095 11.8898 7.66214C10.2453 8.34333 8.83969 9.49688 7.85076 10.9769C6.86182 12.457 6.33398 14.197 6.33398 15.9771C6.33398 18.364 7.28219 20.6532 8.97002 22.341C10.6578 24.0288 12.947 24.9771 15.334 24.9771Z"
                                        fill="#E4002B" />
                                    </svg>
                                    <h1 class="plan-name">{{itinerary.getPlaces()[i].Name}}</h1>
                                    <p class="plan-address" hidden>{{itinerary.getPlaces()[i].Address}}</p>
                                    <p class="plan-latlng" hidden>{{itinerary.getPlaces()[i].Latlng}}</p>
                                    <p class="plan-total-duration" hidden>{{itinerary.getPlaces()[i].TotalDuration|int}}</p>
                                </div>
                                <div class="explorerendtime">
                                    <h1 class="plan-timing"></h1>
                                </div>
                            </div>
                            {% if not itinerary.getEnd() %}
                            <button class="btn-addColor end-location" onclick="openSearch(this, '{{i+1}}');">+ Add end Location</button>
                            {% endif %}
                        {% endif %}
                    </div>

                    <!-- viewonmap -->
                    <div class="viewonmap" onclick="openMapView();">
                        <svg width="51" height="50" viewBox="0 0 51 50" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <rect x="0.888672" width="50" height="50" rx="5" fill="#2B2B2B" />
                        <path
                            d="M14.0286 37.4989C13.5494 37.3388 13.3875 36.9977 13.3887 36.5057C13.3978 31.8787 13.3942 27.2517 13.3942 22.6247C13.3942 22.0306 13.5311 21.8228 14.0714 21.6064C16.3617 20.6896 18.6526 19.7733 20.9434 18.8571H20.9459C21.0693 18.807 21.2032 18.8993 21.2032 19.0319V19.0417C21.2032 24.1894 21.202 29.3366 21.2081 34.4843C21.2081 34.6873 21.1445 34.7777 20.9599 34.8505C18.787 35.7117 16.6172 36.5808 14.4473 37.4494C14.4192 37.4604 14.396 37.4824 14.3703 37.4995H14.0286V37.4989Z"
                            fill="white" />
                        <path
                            d="M37.8765 19.9487C37.2017 21.602 36.1015 23.025 35.0227 24.4571C34.5581 25.0732 34.0484 25.6557 33.5472 26.2437C33.1823 26.6722 32.6658 26.6813 32.3021 26.2645C30.9116 24.6679 29.6042 23.0091 28.5565 21.1613C28.1225 20.3967 27.7399 19.607 27.551 18.7409C27.3255 17.7079 27.4954 16.7128 27.9251 15.7697C28.6892 14.0925 29.9892 13.0467 31.7838 12.628C34.3045 12.0406 37.0898 13.5302 37.9847 15.9598C38.0152 16.0435 38.0434 16.1279 38.0696 16.2128C38.4437 17.4396 38.3618 18.7611 37.8771 19.9487H37.8765ZM32.9078 20.3154C34.1835 20.324 35.2543 19.2574 35.2568 17.9762C35.2592 16.7061 34.2177 15.6548 32.9366 15.6328C31.667 15.6114 30.5907 16.6725 30.5754 17.9597C30.5601 19.2323 31.6243 20.3062 32.9078 20.3154Z"
                            fill="white" />
                        <path
                            d="M30.5742 37.1345V27.3525C30.5742 27.111 30.8762 27.0022 31.0302 27.1874L31.0345 27.1923C31.4098 27.644 31.8682 27.9674 32.4519 28.0762C33.3296 28.24 34.082 27.9869 34.6749 27.325C35.6945 26.1856 36.6498 24.9931 37.5086 23.7267C37.6437 23.528 37.7769 23.3282 37.9102 23.1283C38.052 22.9156 38.3832 23.0158 38.3832 23.2713V33.9256C38.3832 33.9653 38.3784 34.0044 38.3649 34.0417C38.2543 34.3547 38.0159 34.5295 37.706 34.6517C36.137 35.2703 34.5716 35.898 33.0069 36.527C32.3132 36.8057 31.6225 37.0905 30.9306 37.3741C30.7606 37.4438 30.5742 37.3185 30.5742 37.1351V37.1345Z"
                            fill="white" />
                        <path
                            d="M22.766 19.0019C22.766 18.8846 22.8846 18.8045 22.9934 18.8479C23.1578 18.9133 23.3124 18.9744 23.4671 19.0362C24.3717 19.3974 25.2769 19.7562 26.1785 20.1235C26.2738 20.1626 26.3887 20.2378 26.4248 20.3246C27.0391 21.8154 27.9021 23.1601 28.8434 24.4577C28.9553 24.6118 29.0158 24.797 29.0158 24.987C29.0109 28.9655 29.0121 32.944 29.0121 36.9225V36.997C29.0121 37.1144 28.8935 37.1975 28.7841 37.1541H28.7823C26.8459 36.3791 24.9108 35.601 22.972 34.8327C22.8094 34.7685 22.7611 34.6872 22.7617 34.5167C22.7666 29.3451 22.7654 24.1735 22.7654 19.0019H22.766Z"
                            fill="white" />
                        </svg>
                
                    </div>

                    <button class="btn btn-primary" id="next-recommend-btn" onclick="nextRecommend();">Next</button>
                </div>
                {% endfor %}
            {% endif %}
        </div>
    </section>

    <!-- Search Page -->
    <div class="device" id="searchTab" style="position: absolute; z-index:2; background-color: white; display: none; bottom: -200vh;">
        <input type="text" class="form-control" id="searchBar" onkeyup="pauseSearch();" autocomplete="off">
        <div id="searchPage" hidden>1</div>
        <div id="search-btnId" hidden></div>
        <div id="search-divOrder" hidden></div>
        <div class="dropdown-item" id="start" onclick="addSE(this);">
            <p style="font-size: 14px; margin-bottom: 3px; font-weight: bold;">Your Location</p>
            <p style="font-size: 11px; max-width: 100%; overflow: auto; margin-bottom: 3px; display: none;">Current Location</p>
            <p id="start-latlng" hidden></p>
        </div>
        <div id="search-results">
        </div>
    </div>
    
    <!-- Recommendation tab -->
    <div class="device" id="recommendationTab" style="position: absolute; z-index:2; background-color: white; display: none; bottom: -200vh;">
        <div id="sectionIndex" hidden></div>
        <!-- header -->
        <div class="explorerheader">
            <svg width="12" height="20" onclick="closeRecommendTab();">
            <path
                d="M10.2642 0C10.8582 0.203504 11.2215 0.68581 11.6052 1.12894C11.9081 1.47897 11.8687 2.05183 11.5761 2.4156C11.5052 2.50072 11.4295 2.58174 11.3494 2.65828C8.94914 5.0464 6.54751 7.43334 4.14452 9.81909C4.0819 9.87251 4.01519 9.92099 3.94498 9.96409C4.03554 10.0582 4.08722 10.1167 4.14145 10.1676C6.56048 12.5737 8.9795 14.9796 11.3985 17.3854C11.8298 17.8148 11.9613 18.3439 11.6385 18.7738C11.3346 19.1709 10.9778 19.5251 10.5779 19.8264C10.2074 20.1093 9.70807 20.0259 9.34174 19.7247C9.28648 19.6794 9.23276 19.6311 9.18211 19.5807L0.412125 10.8636C-0.0248138 10.4296 -0.119978 9.92084 0.153748 9.45024C0.222198 9.33957 0.304744 9.23817 0.399334 9.14854C3.33272 6.23165 6.26697 3.31661 9.20206 0.403448C9.37602 0.231995 9.61905 0.132787 9.8324 0H10.2642Z"
                fill="#2B2B2B" />
            </svg>
            <h1>Edit Plan</h1>
            <svg onclick="document.getElementById('recommendSearch').style.display = 'block';" width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path
                d="M0.773438 8.20312V9.29688C0.829688 9.68802 0.867708 10.0828 0.944792 10.4703C1.69479 14.225 4.80156 17.0578 8.6276 17.45C10.6422 17.6568 12.5146 17.2036 14.2292 16.1182C14.3974 16.0115 14.5609 15.8979 14.7516 15.7708C14.8031 15.8349 14.8427 15.8958 14.8938 15.9458C16.0599 17.0984 17.2307 18.2464 18.3917 19.4042C18.6635 19.675 18.9448 19.913 19.3281 20H19.7188C19.8984 19.9188 20.0901 19.8562 20.2547 19.7521C20.5469 19.5672 20.6839 19.2682 20.7734 18.9453V18.5156C20.6651 18.1245 20.3984 17.8469 20.1198 17.5703C18.974 16.4339 17.8354 15.2896 16.6943 14.1484C16.6406 14.0948 16.5896 14.0385 16.5438 13.9901C16.5568 13.9573 16.5599 13.9443 16.5667 13.9339C16.5995 13.8854 16.6339 13.838 16.6677 13.7901C17.9063 12.0109 18.4297 10.0365 18.2224 7.88333C18.0396 5.98698 17.3 4.31823 16.0214 2.90365C14.6906 1.43229 13.0453 0.507812 11.0891 0.152083C10.7391 0.0885417 10.3839 0.05 10.0312 0C9.69271 0 9.35417 0 9.01562 0C8.96563 0.0109375 8.91563 0.0291667 8.8651 0.0322917C7.66771 0.114063 6.53125 0.426042 5.4776 0.997396C3.00156 2.34062 1.47344 4.39531 0.924479 7.16458C0.85677 7.50729 0.822917 7.85729 0.773438 8.20312ZM3.27344 8.75052C3.27344 5.30208 6.0724 2.50104 9.51979 2.50156C12.9656 2.50156 15.7698 5.30469 15.7698 8.74948C15.7698 12.1937 12.9646 14.999 9.52083 14.9984C6.0724 14.9979 3.27396 12.1995 3.27344 8.75052Z"
                fill="#2B2B2B" />
            </svg>
        </div>

        <section id="recommendPage" class="homecontent">
            <div class="categories">
                <div id="selectedCat" hidden>Eateries</div>
                <ul id="categories">
                    {% for cat in catInfo %}
                    <li>
                        <div class="categoriesbutton">
                            <svg>
                            </svg>
                        </div>
                        <p>{{cat}}</p>
                    </li>
                    {% endfor %}
                    {% for i in range(8 - catInfo|length) %}
                    <li>
                        <div class="categoriesbutton">
                            <svg>
                            </svg>
                        </div>
                        <p>Lorem</p>
                    </li>
                    {% endfor %}
                </ul>
            </div>
            
            <div id="recommendcon">
                <div class="sectionheader manyheadertags">
                    <div>
                        <h1>Recommended For You</h1>
                        <h2>Specially tailored for you!</h2>
                    </div>
            
                    <div class="view">
                        <h3>View All</h3>
                    </div>
                </div>
        
                <div id="recommend-main" class="plan-choices-list maincardcon attractionscon">
                </div>
            
                <!-- Places Near You -->
                <div class="sectionheader manyheadertags">
                    <div>
                        <h1>Places Near You</h1>
                        <h2>We thought you might like...</h2>
                    </div>
            
                    <div class="view">
                        <h3>View All</h3>
                    </div>
                </div>
        
                <div id="recommend-ratings" class="plan-choices-list maincardcon attractionscon">
                </div>
        
                <!-- Recommended By Us -->
                <div class="sectionheader manyheadertags">
                    <div>
                        <h1>Recommended By Us</h1>
                        <h2>We thought you might like...</h2>
                    </div>
            
                    <div class="view">
                        <h3>View All</h3>
                    </div>
                </div>
        
                <div id="recommend-partners" class="plan-choices-list maincardcon attractionscon">
                </div>
            </div>
        </section>

        <section id="recommendSearch" class="device" style="position:absolute; z-index: 4; display: none;">
            <div id="search">
                <div class="searchheader">
                  <svg onclick="document.getElementById('recommendSearch').style.display = 'none';" width="12" height="20" viewBox="0 0 12 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M10.2642 0C10.8582 0.203504 11.2215 0.68581 11.6052 1.12894C11.9081 1.47897 11.8687 2.05183 11.5761 2.4156C11.5052 2.50072 11.4295 2.58174 11.3494 2.65828C8.94914 5.0464 6.54751 7.43334 4.14452 9.81909C4.0819 9.87251 4.01519 9.92099 3.94498 9.96409C4.03554 10.0582 4.08722 10.1167 4.14145 10.1676C6.56048 12.5737 8.9795 14.9796 11.3985 17.3854C11.8298 17.8148 11.9613 18.3439 11.6385 18.7738C11.3346 19.1709 10.9778 19.5251 10.5779 19.8264C10.2074 20.1093 9.70807 20.0259 9.34174 19.7247C9.28648 19.6794 9.23276 19.6311 9.18211 19.5807L0.412125 10.8636C-0.0248138 10.4296 -0.119978 9.92084 0.153748 9.45024C0.222198 9.33957 0.304744 9.23817 0.399334 9.14854C3.33272 6.23165 6.26697 3.31661 9.20206 0.403448C9.37602 0.231995 9.61905 0.132787 9.8324 0H10.2642Z"
                      fill="#2B2B2B" />
                  </svg>
            
                  <h1>Search</h1>
            
            
                  <svg onclick="window.open('saved.html','_self')" width="15" height="20" viewBox="0 0 15 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path
                      d="M12.8569 0H2.14312C1.57629 0.00205569 1.03339 0.237205 0.633538 0.653854C0.233688 1.0705 0.00954761 1.63462 0.0102946 2.22244L0 20L7.5 16.6663L15 20V2.22244C14.9975 1.6338 14.771 1.06999 14.3696 0.653759C13.9682 0.237523 13.4245 0.00255379 12.8569 0V0Z"
                      fill="#2B2B2B" />
                  </svg>
                </div>
            
                <input type="text" id="recSearchBar" class="Username" value="" onkeyup="recSearch();" placeholder="Search Activities, Restaurants, Cafes" autocomplete="off">
            
                <div id="recSearch-results" class="searchcardscon">
                    <div style="position: relative; right: 5px;" class="sectionheader recentheader">
                        <h1>Recent Searches</h1>
                        <h3>Clear</h3>
                    </div>
                    <div id="recSearch-results-recent">
                        {% for i in range(recentSearches|length) %}
                        <div class="recentcards searchcard">
                            <div class="cardimg" style="background-image: url('{{recentInfo[i].Image_url}}');">
                            </div>
                    
                            <div class="cardinfo">
                                <h1 class="recentname">{{recentSearches[i].getPlaceName()}}</h1>
                                <div class="recenttype">
                                    <h3 class="recentcat">{{recentSearches[i].getCategory()}}</h3>
                                    <div class="rating">
                                        {% for rating in range(recentInfo[i]["Rating"]|round) %}
                                        <svg width="12" height="12" fill="none">
                                            <rect x="0.5" y="0.5" width="11" height="11" rx="1.5" stroke="#E4002B" />
                                        </svg>
                                        {% endfor %}
                                        {% for rating in range(5 - recentInfo[i]["Rating"]|round) %}
                                        <svg width="12" height="12" fill="none">
                                            <rect x="0.5" y="0.5" width="11" height="11" rx="1.5" stroke="#C4C4C4" />
                                        </svg>
                                        {% endfor %}
                                        <p class="ratingvalue">{{recentInfo[i]["Review_no"]}}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    <div style="position: relative; right: 5px;" class="sectionheader resultsheader" style="display: none;">
                        <h1>Results</h1>
                    </div>
                    <div id="recSearch-results-results" style="display: none;">

                    </div>
                </div>
            
            </div>
        </section>
    </div>

    <!-- Map View -->
    <div class="device" id="mapView" style="position: fixed; z-index:-2;">
        <div id='mapdiv' style='height:80vh;'></div>
        <div id="map-selection" style="height:20vh; z-index:-1; overflow-x: auto;">
            <button class="btn-addColor" onclick="dismissMapView();">x</button>
            <div id="map-sections" style="display: inline; overflow-x: auto; overflow-y: auto;">

            </div>
        </div>
    </div>

    <!-- Popup -->
    <div id="changesPopup" style="display: none; position: absolute; top: 50%;">
        <p id="changes-text">You've changed the starting date of your itinerary. What action do you wish to perform ?</p>
        <p class="text-primary" onclick="dateChangesAction(1)">Leave itinerary in their respective pages</p>
        <p class="text-danger" onclick="dateChangesAction(2)">Reset itinerary</p>
    </div>

    <form method="POST">
        <input id="planner-id" name="plannerId" value="{% if itineraries != None %}{{itineraries[0].getPlannerId()}}{% endif %}" hidden readonly>
        <input type="submit" value="Review Trip" class="btn btn-primary">
    </form>
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
    var skipped = [0];
    var pendingChooseList = {};
    var startTime = new Date("2022-01-01T08:00:00");
    var originalDuration;
    const currentTime = new Date();

    var requests = [];

    function initFunctions() {
        getLocation();
        const todayDate = currentTime.toISOString().split("T")[0]
        document.getElementById("startDate").min = todayDate;
        document.getElementById("startDate").value = todayDate;

        document.getElementById("endDate").min = todayDate;

        toggleDay(0);
        initAllowance();
        reAssignValues();
    }
    function initAllowance() {
        // Set time allowance
        var startTmeArr = ["08", "00"];
        var endTmeArr = ["23", "59"];
        var startDate = new Date(0, 0, 0, startTmeArr[0], startTmeArr[1], 0);
        var endDate = new Date(0, 0, 0, endTmeArr[0], endTmeArr[1], 0);
        var diff = endDate.getTime() - startDate.getTime();
        var allowanceLeft = Math.floor(diff / 1000 / 60);

        var allSections = document.getElementsByClassName("planSection");
        for (var i=0; i<allSections.length; i++) {
            if (allSections[i].querySelector(".time-left").querySelector("span").innerText.length > 0)
                allSections[i].querySelector(".time-left").querySelector("span").innerText = allowanceLeft;
        }
    }

    function openInitPage() {
        $("#initForm").show();
        $("#initForm").animate({
            top: "0",
            bottom: "0"
        });
        checkInitPage();
    }

    function checkInitPage() {
        console.log("Here")
        var valid = true;
        var initDiv = document.getElementById("initForm");
        var allInps = initDiv.getElementsByTagName("input");
        var nextBtn = document.getElementById("initPageNext");

        for (var i=0; i<allInps.length; i++) {
            if (allInps[i].id != "description") {
                if (allInps[i].value.trim() == "") {
                    valid = false;
                    break;
                }
            }
        }

        var startDateVal = $("#startDate").val();
        if (isNaN(Date.parse(startDateVal)))
            valid = false;
        if (isNaN(Date.parse(endDate.value)))
            valid = false;

        if (valid) {
            nextBtn.setAttribute("onclick", "dismissInit();")
            nextBtn.classList.remove("maincta-disabled");
            nextBtn.classList.add("maincta");
        }
        else {
            nextBtn.removeAttribute("onclick");
            nextBtn.classList.remove("maincta");
            nextBtn.classList.add("maincta-disabled");
        }
    }
    var oldVal;
    function checkResetEndDate() {
        var startDateVal = $("#startDate").val();
        var endDateVal = $("#endDate").val();

        if (startDateVal.trim()) {
            if (startDateVal != oldVal) {
                $("#endDate").val("");
                $("#endDate").attr("min", new Date(startDateVal).toISOString().split("T")[0]);
                oldVal = startDateVal;
            }
        }
    }
    async function dismissInit() {
        var initDiv = document.getElementById("initForm");
        var datesDiv = document.getElementById("dates-selection");
        var plansDiv = document.getElementById("planPage");
        var firstDiv = document.getElementById("firstSelection");
        var startDate = new Date($("#startDate").val());
        var endDate = new Date($("#endDate").val());

        var days = Math.ceil((endDate.getTime() - startDate.getTime()) / (1000 * 3600 * 24)) + 1;
        var datesSelection = document.querySelector("#dates-selection");
        var dateCards = [].slice.call(document.getElementsByClassName("card-date"));
        var diff = days - dateCards.length;
        
        if (dateCards.length > 0) {
            // Prompt for action
            if (startDate > new Date(dateCards[0].querySelector("h5").innerText)) {
                $("#changesPopup").fadeIn(150);
            }

            datesSelection.innerHTML = 
            `<div class="card" id="card-date-add" onclick="openInitPage();" style="width: 100px;">
                <h5>+ Add day</h5>
            </div>`;
        }

        // Pull form down
        $("#initForm").animate({
            bottom: "-200vh"
        }, 350, function() {
            $("#initForm").hide();
        });
        $("#planPage").show();

        var checkDate = startDate;
        for (var i=0; i<days; i++) {
            await new Promise(resolve => setTimeout(resolve, 150));
            var cardDate = new DOMParser().parseFromString(`
            <div class="card card-date" style="width: 150px;" onclick="toggleDay(this);">
                <h5>${checkDate.toISOString().slice(0, 10)}</h5>
                <p class="tm-selection">drive<span hidden>drive</span></p>
                <ul class="tm" style="display: block;">
                    <li onclick="chooseTransportMode(this);">Drive<span hidden>drive</span></li>
                    <li onclick="chooseTransportMode(this);">Public Transport<span hidden>pt</span></li>
                    <li onclick="chooseTransportMode(this);">Bus<span hidden>bus</span></li>
                    <li onclick="chooseTransportMode(this);">Walk<span hidden>walk</span></li>
                    <li onclick="chooseTransportMode(this);">Cycle<span hidden>cycle</span></li>
                </ul>
            </div>`, "text/html").body.firstElementChild;

            datesDiv.insertBefore(cardDate, document.querySelector("#card-date-add"));
            checkDate.setDate(checkDate.getDate() + 1);  
        }

        datesDiv.querySelector(".card-date").classList.add("addColor");

        // Add days card
        var plansSec = new DOMParser().parseFromString(
        `<div class="device planSection" style="display: none;">
            <div class="float-right">
                <a href="/itinerary/showTrip">Map</a>
            </div>

            <div class="time-left">Duration left: <span></span></div>
            <div class="transport-text">Transport mode: </div>

            <div class="recommendation-listings">
                <button class="btn-addColor start-location" onclick="openSearch(this, '1');">+ Add start Location</button>
            </div>
        </div>`, "text/html").body.firstElementChild.cloneNode(true);
        var allSections = document.getElementsByClassName("planSection");
        for (var i=0; i<Math.abs(diff); i++) {
            if (diff > 0) {
                var clonedPlansSec = plansSec.cloneNode(true);
                clonedPlansSec.style.display = "none";
                plansDiv.appendChild(clonedPlansSec);
            }
            else if (diff < 0) {
                // TODO: Change query selector h5 change in the future
                if (startDate > new Date(dateCards[0].querySelector("h5").innerText)) {
                    allSections[i].remove();
                }
                else {
                    allSections[dateCards.length-1].remove();
                }
            }
        }

        plansDiv.querySelector(".planSection").style.display = "block";
        initAllowance();

        saveTrips();
    }

    function dateChangesAction(actionNum) {
        if (actionNum == 2) {
            var div = document.getElementsByClassName("recommendation-listings");
            for (i=0; i<div.length; i++) {
                div.innerHTML = `<button class="btn-addColor start-location" onclick="openSearch(this, '${i+1}');">+ Add start Location</button>`;
            }
        }

        saveTrips();
        $("#changesPopup").fadeOut(150);
    }

    function removeFirstBtn(btn) {
        btn.classList.add("btn-addPlan")
        btn.innerText = " +  ";
    }

    function nextRecommend(pageNum, order, cat, sectionNo, btn) {
        recommend(pageNum+1, order, cat, sectionNo, true);
        btn.remove();
    }

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.watchPosition(showYourPosition, positioningError, {
                timeout: 500,
                enableHighAccuracy: true
            });
        }
    }

    // Choose transport mode
    function chooseTransportMode(btn) {
        var cardDate = btn.closest(".card-date");
        cardDate.querySelector(".tm-selection").innerHTML = btn.innerHTML;

        saveTrips();
    }

    function openRecommendTab(order, btn) {
        // Pull screen up
        $("#recommendationTab").show();
        $("#recommendationTab").animate({
            top: "0",
            bottom: "0"
        }, 350);

        sectionIndex = [].slice.call(document.getElementsByClassName("recommendation-listings")).indexOf(btn.closest(".recommendation-listings"));
        document.getElementById("sectionIndex").innerText = sectionIndex;

        allCat = document.getElementById("categories").getElementsByTagName("li");
        for (var i=0; i<allCat.length; i++) {
            var li = allCat[i];
            li.setAttribute("onclick", `recommend(1, ${order}, '${li.querySelector("p").innerText}')`)
        }
        recommend(1, order, "Eateries");
    }
    function closeRecommendTab() {
        // Pull screen down
        $("#recommendationTab").animate({
            bottom: "-200vh"
        }, 350, function () {
            $("#recommendationTab").hide();
        });
    }
    // Order - the positional order of the button in DOM
    async function recommend(pageNum, order, cat, sectionNo=0, append=false) {
        // Stop pending ajax req
        if (requests.length > 0) {
            while (requests.length > 0) {
                try {
                    requests[0].abort();
                }
                catch (e) {}
                finally {
                    requests.pop(0);
                }
            }
        }

        var sectionIndex = parseInt(document.getElementById("sectionIndex").innerText);

        transportMde = document.getElementsByClassName("tm-selection")[sectionIndex].querySelector("span").innerText;

        div = document.getElementsByClassName("recommendation-listings")[sectionIndex];
        var allCards = div.getElementsByClassName("plan-selection");

        $("#reloadingbg").show();
        console.log(pageNum+", "+order);
        // Get place before, after and registered places
        var registeredPlaces = [].slice.call(allCards).slice(1, allCards.length - 1).map(x => x.querySelector(".plan-address").innerText);
        if (order - 1 > 0) {
            var placeBefore = allCards[order-2].querySelector(".plan-address").innerText;
            var latlng = allCards[order-2].querySelector(".plan-latlng").innerText.split(",");
        }
        else {
            var placeBefore;
            var latlng = allCards[0].querySelector(".plan-latlng").innerText.split(",");
        }
    
        var placeAfter = allCards[order-1].querySelector(".plan-address").innerText;
        startTme = new Date();
        startTme = new Date(startTme.getFullYear(), startTme.getMonth(), startTme.getDate(), 8, 0, 0);
        // TODO
        for (var i=1; i<allCards.length-1; i++) {
            startTme.setTime(startTime.getTime() + parseInt(allCards[i].querySelector(".plan-total-duration").innerText));
        }
        var allowanceLeft = div.closest(".planSection").querySelector(".time-left").querySelector("span").innerText;

        async function fetchDisplay(sectionNo) {
            console.log(startTme.getHours())
            request = await $.ajax({
                type: "POST",
                url: `/funcs/planner-recommend-places?page=${pageNum}`,
                data: {
                    date: currentTime.toISOString().slice(0, 10),
                    startTime: startTme.getHours() + ":" + startTme.getMinutes(),
                    timeLeft: allowanceLeft,
                    latitude: latlng[0],
                    longitude: latlng[1],
                    category: cat,
                    transportMode: transportMde,
                    skipped: JSON.stringify(skipped),
                    placesAdded: registeredPlaces,
                    abovePlace: placeBefore,
                    belowPlace: placeAfter,
                    section: sectionNo
                },
                success: function(result) {
                    cleanedResult = result.replaceAll("\\u", "").replaceAll("NaN", `""`);
                    result = JSON.parse(cleanedResult);

                    listingIndex = [document.getElementById("recommend-main"), document.getElementById("recommend-ratings"), document.getElementById("recommend-partners")]
                    pendingChooseList[sectionNo] = result;
                    listing = listingIndex[sectionNo-1]
                    if (!append)
                        listing.innerHTML = "";

                    if (result.list.length > 0) {
                        for (var i in result.list) {
                            var recommendCard = 
                            `<div class="maincard attractioncard plan-choice" onclick="choosePlace(this, ${sectionNo}, ${order}, ${i});">
                                <div class="cardimg" style="background-image: url('${result.list[i].Image_url}');">
                                </div>
                    
                                <div class="maincardinfo attractioncardinfo">
                                <h1 class="recentname">${result.list[i].Name}</h1>
                    
                                <div class="recenttype">
                                    <h3 class="recentcat">${result.list[i].Category.replace(/,/g, "")}</h3>
                                    <div class="rating">`
                            for (var i=0; i< Math.round(result.list[i].Rating); i++) {
                                recommendCard += 
                                    `<svg width="12" height="12" fill="none">
                                        <rect x="0.5" y="0.5" width="11" height="11" rx="1.5" stroke="#E4002B" />
                                    </svg>`
                            }
                            for (var i=0; i< 5 - Math.round(result.list[i].Rating); i++) {
                                recommendCard +=
                                    `<svg width="12" height="12" fill="none">
                                        <rect x="0.5" y="0.5" width="11" height="11" rx="1.5" stroke="#C4C4C4" />
                                    </svg>`
                            }
                            recommendCard +=
                                `       <p class="ratingvalue">${result.list[i].Review_no}</p>
                                    </div>
                                </div>
                    
                                </div>
                            </div>`;
                            listing.innerHTML += recommendCard;
                        }
                    }
                    else {
                        listing.innerHTML += `<div class="card">There isn't any available places to be added</div>`;
                        var allBtns = div.getElementsByClassName("btn-addPlan");
                        for (var i=0; i<allBtns.length; i++) {
                            allBtns[i].disabled = true;
                            allBtns[i].classList.remove("btn-addColor");
                        }
                    }

                    if (result.list.length == 10)
                        listing.innerHTML += `<p onclick="nextRecommend(${pageNum}, ${order}, '${cat}', ${sectionNo}, this);" class="list-load-more">Load more</p>`;

                    console.log(skipped);
                    
                },
                error: function(jq, status, errorMsg) {
                    div.innerHTML = 
                    `<div class="plan-choices-list">
                        Something went wrong. Try again
                    </div>`;
                },
                complete: function(result) {
                    $("#reloadingbg").hide();
                }
            });

            requests.push(request);
        }

        if (sectionNo == 0) {
            for (var i=1; i<4; i++) {
                fetchDisplay(i)
            }
        }
        else
            fetchDisplay(sectionNo)
    }

    function choosePlace(btn, index, order, itemNo) {
        btn.parentElement.remove();
        sectionIndex = parseInt(document.getElementById("sectionIndex").innerText);
        div = document.getElementsByClassName("recommendation-listings")[sectionIndex];
        var info = pendingChooseList[index].list[itemNo];

        var newPlace = new DOMParser().parseFromString(`
            <div class="card plan-selection">
                <h5 class="plan-name">${info.Name}</h5>
                <p class="plan-address" style="font-size:12px">${info.Address}</p>
                <br />
                <p class="plan-activity-duration"><span>${Math.round(info.ActivityDuration)}</span> min</p>
                <p class="plan-total-duration"><span>${Math.round(info.Duration)}</span> min</p>
                <p class="plan-timing"></p>
                <p class="plan-latlng" hidden>${info.Latlng}</p>
                <p class="plan-edit" onclick="editCard(this, ${order})">Edit</p>
                <p class="plan-delete" onclick="delCard(this, ${order})">Delete</p>
            </div>`, "text/html").body.firstElementChild;
        var newBtn = new DOMParser().parseFromString(`   
            <button class="btn-addPlan btn-addColor" onclick="recommend(1, ${order+1});">  +  </button>`, "text/html").body.firstElementChild;

        var allAddBtns = div.getElementsByClassName("btn-addPlan");
        console.log(order, allAddBtns.length)
        
        div.insertBefore(newBtn, allAddBtns[order-1].nextSibling);
        div.insertBefore(newPlace, allAddBtns[order-1].nextSibling);
        
        var timeLeft = document.getElementsByClassName("time-left")[sectionIndex].querySelector("span");
        var allowanceLeft = timeLeft - info.Duration;
        timeLeft.innerText = allowanceLeft;
        
        // Fill up info for autosaving data
        reCal2Places(div, order);
        reAssignValues();
        saveTrips();

        closeRecommendTab();
    }

    // Edit/delete/rearrange
    async function editCard(btn, order) {
        var card = btn.closest(".plan-selection");
        var timeLeft = card.parentElement.parentElement.querySelector(".time-left").querySelector("span");
        card.closest(".recommendation-listings").getElementsByClassName("btn-addPlan")[order-1].remove();
        reAssignValues();

        timeLeft.innerText = parseInt(timeLeft.innerText) + parseInt(card.querySelector(".plan-total-duration").querySelector("span").innerText);
        openRecommendTab(order-1);
        card.remove();
    }

    function delCard(btn, order) {
        var card = btn.closest(".plan-selection");
        
        var div = btn.closest(".recommendation-listings");
        div.getElementsByClassName("btn-addPlan")[order-1].remove();
        var timeLeft = div.parentElement.querySelector(".time-left").querySelector("span");
        timeLeft.innerText = parseInt(timeLeft.innerText) + parseInt(card.querySelector(".plan-total-duration").querySelector("span").innerText);
        card.remove();

        reAssignValues();
        reCal2Places(div, order-1);
    }

    // Recalculate route and travel time
    async function reCal2Places(div, order) {
        var cards = div.getElementsByClassName("plan-selection");
        var index = [].slice.call(document.getElementsByClassName("recommendation-listings")).indexOf(div);
        var aboveCard = cards[order-1];
        var belowCard = cards[order];
        var totalDuration = 0;
        for (var i=1; i<order-1; i++) {
            var duration = parseFloat(cards[i].querySelector(".plan-total-duration").querySelector("span").innerText);
            totalDuration += duration;
        }
        var divDate = new Date($("#startDate").val());
        divDate = new Date(divDate.setDate(divDate.getDate() + (order-1)));

        await $.ajax({
            type: "POST",
            url: `/funcs/reCalculate`,
            data: {
                latlngs: [aboveCard.querySelector(".plan-latlng").innerText, belowCard.querySelector(".plan-latlng").innerText],
                routeType: document.getElementsByClassName("tm-selection")[index].innerText,
                date: divDate.toISOString().slice(0, 10),
                topDuration: totalDuration,
                startTime: aboveCard.querySelector(".plan-timing").innerText
            },
            success: function(result) {
                result = JSON.parse(result);
                var belowCardTDuration = belowCard.querySelector(".plan-total-duration").querySelector("span");
                var belowCardADuration = belowCard.querySelector(".plan-activity-duration").querySelector("span");
                var timeDiff = result[0] + parseInt(belowCardADuration.innerText) - parseInt(belowCardTDuration.innerText);
                belowCardTDuration.innerText = parseInt(belowCardADuration.innerText) + result[0];
                div.parentElement.parentElement.querySelector(".time-left").querySelector("span").innerText = parseInt(div.parentElement.parentElement.querySelector(".time-left").querySelector("span").innerText) + timeDiff;
            }
        })

        saveTrips();
    }

    function reAssignValues() {
        var div = document.getElementsByClassName("recommendation-listings");

        for (var i=0; i<div.length; i++) {
            var btn = div[i].getElementsByClassName("btn-add-place");
            for (var j=0; j<btn.length; j++) {
                btn[j].setAttribute("onclick", `recommend(1, ${j+1}, this);`);
            }

            var plansCards = div[i].getElementsByClassName("plan-selection");

            var startTme = startTime;
            var currTime = startTme.toLocaleTimeString('en-SG', {hour12: false})
            if (plansCards.length > 0) {
                plansCards[0].querySelector(".plan-timing").innerText = currTime.substring(0, currTime.length-3);
                for (var j=1; j<plansCards.length-1; j++) {
                    startTme.setTime(startTme.getTime() + parseInt(plansCards[j].querySelector(".plan-total-duration").querySelector("span").innerText)*60000);

                    currTime = startTime.toLocaleTimeString('en-SG', {hour12: false})
                    plansCards[j].querySelector(".plan-timing").innerText = currTime.substring(0, currTime.length-3);
                }
            }

        }
    }

    async function saveTrips() {
        var div = document.getElementsByClassName("recommendation-listings");
        var cardDates = document.getElementsByClassName("card-date");
        var checkDate = new Date($("#startDate").val());

        var plannerIdStr = document.querySelector("#planner-id").value; 
        if (plannerIdStr.trim().length == 0)
            plannerIdStr = ([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g, c => (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16));
        document.querySelector("#planner-id").value = plannerIdStr;

        async function reset() {
            await $.ajax({
                type: "POST",
                url: `/funcs/clear-planner?id=${$("#planner-id").val()}`,
                data: {},
                success: function(result) {
                    console.log("System: Reset planner. Waiting for new planner ...");
                }
            });
        }
        async function save(index) {
            await $.ajax({
                type: "POST",
                url: `/funcs/save-trip`,
                data: {
                    tripType: "Planner",
                    tripName: "Hello",
                    date: checkDate.toISOString().slice(0, 10),
                    names: placesName,
                    addresses: placesAddress,
                    categories: placesCategory,
                    images: placesImg,
                    activityDuration: placesActivityDuration,
                    duration: placesDuration,
                    latlngs: placesLatlng,
                    description: $("#description").val(),
                    transportMode: cardDates[index].querySelector(".tm-selection").querySelector("span").innerText,
                    confirmed: false,
                    status: "Planning",
                    plannerId: plannerIdStr,
                    hasEnd: hasE
                },
                success: function(result) {
                    result = JSON.parse(result);
                    document.querySelector("#planner-id").value = result.plannerId;
                    console.log("System: Trip "+(index+1)+" saved.");
                }
            });
        }

        reset();
        for (var i=0; i<div.length; i++) {
            // Update db function
            var allPlacesDiv = div[i].getElementsByClassName("plan-selection");
            var placesName = [];
            var placesAddress = [];
            var placesActivityDuration = [];
            var placesCategory = [];
            var placesImg = [];
            var placesDuration = [];
            var placesLatlng = [];

            var hasE = false;
            if (allPlacesDiv.length > 0) {
                hasE = allPlacesDiv[allPlacesDiv.length-1].classList.contains("end")
            }

            for (var j=0; j<allPlacesDiv.length; j++) {
                placesName.push(allPlacesDiv[j].querySelector(".plan-name").innerText);
                placesAddress.push(allPlacesDiv[j].querySelector(".plan-address").innerText);
                if (i == 0 || (i == allPlacesDiv.length-1 && hasE)) {
                    placesCategory.push(null);
                    placesImg.push(null);
                    placesActivityDuration.push(null);
                    placesDuration.push(null);
                }
                else {
                    placesCategory.push(allPlacesDiv[i].querySelector(".plan-category").innerText);
                    placesImg.push(allPlacesDiv[i].querySelector(".plan-img").querySelector("span").innerText);
                    placesActivityDuration.push(parseInt(allPlacesDiv[j].querySelector(".plan-activity-duration").querySelector("span").innerText));
                    placesDuration.push(parseInt(allPlacesDiv[j].querySelector(".plan-total-duration").querySelector("span").innerText));
                }
                placesLatlng.push(allPlacesDiv[j].querySelector(".plan-latlng").innerText);
            }

            await save(i);

            checkDate.setDate(checkDate.getDate() + 1);
        }
    }

    var canSearch = true;
    var dropdownCooldown = false;

    // Searching - for adding start and end location
    function openSearch(btn, order) {
        // Pull screen up
        $("#searchTab").show();
        $("#searchTab").animate({
            top: "0",
            bottom: "0"
        }, 350, function () {
            document.querySelector("#searchBar").focus();
        });
        var btnClassList = btn.classList;
        var idClass;
        for (var i=0; i<btnClassList.length; i++) {
            if (btnClassList[i].substring(btnClassList[i].length - 9, btnClassList[i].length) == "-location") {
                idClass = btnClassList[i];
                break;
            }
        }

        $("#search-btnId").text(idClass);
        $("#search-divOrder").text(order);
    }
    function closeSearch() {
        // Pull screen down
        $("#searchTab").animate({
            bottom: "-200vh"
        }, 350, function() {
            $("#searchTab").hide();
        });
    }

    function pauseSearch() {
        canSearch = false;
        setTimeout(function() {
            canSearch = true;
            search();
        }, 350);
    }
    
    function search() {
        if (canSearch) {
            var dropdownMenu = document.querySelector("#search-results");
            const search = document.querySelector("#searchBar").value;
            const pageNum = $("#searchPage").val()

            if (!search.trim()) {
                dropdownMenu.innerHTML = "";
            }
            else {
                $.ajax({
                    url: `https://developers.onemap.sg/commonapi/search?searchVal=${search}&returnGeom=Y&getAddrDetails=Y&pageNum=${pageNum}`,
                    success: function(result) {
                        dropdownMenu.innerHTML = "";
                        if (result.results.length > 0) {
                            dropdownMenu.style.display = "block";
                            showLength = 10;
                            if (result.results.length < 10) {
                                showLength = result.results.length;
                            }

                            for (var i=0; i<showLength; i++) {
                                dropdownCooldown = true;
                                record = result.results[i]
                                dropdownMenu.innerHTML += `
                                <div class="dropdown-item" onclick="addSE(this);">
                                    <p style="font-size: 14px; margin-bottom: 3px; font-weight: bold;">${capitalize(record.SEARCHVAL)}</p>
                                    <p style="font-size: 11px; max-width: 100%; overflow: auto; margin-bottom: 3px;">${capitalize(record.ADDRESS)}</p>
                                    <p hidden>${record.LATITUDE},${record.LONGITUDE}</p>
                                </div>`;

                                setTimeout(function () { dropdownCooldown = false; }, 126)
                            }
                        }
                        else {
                            dropdownMenu.innerHTML = `<div class="dropdown-item">No results found</div>`; 
                        }
                    }
                });
            }

        }     
    }

    function searchNextPage() {
        $("#searchPage").text(parseInt($("#searchPage").text()) + 1)
    }

    function addSE(card) {
        var btnId = $("#search-btnId").text();
        var divOrder = parseInt($("#search-divOrder").text());
        var div = document.getElementsByClassName("recommendation-listings")[divOrder-1];
        var btn = div.querySelector(`.${btnId}`);
        
        var allP = card.getElementsByTagName("p");
        var newCard = new DOMParser().parseFromString(
            `<div class="card plan-selection">
                <h5 class="plan-name">${allP[0].innerText}</h5>
                <p class="plan-address" style="font-size:12px">${allP[1].innerText}</p>
                <br />
                <p class="plan-latlng" hidden>${allP[2].innerText}</p>
            </div>`, "text/html").body.firstElementChild;

        if (btnId == "start-location") {
            newCard.classList.add("start");
        }
        else
            newCard.classList.add("end");

        div.replaceChild(newCard, btn);
        if (btnId == "start-location") 
            div.innerHTML += 
                `<button class="btn-addColor" onclick="removeFirstBtn(this); recommend(1, 1, this);">+ Add a place</button>
                <button class="btn-addColor end-location" onclick="openSearch(this, '${divOrder}');">+ Add end Location</button>`;

        closeSearch();
        saveTrips();
    }

    function toggleDay(card) {
        var dateCards = document.getElementsByClassName("card-date");
        var index = card;
        if (!Number.isInteger(card))
            index = [].slice.call(dateCards).indexOf(card);
        var planSections = document.getElementsByClassName("planSection");

        for (var i=0; i<dateCards.length; i++) {
            if (i == index) {
                planSections[i].style.display = "block";
                dateCards[i].classList.add("addColor");
            }
            else {
                planSections[i].style.display = "none";
                dateCards[i].classList.remove("addColor");
            }
        }

        
    }

    // Map settings
    // Map display init
    const apiKey = "{{apiKey}}";
    L.Icon.Default.imagePath = "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/images";
    var center = L.bounds([1.56073, 104.11475], [1.16, 103.502]).getCenter();
    var map = L.map('mapdiv').setView([center.x, center.y], 12);
    var yourMarker;
    var startMarker;
    var endMarker;

    var routeTextures = {
        WALK: {color: "black", dashArray: "10, 10"},
        SUBWAY: {
            NE: {color: "purple"},
            NS: {color: "red"},
            DT: {color: "blue"},
            EW: {color: "green"},
            CC: {color: "yellow"},
            TE: {color: "brown"},
            Default: {color: "grey"}
        },
        DRIVE: {color: "black"}
    }

    var basemap = L.tileLayer(`http://maps-{s}.onemap.sg/v2/Default/{z}/{x}/{y}.png`, {
        detectRetina: true,
        maxZoom: 18,
        minZoom: 12,
    });

    map.setMaxBounds([[1.56073, 104.1147], [1.16, 103.502]]);

    basemap.addTo(map);

    var updatePosition = false;
    var repeatedBuildings = {};

    function openMapView() {
        // Make toggle cards
        var activeSection;
        var index;
        var allSections = document.getElementsByClassName("planSection");
        for (var i=0; i<allSections.length; i++) {
            if (allSections[i].style.display == "block") {
                activeSection = allSections[i];
                index = i;
                break;
            }
        }

        var planCards = activeSection.getElementsByClassName("plan-selection");
        var mapDiv = document.getElementById("map-selection");
        mapDiv.innerHTML = "";
        for (var i=1; i<planCards.length; i++) {
            mapDiv.innerHTML += 
            `<div class="trip-place" style="border: 1px solid grey ;width: 250px; margin: 5px;" onclick="showRoute(${index}, '${planCards[i-1].querySelector(".plan-latlng").innerText}', '${planCards[i].querySelector(".plan-latlng").innerText}')">
                <h5>${planCards[i].querySelector(".plan-name").innerText}</h5>
                <p>${planCards[i].querySelector(".plan-address").innerText}</p>
            </div>`;
        }

        // Default show 1st part trip
        var firstCard = document.querySelector(".trip-place")
        if (typeof firstCard.onclick == "function")
            firstCard.onclick.apply(firstCard);

        // Pull plan page down
        $("#planPage").animate({
            bottom: "-200vh"
        }, 350, function () {
            $("#planPage").hide()
        });
    }

    function dismissMapView() {
        // Pull plan page up
        $("#planPage").show();
        $("#planPage").animate({
            top: "0",
            bottom: "0"
        }, 350);
    }

    function showYourPosition(position) {  
        updatePosition = true;  
        // Mark marker
        if (yourMarker) {
            map.removeLayer(yourMarker);
        }
        
        yourMarker = new L.Marker([position.coords.latitude, position.coords.longitude], {bounceOnAdd: false, customId: "YouMarker"}).addTo(map); 

        latLngStr = position.coords.latitude + "," + position.coords.longitude;
        document.getElementById("start-latlng").innerText = latLngStr;
    }

    function positioningError(error) {

    }

    function showRoute(index, position1, position2) {
        // Routing display
        var today = new Date();
        var routeType = document.getElementsByClassName("tm-selection")[index].querySelector("span").innerText;
        if (routeType == "Public Transport") {
            routeType = "pt";
        }

        var position1 = position1.split(",");
        var position2 = position2.split(",");

        function decodeGeo(encodedRoute) {
            if (encodedRoute !== undefined || encodedRoute !== '' || encodedRoute != null ) {
                var routeGeo = L.Polyline.fromEncoded(encodedRoute, {
                    precision: 6
                });

                return routeGeo;
            }
        }

        $.ajax({
            url: `https://developers.onemap.sg/privateapi/routingsvc/route?start=${position1[0]},${position1[1]}&end=${position2[0]},${position2[1]}&routeType=${routeType}&token=${apiKey}&date=${String(today.getFullYear())}-${String(today.getMonth()+1)}-${String(today.getDate())}&time=${String(today.getHours())}:${String(today.getMinutes())}:${String(today.getSeconds())}&mode=TRANSIT`,
            success: function(result) {
                //Set result to a variable for writing
                var encodedRoute;
                var modes = [];

                // Remove previous markings and route paths
                if (startMarker) {
                    map.removeLayer(startMarker);
                }
                if (endMarker) {
                    map.removeLayer(endMarker);
                }
                pathPieces = [].slice.call(document.getElementsByTagName("path")).map(x => x.parentElement);
                for (var i=0; i<pathPieces.length; i++) {
                    pathPieces[i].remove();
                }

                startMarker = new L.Marker([position1[0], position1[1]], {bounceOnAdd: true}).addTo(map);
                endMarker = new L.Marker([position2[0], position2[1]], {bounceOnAdd: true}).addTo(map);
                 
                if (routeType == "pt") {
                    var allRoutes = result.plan.itineraries;
                    for (var i in allRoutes) {
                        var transportMeans = allRoutes[i].legs;
                        for (var j in transportMeans) {
                            var details = transportMeans[j];
                            var mode = details.mode;

                            encodedRoute = details.legGeometry.points
                            var routeGeo = decodeGeo(encodedRoute);
                            modes = {endpoints: routeGeo._latlngs, mode: mode};

                            if (mode == "SUBWAY") {
                                var subwayLine = details.route;
                                L.polyline(modes.endpoints, routeTextures.SUBWAY[subwayLine]).addTo(map);
                            }
                            else {
                                L.polyline(modes.endpoints, routeTextures[modes.mode]).addTo(map);
                            }
                        }

                        // Remove for the next time, only take 1st route
                        break
                    }
                }
                else {
                    encodedRoute = result.route_geometry;
                    var routeGeo = decodeGeo(encodedRoute);
                    modes = {endpoints: routeGeo._latlngs, mode: routeType.toUpperCase()};

                    L.polyline(modes.endpoints, routeTextures[modes.mode]).addTo(map);
                }
            }
        });
    }

    window.addEventListener('load', function () {
        /*document.addEventListener('click', function (event) {
            const allTabs = document.getElementsById;
            const endInp = document.getElementById("end-location");
            const startInp = document.getElementById("start-location");

            if (![].slice.call(allTabs).find(x => x === event.target) && event.target != endInp && event.target != startInp) {
                if (!dropdownCooldown) {
                    for (var i in allTabs) {
                        allTabs.item(i).style.display = "none";
                    }
                }
            }
        });*/

        initFunctions();
    });

</script>
{% endblock %}
