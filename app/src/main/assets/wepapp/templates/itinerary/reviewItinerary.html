{% extends "base.html" %}
{% block title %}Redpins Buffer - Review Details{% endblock %}

{% block content %}
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.3/leaflet.css" />
<script src="https://cdn.onemap.sg/leaflet/onemap-leaflet.js"></script>
<script type="text/javascript" src="https://rawgit.com/jieter/Leaflet.encoded/master/Polyline.encoded.js"></script>

<div class="main-div">
    <!-- header -->
    <div class="explorerheader">
        <svg width="12" height="20" onclick="window.open('/','_self')">
            <path
            d="M10.2642 0C10.8582 0.203504 11.2215 0.68581 11.6052 1.12894C11.9081 1.47897 11.8687 2.05183 11.5761 2.4156C11.5052 2.50072 11.4295 2.58174 11.3494 2.65828C8.94914 5.0464 6.54751 7.43334 4.14452 9.81909C4.0819 9.87251 4.01519 9.92099 3.94498 9.96409C4.03554 10.0582 4.08722 10.1167 4.14145 10.1676C6.56048 12.5737 8.9795 14.9796 11.3985 17.3854C11.8298 17.8148 11.9613 18.3439 11.6385 18.7738C11.3346 19.1709 10.9778 19.5251 10.5779 19.8264C10.2074 20.1093 9.70807 20.0259 9.34174 19.7247C9.28648 19.6794 9.23276 19.6311 9.18211 19.5807L0.412125 10.8636C-0.0248138 10.4296 -0.119978 9.92084 0.153748 9.45024C0.222198 9.33957 0.304744 9.23817 0.399334 9.14854C3.33272 6.23165 6.26697 3.31661 9.20206 0.403448C9.37602 0.231995 9.61905 0.132787 9.8324 0H10.2642Z"
            fill="#2B2B2B" />
        </svg>
        <h1>Explorer Plan</h1>
        <div class="cardedit">
            <!-- <svg width="21" height="5" viewBox="0 0 21 5" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="18.1367" cy="2.63721" r="2" transform="rotate(90 18.1367 2.63721)" fill="#2B2B2B" />
            <circle cx="2.13672" cy="2.63721" r="2" transform="rotate(90 2.13672 2.63721)" fill="#2B2B2B" />
            <circle cx="10.1367" cy="2.63721" r="2" transform="rotate(90 10.1367 2.63721)" fill="#2B2B2B" />
            </svg> -->
            <p onclick="window.open('/itinerary/unconfirm/explorer','_self')">Edit</p>
        </div>
    </div>

    {% if itinerary != None %}
    <div class="explorertripitinerary" id="planPage" style="background-color: white;">
    {% else %}
    <div class="explorertripitinerary" id="planPage" style="background-color: white; display: none;">
    {% endif %}
        <section class="req-info" hidden>
            {% if itinerary != None %}
            <div id="startTime-text">Start time: <span>{{itinerary.getStartTime()}}</span></div>
            <div id="endTime-text">End time: <span>{{itinerary.getEndTime()}}</span></div>
            <div id="time-left">Duration left: <span>{{itinerary.getTimeLeft()| int}}</span></div>
        
            <div id="transport-text">Transport mode: <span>{{itinerary.getTransportMode()}}</span></div>
            <div>Category: Eateries</div>
            {% else %}
            <div id="startTime-text">Start time: </div>
            <div id="endTime-text">End time: </div>
            <div id="time-left">Duration left: <span></span></div>
        
            <div id="transport-text">Transport mode: <span></span></div>
            <div>Category: Eateries</div>

            <div id="start">Start location: </div>
            {% endif %}
        </section>

        <div id="recommendation-listings" style="overflow-y: scroll;">
            {% if itinerary != None %}
                {% for i in range(itinerary.getPlaces()| length) %}
                {% if i==0 %}
                <div class="plan-selection">
                    <div class="explorerstart">
                        <div class="explorerstartpoint">
                            <svg width="31" height="31" viewBox="0 0 31 31" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path
                                d="M0.888672 15.5C0.888672 12.5333 1.76841 9.63319 3.41663 7.16645C5.06485 4.69972 7.40753 2.77713 10.1484 1.64181C12.8893 0.506499 15.9053 0.209449 18.815 0.788228C21.7247 1.36701 24.3975 2.79562 26.4953 4.8934C28.5931 6.99119 30.0217 9.66394 30.6004 12.5737C31.1792 15.4834 30.8822 18.4994 29.7469 21.2403C28.6115 23.9811 26.689 26.3238 24.2222 27.972C21.7555 29.6203 18.8554 30.5 15.8887 30.5C13.9188 30.5 11.9683 30.112 10.1484 29.3582C8.32853 28.6044 6.67495 27.4995 5.28207 26.1066C2.46902 23.2936 0.888672 19.4783 0.888672 15.5ZM15.8887 24.5C17.6687 24.5 19.4088 23.9722 20.8888 22.9832C22.3688 21.9943 23.5224 20.5887 24.2036 18.9442C24.8848 17.2996 25.063 15.49 24.7157 13.7442C24.3685 11.9984 23.5113 10.3947 22.2526 9.13604C20.994 7.87737 19.3903 7.0202 17.6445 6.67294C15.8987 6.32567 14.0891 6.5039 12.4445 7.18509C10.8 7.86628 9.39438 9.01983 8.40544 10.4999C7.41651 11.9799 6.88867 13.72 6.88867 15.5C6.88867 17.887 7.83688 20.1761 9.52471 21.864C11.2125 23.5518 13.5017 24.5 15.8887 24.5Z"
                                fill="#06A122" />
                            </svg>
                            <h1 class="plan-name">{{itinerary.getPlaces()[i].Name}}</h1>
                            <p class="plan-address" hidden>{{itinerary.getPlaces()[i].Address}}</p>
                            <p class="plan-latlng" hidden>{{itinerary.getPlaces()[i].Latlng}}</p>
                        </div>

                        <div class="explorerstarttime">
                            <h1 class="plan-timing"></h1>
                        </div>
                    </div>
                </div>
                {% elif i==itinerary.getPlaces()| length - 1 %}
                <div class="plan-selection">
                    <hr>
                    <!-- explorerdirections -->
                    <div class="explorerdirections">
                        <div class="explorertransport">
                        </div>

                        <!-- explorertravelduration -->
                        <div class="explorertravelduration">
                        <h1><span class="plan-travel-duration">{{itinerary.getPlaces()[i].TotalDuration|int}}</span>min</h1>
                        <h2 onclick="showExpandedRoute">Details <svg width="9" height="5" viewBox="0 0 9 5" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M0.78125 0.657445C0.862652 0.406133 1.05557 0.252445 1.23283 0.0900984C1.37284 -0.0380473 1.60198 -0.0213795 1.74749 0.102437C1.78154 0.132408 1.81395 0.164424 1.84456 0.198329C2.79981 1.21383 3.75459 2.2299 4.70889 3.24655C4.73025 3.27304 4.74965 3.30127 4.76688 3.33097C4.80453 3.29266 4.82794 3.27079 4.84829 3.24785C5.81073 2.22441 6.7731 1.20098 7.7354 0.177549C7.90716 -0.00492803 8.11881 -0.0605592 8.29077 0.0760284C8.44962 0.204574 8.59127 0.355537 8.71182 0.524754C8.82497 0.681473 8.79159 0.89274 8.67112 1.04773C8.65301 1.0711 8.63367 1.09383 8.61352 1.11526L5.12668 4.82564C4.95309 5.0105 4.74959 5.05076 4.56134 4.93495C4.51708 4.90599 4.47652 4.87107 4.44067 4.83105C3.27391 3.59 2.1079 2.34859 0.942629 1.10682C0.874048 1.03322 0.834365 0.930405 0.78125 0.84014L0.78125 0.657445Z"
                                fill="#E4002B" />
                            </svg>
                        </h2>
                        </div>
                    </div>
                    <hr>

                    <div class="explorerend">
                        <div class="explorerendpoint">
                            <svg width="31" height="31" viewBox="0 0 31 31" fill="none" xmlns="http://www.w3.org/2000/svg">
                                <path
                                d="M0.333984 15.9771C0.333984 13.0103 1.21372 10.1102 2.86194 7.6435C4.51016 5.17677 6.85284 3.25418 9.59373 2.11886C12.3346 0.98355 15.3506 0.6865 18.2603 1.26528C21.17 1.84406 23.8428 3.27267 25.9406 5.37046C28.0384 7.46824 29.467 10.141 30.0458 13.0507C30.6245 15.9604 30.3275 18.9764 29.1922 21.7173C28.0569 24.4582 26.1343 26.8009 23.6675 28.4491C21.2008 30.0973 18.3007 30.9771 15.334 30.9771C13.3642 30.9771 11.4136 30.5891 9.59373 29.8352C7.77385 29.0814 6.12026 27.9765 4.72738 26.5837C1.91434 23.7706 0.333984 19.9553 0.333984 15.9771ZM15.334 24.9771C17.114 24.9771 18.8541 24.4492 20.3341 23.4603C21.8142 22.4713 22.9677 21.0657 23.6489 19.4212C24.3301 17.7767 24.5083 15.9671 24.161 14.2212C23.8138 12.4754 22.9566 10.8718 21.6979 9.6131C20.4393 8.35442 18.8356 7.49726 17.0898 7.14999C15.344 6.80272 13.5344 6.98095 11.8898 7.66214C10.2453 8.34333 8.83969 9.49688 7.85076 10.9769C6.86182 12.457 6.33398 14.197 6.33398 15.9771C6.33398 18.364 7.28219 20.6532 8.97002 22.341C10.6578 24.0288 12.947 24.9771 15.334 24.9771Z"
                                fill="#E4002B" />
                            </svg>
                            <h1 class="plan-name">{{itinerary.getPlaces()[i].Name}}</h1>
                            <p class="plan-address" hidden>{{itinerary.getPlaces()[i].Address}}</p>
                            <p class="plan-latlng" hidden>{{itinerary.getPlaces()[i].Latlng}}</p>
                            <p class="plan-total-duration" hidden>{{itinerary.getPlaces()[i].TotalDuration|int}}</p>
                        </div>
                        <div class="explorerendtime">
                            <h1 class="plan-timing"></h1>
                        </div>
                    </div>
                </div>
                {% else %}
                <div class="plan-selection">
                    <hr>
                    <!-- explorerdirections -->
                    <div class="explorerdirections">
                        <div class="explorertransport">
                        </div>

                        <!-- explorertravelduration -->
                        <div class="explorertravelduration">
                        <h1><span class="plan-travel-duration">{{itinerary.getPlaces()[i].TravelDuration|int}}</span>min</a>
                        <a data-toggle="collapse" href="#details-{{i+1}}"><h2>Details<svg width="9" height="5" viewBox="0 0 9 5" fill="none" xmlns="http://www.w3.org/2000/svg"></svg>
                            <path
                                d="M0.78125 0.657445C0.862652 0.406133 1.05557 0.252445 1.23283 0.0900984C1.37284 -0.0380473 1.60198 -0.0213795 1.74749 0.102437C1.78154 0.132408 1.81395 0.164424 1.84456 0.198329C2.79981 1.21383 3.75459 2.2299 4.70889 3.24655C4.73025 3.27304 4.74965 3.30127 4.76688 3.33097C4.80453 3.29266 4.82794 3.27079 4.84829 3.24785C5.81073 2.22441 6.7731 1.20098 7.7354 0.177549C7.90716 -0.00492803 8.11881 -0.0605592 8.29077 0.0760284C8.44962 0.204574 8.59127 0.355537 8.71182 0.524754C8.82497 0.681473 8.79159 0.89274 8.67112 1.04773C8.65301 1.0711 8.63367 1.09383 8.61352 1.11526L5.12668 4.82564C4.95309 5.0105 4.74959 5.05076 4.56134 4.93495C4.51708 4.90599 4.47652 4.87107 4.44067 4.83105C3.27391 3.59 2.1079 2.34859 0.942629 1.10682C0.874048 1.03322 0.834365 0.930405 0.78125 0.84014L0.78125 0.657445Z"
                                fill="#E4002B" />
                            </svg>
                        </h2></a>
                        </div>
                    </div>

                    <!-- showExpandedRoute -->
                    <div class="showexpandedroute collapse" id="details-{{i+1}}">
                        
                        <div class="detailedwalking">
                        
                        <svg width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                            d="M0.0078125 10C0.0078125 8.02219 0.594302 6.08879 1.69312 4.4443C2.79193 2.79981 4.35372 1.51809 6.18098 0.761209C8.00824 0.00433284 10.0189 -0.1937 11.9587 0.192152C13.8985 0.578004 15.6804 1.53041 17.0789 2.92894C18.4774 4.32746 19.4298 6.10929 19.8157 8.0491C20.2015 9.98891 20.0035 11.9996 19.2466 13.8268C18.4897 15.6541 17.208 17.2159 15.5635 18.3147C13.919 19.4135 11.9856 20 10.0078 20C8.69459 20 7.39423 19.7413 6.18098 19.2388C4.96772 18.7362 3.86533 17.9997 2.93674 17.0711C1.06138 15.1957 0.0078125 12.6522 0.0078125 10ZM10.0078 16C11.1945 16 12.3545 15.6481 13.3412 14.9888C14.3279 14.3295 15.097 13.3925 15.5511 12.2961C16.0052 11.1997 16.124 9.99335 15.8925 8.82946C15.661 7.66558 15.0896 6.59648 14.2504 5.75736C13.4113 4.91825 12.3422 4.3468 11.1784 4.11529C10.0145 3.88378 8.80807 4.0026 7.71171 4.45673C6.61535 4.91085 5.67828 5.67989 5.01899 6.66658C4.35971 7.65328 4.00781 8.81332 4.00781 10C4.00781 11.5913 4.63995 13.1174 5.76517 14.2426C6.89039 15.3679 8.41651 16 10.0078 16Z"
                            fill="#BBBBBB" />
                        </svg>

                        
                        <svg width="14" height="20" viewBox="0 0 14 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                            d="M8.79073 3.72093C9.12694 3.72093 9.4556 3.61182 9.73514 3.40739C10.0147 3.20296 10.2326 2.91239 10.3612 2.57244C10.4899 2.23248 10.5236 1.8584 10.458 1.49751C10.3924 1.13661 10.2305 0.805109 9.99274 0.544918C9.75501 0.284728 9.45211 0.107536 9.12236 0.0357492C8.79262 -0.0360373 8.45082 0.000806104 8.14021 0.14162C7.82959 0.282435 7.5641 0.520895 7.37731 0.826847C7.19053 1.1328 7.09083 1.4925 7.09083 1.86047C7.09217 2.35344 7.2717 2.8258 7.5902 3.17439C7.90871 3.52297 8.3403 3.71946 8.79073 3.72093ZM5.73091 16.6512L6.58086 12.5581L8.36575 14.4186V20H10.0657V13.0233L8.28076 11.1628L8.79073 8.37209C9.3739 9.10142 10.0926 9.68613 10.8987 10.0872C11.7049 10.4882 12.5799 10.6964 13.4655 10.6977V8.83721C12.7307 8.84941 12.0061 8.64946 11.3644 8.25751C10.7228 7.86557 10.1869 7.29547 9.81067 6.60465L8.96072 5.11628C8.81006 4.84145 8.59888 4.61233 8.34647 4.44983C8.09407 4.28733 7.80848 4.19664 7.5158 4.18605C7.26082 4.18605 7.09083 4.27907 6.83584 4.27907L2.4161 6.32558V10.6977H4.116V7.53489L5.64591 6.88372L4.28599 14.4186L0.12123 13.4884L-0.21875 15.3488L5.73091 16.6512Z"
                            fill="#707070" />
                        </svg>

                        <h1>7 mins (550 m)</h1>
                        </div>

                        
                        <svg class="walkingdots" width="5" height="41" viewBox="0 0 5 41" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="2.00781" cy="2" r="2" fill="#2B2B2B" />
                        <circle cx="2.00781" cy="39" r="2" fill="#2B2B2B" />
                        <circle cx="2.00781" cy="19" r="2" fill="#2B2B2B" />
                        </svg>

                        
                        <div class="detailedtransportation">
                        <div class="stationname">
                            
                            <svg width="21" height="20" viewBox="0 0 21 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M0.0078125 10C0.0078125 8.02219 0.594302 6.08879 1.69312 4.4443C2.79193 2.79981 4.35372 1.51809 6.18098 0.761209C8.00824 0.00433284 10.0189 -0.1937 11.9587 0.192152C13.8985 0.578004 15.6804 1.53041 17.0789 2.92894C18.4774 4.32746 19.4298 6.10929 19.8157 8.0491C20.2015 9.98891 20.0035 11.9996 19.2466 13.8268C18.4897 15.6541 17.208 17.2159 15.5635 18.3147C13.919 19.4135 11.9856 20 10.0078 20C8.69459 20 7.39423 19.7413 6.18098 19.2388C4.96772 18.7362 3.86533 17.9997 2.93674 17.0711C1.06138 15.1957 0.0078125 12.6522 0.0078125 10ZM10.0078 16C11.1945 16 12.3545 15.6481 13.3412 14.9888C14.3279 14.3295 15.097 13.3925 15.5511 12.2961C16.0052 11.1997 16.124 9.99335 15.8925 8.82946C15.661 7.66558 15.0896 6.59648 14.2504 5.75736C13.4113 4.91825 12.3422 4.3468 11.1784 4.11529C10.0145 3.88378 8.80807 4.0026 7.71171 4.45673C6.61535 4.91085 5.67828 5.67989 5.01899 6.66658C4.35971 7.65328 4.00781 8.81332 4.00781 10C4.00781 11.5913 4.63995 13.1174 5.76517 14.2426C6.89039 15.3679 8.41651 16 10.0078 16Z"
                                fill="#BBBBBB" />
                            </svg>

                            
                            <svg width="13" height="15" viewBox="0 0 13 15" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path
                                d="M0.929688 10.875C0.929688 11.5712 1.20261 12.2389 1.68842 12.7312C2.17422 13.2234 2.83312 13.5 3.52015 13.5L2.40995 14.625V15H11.2915V14.625L10.1813 13.5C10.8684 13.5 11.5273 13.2234 12.0131 12.7312C12.4989 12.2389 12.7718 11.5712 12.7718 10.875V3C12.7718 0.375 10.1221 0 6.85074 0C3.57936 0 0.929688 0.375 0.929688 3V10.875ZM6.85074 12C6.55797 12 6.27178 11.912 6.02835 11.7472C5.78492 11.5824 5.59519 11.3481 5.48316 11.074C5.37112 10.7999 5.3418 10.4983 5.39892 10.2074C5.45604 9.91639 5.59702 9.64912 5.80404 9.43934C6.01105 9.22956 6.27481 9.0867 6.56195 9.02882C6.8491 8.97094 7.14673 9.00065 7.41721 9.11418C7.68769 9.22771 7.91888 9.41997 8.08153 9.66665C8.24419 9.91332 8.331 10.2033 8.331 10.5C8.32983 10.8975 8.1735 11.2783 7.89615 11.5593C7.6188 11.8404 7.24297 11.9988 6.85074 12ZM11.2915 6.75H2.40995V3H11.2915V6.75Z"
                                fill="#707070" />
                            </svg>

                            <h1>Yio Chu Kang</h1>
                        </div>

                        </div>
                    </div>
                    <hr>

                    <div class="explorerevent">
                        <div class="eventdetails">
                            <div class="eventimg plan-img" style="background-image: url('{{itinerary.getPlaces()[i].Image}}');">
                                <span hidden>{{itinerary.getPlaces()[i].Img}}</span>
                            </div>
                
                            <div class="eventinfo">
                                <h1 class="eventname plan-name">{{itinerary.getPlaces()[i].Name}}</h1>
                                <h2 class="eventtype plan-category">{{itinerary.getPlaces()[i].Category}}</h2>
                                <p class="plan-address" hidden>{{itinerary.getPlaces()[i].Address}}</p>
                                <p class="plan-activity-duration" hidden><span>{{itinerary.getPlaces()[i].ActivityDuration}}</span> min</p>
                                <p class="plan-total-duration" hidden><span>{{itinerary.getPlaces()[i].TotalDuration|int}}</span> min</p>
                                <p class="plan-timing" hidden></p>
                                <p class="plan-latlng" hidden>{{itinerary.getPlaces()[i].Latlng}}</p>
                            </div>
                        </div>
                    </div>
                </div>
                {% endif %}
                
                {% endfor %}
            {% endif %}
        </div>
        <br>

        <!-- viewonmap -->
        <div class="viewonmap" onclick="openMapView();">
            <svg width="51" height="50" viewBox="0 0 51 50" fill="none" xmlns="http://www.w3.org/2000/svg">
            <rect x="0.888672" width="50" height="50" rx="5" fill="#2B2B2B" />
            <path
                d="M14.0286 37.4989C13.5494 37.3388 13.3875 36.9977 13.3887 36.5057C13.3978 31.8787 13.3942 27.2517 13.3942 22.6247C13.3942 22.0306 13.5311 21.8228 14.0714 21.6064C16.3617 20.6896 18.6526 19.7733 20.9434 18.8571H20.9459C21.0693 18.807 21.2032 18.8993 21.2032 19.0319V19.0417C21.2032 24.1894 21.202 29.3366 21.2081 34.4843C21.2081 34.6873 21.1445 34.7777 20.9599 34.8505C18.787 35.7117 16.6172 36.5808 14.4473 37.4494C14.4192 37.4604 14.396 37.4824 14.3703 37.4995H14.0286V37.4989Z"
                fill="white" />
            <path
                d="M37.8765 19.9487C37.2017 21.602 36.1015 23.025 35.0227 24.4571C34.5581 25.0732 34.0484 25.6557 33.5472 26.2437C33.1823 26.6722 32.6658 26.6813 32.3021 26.2645C30.9116 24.6679 29.6042 23.0091 28.5565 21.1613C28.1225 20.3967 27.7399 19.607 27.551 18.7409C27.3255 17.7079 27.4954 16.7128 27.9251 15.7697C28.6892 14.0925 29.9892 13.0467 31.7838 12.628C34.3045 12.0406 37.0898 13.5302 37.9847 15.9598C38.0152 16.0435 38.0434 16.1279 38.0696 16.2128C38.4437 17.4396 38.3618 18.7611 37.8771 19.9487H37.8765ZM32.9078 20.3154C34.1835 20.324 35.2543 19.2574 35.2568 17.9762C35.2592 16.7061 34.2177 15.6548 32.9366 15.6328C31.667 15.6114 30.5907 16.6725 30.5754 17.9597C30.5601 19.2323 31.6243 20.3062 32.9078 20.3154Z"
                fill="white" />
            <path
                d="M30.5742 37.1345V27.3525C30.5742 27.111 30.8762 27.0022 31.0302 27.1874L31.0345 27.1923C31.4098 27.644 31.8682 27.9674 32.4519 28.0762C33.3296 28.24 34.082 27.9869 34.6749 27.325C35.6945 26.1856 36.6498 24.9931 37.5086 23.7267C37.6437 23.528 37.7769 23.3282 37.9102 23.1283C38.052 22.9156 38.3832 23.0158 38.3832 23.2713V33.9256C38.3832 33.9653 38.3784 34.0044 38.3649 34.0417C38.2543 34.3547 38.0159 34.5295 37.706 34.6517C36.137 35.2703 34.5716 35.898 33.0069 36.527C32.3132 36.8057 31.6225 37.0905 30.9306 37.3741C30.7606 37.4438 30.5742 37.3185 30.5742 37.1351V37.1345Z"
                fill="white" />
            <path
                d="M22.766 19.0019C22.766 18.8846 22.8846 18.8045 22.9934 18.8479C23.1578 18.9133 23.3124 18.9744 23.4671 19.0362C24.3717 19.3974 25.2769 19.7562 26.1785 20.1235C26.2738 20.1626 26.3887 20.2378 26.4248 20.3246C27.0391 21.8154 27.9021 23.1601 28.8434 24.4577C28.9553 24.6118 29.0158 24.797 29.0158 24.987C29.0109 28.9655 29.0121 32.944 29.0121 36.9225V36.997C29.0121 37.1144 28.8935 37.1975 28.7841 37.1541H28.7823C26.8459 36.3791 24.9108 35.601 22.972 34.8327C22.8094 34.7685 22.7611 34.6872 22.7617 34.5167C22.7666 29.3451 22.7654 24.1735 22.7654 19.0019H22.766Z"
                fill="white" />
            </svg>
    
        </div>

        <!-- bottom -->
        <section class="bottom">
            <div class="refresh" onclick="recommendExplorer();">
            <svg width="69" height="51" viewBox="0 0 69 51" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="0.554688" y="0.5" width="68" height="50" rx="5" fill="#BBBBBB" />
                <path
                d="M41.6358 18.4403C40.0786 16.878 38.0486 15.8745 35.8618 15.5859C33.6751 15.2974 31.4543 15.7401 29.5452 16.845C27.6362 17.9499 26.146 19.6551 25.3068 21.6951C24.4675 23.7351 24.3263 25.9953 24.905 28.1239C25.4838 30.2525 26.7501 32.13 28.5067 33.464C30.2633 34.7981 32.4117 35.5138 34.6174 35.4998C36.823 35.4858 38.9622 34.7428 40.7017 33.3866C42.4413 32.0303 43.6836 30.1369 44.2353 28.0012H41.6358C41.1769 29.2965 40.3709 30.4408 39.3057 31.3089C38.2405 32.177 36.9572 32.7356 35.596 32.9235C34.2348 33.1115 32.8482 32.9216 31.5876 32.3746C30.3271 31.8277 29.2411 30.9447 28.4485 29.8222C27.6558 28.6996 27.187 27.3808 27.0932 26.0098C26.9994 24.6388 27.2843 23.2684 27.9168 22.0484C28.5492 20.8284 29.5048 19.8057 30.6791 19.0922C31.8535 18.3787 33.2014 18.0017 34.5755 18.0026C35.5582 18.0041 36.5309 18.2016 37.4364 18.5835C38.3419 18.9655 39.1622 19.5242 39.8492 20.2271L35.8254 24.2512H44.5725V15.5033L41.6358 18.4403Z"
                fill="white" />
            </svg>
            </div>
            <form method="POST">
                <input id="itinerary-id" name="id" value="{% if itinerary != None %}{{itinerary.getId()}}{% endif %}" hidden readonly>
                <div class="maincta starttrip" onclick="document.querySelector('form').submit();">
                    <h1>Create Trip!</h1>
                </div>
            </form>
        </section>
    </div>

    <!-- Map View -->
    <div class="device" id="mapView" style="position: absolute; z-index: 0; display: none;">
        <div id='mapdiv' style='height:100vh;'></div>

        <svg style="z-index: 5;" class="back" width="12" height="21" viewBox="0 0 12 21" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path onclick="dismissMapView();"
                d="M10.3111 0.5C10.9051 0.703504 11.2684 1.18581 11.6521 1.62894C11.955 1.97897 11.9156 2.55183 11.6229 2.9156C11.5521 3.00072 11.4764 3.08174 11.3963 3.15828C8.99602 5.5464 6.59439 7.93334 4.1914 10.3191C4.12878 10.3725 4.06206 10.421 3.99186 10.4641C4.08242 10.5582 4.13409 10.6167 4.18833 10.6676C6.60735 13.0737 9.02637 15.4796 11.4454 17.8854C11.8767 18.3148 12.0082 18.8439 11.6854 19.2738C11.3815 19.6709 11.0247 20.0251 10.6247 20.3264C10.2543 20.6093 9.75495 20.5259 9.38861 20.2247C9.33336 20.1794 9.27963 20.1311 9.22898 20.0807L0.459 11.3636C0.0220612 10.9296 -0.0731035 10.4208 0.200623 9.95024C0.269073 9.83957 0.351619 9.73817 0.446209 9.64854C3.3796 6.73165 6.31384 3.81661 9.24894 0.903448C9.42289 0.731995 9.66592 0.632787 9.87927 0.5H10.3111Z"
                fill="#FFFFFF" />
        </svg>
        
        
        <div class="mapbuttons" style="z-index: 5;">
            <div class="qrcodescanner" onclick="window.open('/qr-scanner','_self')">
                <img src="../../static/images/qrscanner.png" alt="">
            </div>
    
            <div class="currentlocation">
                <img src="../../static/images/currentlocation.png" alt="">
            </div>
        </div>
        
        <section>
            <div class="mapdetailscon" id="map-selection">

            </div>
        </section>
    </div>
    
    </div>
</div>
{% endblock %}

{% block scripts %}
{{super()}}
<script>
    const apiKey = "{{apiKey}}";
    var post;
    var skipped = [0];
    var allowanceLeft = parseInt(document.querySelector("#time-left").querySelector("span").innerText);
    var originalDuration = allowanceLeft;
    var pendingChooseList = {};
    const currentTime = new Date();

    var requests = [];

    function displayRouteDetails() {
        var allAddresses = document.getElementsByClassName("plan-address");
        var allLatlngs = document.getElementsByClassName("plan-latlng");
        var allRouteDiv = document.getElementsByClassName("explorertransport")
        var routeType = document.querySelector("#transport-text").querySelector("span").innerText;
        var checkTime = currentTime;
        var startTime = document.querySelector("#startTime-text").querySelector("span").innerText;

        function getAPIRoute(index) {
            var position1 = allLatlngs[index].innerText.split(",");
            var position2 = allLatlngs[index+1].innerText.split(",");
            var res = true;

            allRouteDiv[index].innerHTML = "";

            $.ajax({
                dataType: "json",
                url: `https://developers.onemap.sg/privateapi/routingsvc/route?start=${position1[0]},${position1[1]}&end=${position2[0]},${position2[1]}&routeType=${routeType}&token=${apiKey}&date=${String(checkTime.getFullYear())}-${String(checkTime.getMonth()+1)}-${String(checkTime.getDate())}&time=${startTime}:00&mode=TRANSIT`,
                success: function(result) {
                    //Set result to a variable for writing
                    if (routeType == "pt")
                        var info = result.plan.itineraries[0];
                    else
                        var info = result.route_summary;

                    function addModeIcon(routeType, info) {
                        if (routeType == "walk") {
                            allRouteDiv[index].innerHTML += 
                                `<div><svg width="14" height="20" viewBox="0 0 14 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                    d="M8.79073 3.72093C9.12694 3.72093 9.4556 3.61182 9.73514 3.40739C10.0147 3.20296 10.2326 2.91239 10.3612 2.57244C10.4899 2.23248 10.5236 1.8584 10.458 1.49751C10.3924 1.13661 10.2305 0.805109 9.99274 0.544918C9.75501 0.284728 9.45211 0.107536 9.12236 0.0357492C8.79262 -0.0360373 8.45082 0.000806104 8.14021 0.14162C7.82959 0.282435 7.5641 0.520895 7.37731 0.826847C7.19053 1.1328 7.09083 1.4925 7.09083 1.86047C7.09217 2.35344 7.2717 2.8258 7.5902 3.17439C7.90871 3.52297 8.3403 3.71946 8.79073 3.72093ZM5.73091 16.6512L6.58086 12.5581L8.36575 14.4186V20H10.0657V13.0233L8.28076 11.1628L8.79073 8.37209C9.3739 9.10142 10.0926 9.68613 10.8987 10.0872C11.7049 10.4882 12.5799 10.6964 13.4655 10.6977V8.83721C12.7307 8.84941 12.0061 8.64946 11.3644 8.25751C10.7228 7.86557 10.1869 7.29547 9.81067 6.60465L8.96072 5.11628C8.81006 4.84145 8.59888 4.61233 8.34647 4.44983C8.09407 4.28733 7.80848 4.19664 7.5158 4.18605C7.26082 4.18605 7.09083 4.27907 6.83584 4.27907L2.4161 6.32558V10.6977H4.116V7.53489L5.64591 6.88372L4.28599 14.4186L0.12123 13.4884L-0.21875 15.3488L5.73091 16.6512Z"
                                    fill="#707070" />
                                </svg></div>`;
                        }
                        else if (routeType == "drive") {
                            allRouteDiv[index].innerHTML += 
                                `<div><svg width="14" height="20" viewBox="0 0 14 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                    d="M8.79073 3.72093C9.12694 3.72093 9.4556 3.61182 9.73514 3.40739C10.0147 3.20296 10.2326 2.91239 10.3612 2.57244C10.4899 2.23248 10.5236 1.8584 10.458 1.49751C10.3924 1.13661 10.2305 0.805109 9.99274 0.544918C9.75501 0.284728 9.45211 0.107536 9.12236 0.0357492C8.79262 -0.0360373 8.45082 0.000806104 8.14021 0.14162C7.82959 0.282435 7.5641 0.520895 7.37731 0.826847C7.19053 1.1328 7.09083 1.4925 7.09083 1.86047C7.09217 2.35344 7.2717 2.8258 7.5902 3.17439C7.90871 3.52297 8.3403 3.71946 8.79073 3.72093ZM5.73091 16.6512L6.58086 12.5581L8.36575 14.4186V20H10.0657V13.0233L8.28076 11.1628L8.79073 8.37209C9.3739 9.10142 10.0926 9.68613 10.8987 10.0872C11.7049 10.4882 12.5799 10.6964 13.4655 10.6977V8.83721C12.7307 8.84941 12.0061 8.64946 11.3644 8.25751C10.7228 7.86557 10.1869 7.29547 9.81067 6.60465L8.96072 5.11628C8.81006 4.84145 8.59888 4.61233 8.34647 4.44983C8.09407 4.28733 7.80848 4.19664 7.5158 4.18605C7.26082 4.18605 7.09083 4.27907 6.83584 4.27907L2.4161 6.32558V10.6977H4.116V7.53489L5.64591 6.88372L4.28599 14.4186L0.12123 13.4884L-0.21875 15.3488L5.73091 16.6512Z"
                                    fill="#707070" />
                                </svg></div>`;
                        }
                        else if (routeType == "cycle") {
                            allRouteDiv[index].innerHTML += 
                                `<div><svg width="14" height="20" viewBox="0 0 14 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                    <path
                                    d="M8.79073 3.72093C9.12694 3.72093 9.4556 3.61182 9.73514 3.40739C10.0147 3.20296 10.2326 2.91239 10.3612 2.57244C10.4899 2.23248 10.5236 1.8584 10.458 1.49751C10.3924 1.13661 10.2305 0.805109 9.99274 0.544918C9.75501 0.284728 9.45211 0.107536 9.12236 0.0357492C8.79262 -0.0360373 8.45082 0.000806104 8.14021 0.14162C7.82959 0.282435 7.5641 0.520895 7.37731 0.826847C7.19053 1.1328 7.09083 1.4925 7.09083 1.86047C7.09217 2.35344 7.2717 2.8258 7.5902 3.17439C7.90871 3.52297 8.3403 3.71946 8.79073 3.72093ZM5.73091 16.6512L6.58086 12.5581L8.36575 14.4186V20H10.0657V13.0233L8.28076 11.1628L8.79073 8.37209C9.3739 9.10142 10.0926 9.68613 10.8987 10.0872C11.7049 10.4882 12.5799 10.6964 13.4655 10.6977V8.83721C12.7307 8.84941 12.0061 8.64946 11.3644 8.25751C10.7228 7.86557 10.1869 7.29547 9.81067 6.60465L8.96072 5.11628C8.81006 4.84145 8.59888 4.61233 8.34647 4.44983C8.09407 4.28733 7.80848 4.19664 7.5158 4.18605C7.26082 4.18605 7.09083 4.27907 6.83584 4.27907L2.4161 6.32558V10.6977H4.116V7.53489L5.64591 6.88372L4.28599 14.4186L0.12123 13.4884L-0.21875 15.3488L5.73091 16.6512Z"
                                    fill="#707070" />
                                </svg></div>`;
                        }
                        else if (routeType == "bus") {
                            var routes = info.route.split("/")
                            for (var i=0; i<routes.length; i++) {
                                allRouteDiv[index].innerHTML += 
                                    `<div class="transportation" style="background: ${routeTextures[routeType].color}">
                                        <h1>${routes[i]}</h1>
                                    </div>`;
                            }
                        }
                        else if (routeType == "tram") {
                            allRouteDiv[index].innerHTML += 
                                `<div class="transportation" style="background: ${routeTextures[routeType].color}">
                                    <h1>${info.route}</h1>
                                </div>`;
                        }
                        else if (routeType == "subway") {
                            console.log(info.route)
                            allRouteDiv[index].innerHTML += 
                                `<div class="transportation" style="background: ${routeTextures.subway[info.route].color}">
                                    <h1>${info.route}</h1>
                                </div>`;
                        }
                    }

                    if (routeType == "pt") {
                        for (var i=0; i<info.legs.length; i++) {
                            addModeIcon(info.legs[i].mode.toLowerCase(), info.legs[i]);
                            if (i != info.legs.length -1) {
                                allRouteDiv[index].innerHTML += 
                                    `<div><svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path
                                        d="M1.54958 -1.36256e-06C1.75249 0.0669132 1.89922 0.212233 2.04594 0.362284C3.87674 2.23657 5.70952 4.10882 7.54098 5.98108C7.79676 6.24265 7.85162 6.54884 7.68969 6.83069C7.65466 6.89152 7.6084 6.9483 7.55882 6.99899C5.67846 8.92329 3.79611 10.8462 1.91442 12.7705C1.7201 12.9693 1.4934 13.0544 1.22572 12.9638C0.981174 12.8814 0.835107 12.7009 0.791485 12.4414C0.757777 12.2413 0.816601 12.0649 0.944162 11.9121C0.979192 11.8702 1.01753 11.8317 1.0552 11.7925C2.74389 10.0662 4.43193 8.33998 6.12195 6.6144C6.15632 6.57925 6.20324 6.55695 6.24422 6.52856L6.24422 6.47178C6.20324 6.4434 6.15632 6.42109 6.12195 6.38594C4.42069 4.64887 2.7201 2.91044 1.02017 1.17202C0.76042 0.906386 0.71085 0.592767 0.879389 0.310239C0.977868 0.145319 1.13319 0.0648857 1.30173 -1.34089e-06L1.54958 -1.36256e-06Z"
                                        fill="#707070" />
                                    </svg></div>`;
                            }
                        }
                    }
                    else {
                        addModeIcon(routeType, info);
                    }
                },
                error: function(jqXHR, textStatus, err) {
                    res = false;
                }
            });

            return res;
        }

        for (var i=0; i<allAddresses.length-1; i++) {
            tries = 0;
            while (tries <= 5) {
                tries++;
                res = getAPIRoute(i);
                if (res)
                    break;
            }
        }
    }

    // initFunctions();

    // Map settings
    // Map display init
    L.Icon.Default.imagePath = "https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.4.0/images";
    var center = L.bounds([1.56073, 104.11475], [1.16, 103.502]).getCenter();
    var map = L.map('mapdiv').setView([center.x, center.y], 12);
    var yourMarker;
    var startMarker;
    var endMarker;

    var routeTextures = {
        walk: {color: "black", dashArray: "10, 10"},
        subway: {
            NE: {color: "#8E3E98"},
            NS: {color: "#E32325"},
            DT: {color: "#2059A9"},
            EW: {color: "#0C9345"},
            CC: {color: "#F99D21"},
            CE: {color: "#F99D21"},
            TE: {color: "#AA7242"},
            Default: {color: "#708573"}
        },
        tram: {color: "#708573"},
        bus: {color: "#0C9345"},
        drive: {color: "black"}
    }

    var basemap = L.tileLayer(`http://maps-{s}.onemap.sg/v2/Default/{z}/{x}/{y}.png`, {
        detectRetina: true,
        maxZoom: 18,
        minZoom: 12,
    });

    map.setMaxBounds([[1.56073, 104.1147], [1.16, 103.502]]);

    basemap.addTo(map);

    var updatePosition = false;
    var repeatedBuildings = {};

    function getLocation() {
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(showYourPosition, positioningError, {
                timeout: 500,
                enableHighAccuracy: true
            });
            navigator.geolocation.watchPosition(showYourPosition, positioningError, {
                timeout: 500,
                enableHighAccuracy: true
            });
        }
    }

    function openMapView() {
        // Make toggle cards
        var planCards = document.getElementById("recommendation-listings").getElementsByClassName("plan-selection");
        var mapDiv = document.getElementById("map-selection");
        mapDiv.innerHTML = "";
        for (var i=1; i<planCards.length; i++) {
            mapDiv.innerHTML += 
            `<div class="mapdetails trip-place" onclick="showRoute('${planCards[i-1].querySelector(".plan-latlng").innerText}', '${planCards[i].querySelector(".plan-latlng").innerText}')">
                <!-- explorerevent -->
                <div class="explorerevent">
                    <div class="eventdetails">
                    <div class="eventinfo">
                        <h1 class="eventname">${planCards[i-1].querySelector(".plan-name").innerText}</h1>
                    </div>
                    </div>

                    <div class="eventedit">
                        <h1>${planCards[i].querySelector(".plan-travel-duration").innerText} mins</h1>
                    </div>
                </div>

                <!-- explorerdirections -->
                <div class="mapdirections">
                    <div class="maptransport">
                    </div>

                    <!-- explorertravelduration -->
                    <div class="explorertravelduration">
                    <h2 onclick="showExpandedRoute">See Details</h2>
                    </div>
                </div>
            </div>`;

            routeIconsDiv = mapDiv.getElementsByClassName("maptransport");
            var routeType = document.querySelector('input[name="transportMode"]:checked').value;
            var checkTime = currentTime;
            var startTime = $("#start-time").val();

            function getAPIRoute(index) {
                var position1 = planCards[index-1].querySelector(".plan-latlng").innerText.split(",");
                var position2 = planCards[index].querySelector(".plan-latlng").innerText.split(",");
                var res = true;

                routeIconsDiv[index-1].innerHTML = "";

                $.ajax({
                    dataType: "json",
                    url: `https://developers.onemap.sg/privateapi/routingsvc/route?start=${position1[0]},${position1[1]}&end=${position2[0]},${position2[1]}&routeType=${routeType}&token=${apiKey}&date=${String(checkTime.getFullYear())}-${String(checkTime.getMonth()+1)}-${String(checkTime.getDate())}&time=${startTime}:00&mode=TRANSIT`,
                    success: function(result) {
                        //Set result to a variable for writing
                        if (routeType == "pt")
                            var info = result.plan.itineraries[0];
                        else
                            var info = result.route_summary;

                        function addModeIcon(routeType, info) {
                            if (routeType == "walk") {
                                routeIconsDiv[index-1].innerHTML += 
                                    `<svg width="14" height="20" viewBox="0 0 14 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path
                                        d="M8.79073 3.72093C9.12694 3.72093 9.4556 3.61182 9.73514 3.40739C10.0147 3.20296 10.2326 2.91239 10.3612 2.57244C10.4899 2.23248 10.5236 1.8584 10.458 1.49751C10.3924 1.13661 10.2305 0.805109 9.99274 0.544918C9.75501 0.284728 9.45211 0.107536 9.12236 0.0357492C8.79262 -0.0360373 8.45082 0.000806104 8.14021 0.14162C7.82959 0.282435 7.5641 0.520895 7.37731 0.826847C7.19053 1.1328 7.09083 1.4925 7.09083 1.86047C7.09217 2.35344 7.2717 2.8258 7.5902 3.17439C7.90871 3.52297 8.3403 3.71946 8.79073 3.72093ZM5.73091 16.6512L6.58086 12.5581L8.36575 14.4186V20H10.0657V13.0233L8.28076 11.1628L8.79073 8.37209C9.3739 9.10142 10.0926 9.68613 10.8987 10.0872C11.7049 10.4882 12.5799 10.6964 13.4655 10.6977V8.83721C12.7307 8.84941 12.0061 8.64946 11.3644 8.25751C10.7228 7.86557 10.1869 7.29547 9.81067 6.60465L8.96072 5.11628C8.81006 4.84145 8.59888 4.61233 8.34647 4.44983C8.09407 4.28733 7.80848 4.19664 7.5158 4.18605C7.26082 4.18605 7.09083 4.27907 6.83584 4.27907L2.4161 6.32558V10.6977H4.116V7.53489L5.64591 6.88372L4.28599 14.4186L0.12123 13.4884L-0.21875 15.3488L5.73091 16.6512Z"
                                        fill="#707070" />
                                    </svg>`;
                            }
                            else if (routeType == "drive") {
                                routeIconsDiv[index-1].innerHTML += 
                                    `<svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path
                                        d="M1.54958 -1.36256e-06C1.75249 0.0669132 1.89922 0.212233 2.04594 0.362284C3.87674 2.23657 5.70952 4.10882 7.54098 5.98108C7.79676 6.24265 7.85162 6.54884 7.68969 6.83069C7.65466 6.89152 7.6084 6.9483 7.55882 6.99899C5.67846 8.92329 3.79611 10.8462 1.91442 12.7705C1.7201 12.9693 1.4934 13.0544 1.22572 12.9638C0.981174 12.8814 0.835107 12.7009 0.791485 12.4414C0.757777 12.2413 0.816601 12.0649 0.944162 11.9121C0.979192 11.8702 1.01753 11.8317 1.0552 11.7925C2.74389 10.0662 4.43193 8.33998 6.12195 6.6144C6.15632 6.57925 6.20324 6.55695 6.24422 6.52856L6.24422 6.47178C6.20324 6.4434 6.15632 6.42109 6.12195 6.38594C4.42069 4.64887 2.7201 2.91044 1.02017 1.17202C0.76042 0.906386 0.71085 0.592767 0.879389 0.310239C0.977868 0.145319 1.13319 0.0648857 1.30173 -1.34089e-06L1.54958 -1.36256e-06Z"
                                        fill="#707070" />
                                    </svg>`;
                            }
                            else if (routeType == "cycle") {
                                routeIconsDiv[index-1].innerHTML += 
                                    `<div><svg width="14" height="20" viewBox="0 0 14 20" fill="none" xmlns="http://www.w3.org/2000/svg">
                                        <path
                                        d="M15.4969 3.90244C15.8829 3.90244 16.2601 3.788 16.581 3.5736C16.9019 3.3592 17.152 3.05446 17.2996 2.69792C17.4473 2.34138 17.486 1.94906 17.4107 1.57056C17.3354 1.19206 17.1496 0.844382 16.8767 0.5715C16.6038 0.298617 16.2561 0.112781 15.8776 0.037493C15.4991 -0.0377952 15.1068 0.000845426 14.7502 0.148529C14.3937 0.296212 14.089 0.546304 13.8746 0.867181C13.6602 1.18806 13.5457 1.56531 13.5457 1.95122C13.5473 2.46824 13.7533 2.96364 14.1189 3.32923C14.4845 3.69483 14.9799 3.9009 15.4969 3.90244V3.90244ZM5.25305 10.2439C3.95931 10.2439 2.71856 10.7578 1.80375 11.6726C0.888936 12.5875 0.375 13.8282 0.375 15.1219C0.375 16.4157 0.888936 17.6564 1.80375 18.5712C2.71856 19.4861 3.95931 20 5.25305 20C6.54679 20 7.78754 19.4861 8.70235 18.5712C9.61716 17.6564 10.1311 16.4157 10.1311 15.1219C10.1311 13.8282 9.61716 12.5875 8.70235 11.6726C7.78754 10.7578 6.54679 10.2439 5.25305 10.2439ZM5.25305 18.5366C4.34743 18.5366 3.47891 18.1768 2.83854 17.5365C2.19817 16.8961 1.83841 16.0276 1.83841 15.1219C1.83841 14.2163 2.19817 13.3478 2.83854 12.7074C3.47891 12.0671 4.34743 11.7073 5.25305 11.7073C6.15866 11.7073 7.02719 12.0671 7.66756 12.7074C8.30793 13.3478 8.66768 14.2163 8.66768 15.1219C8.66768 16.0276 8.30793 16.8961 7.66756 17.5365C7.02719 18.1768 6.15866 18.5366 5.25305 18.5366ZM10.9116 8.78049L13.253 6.43902L14.0335 7.21951C14.6811 7.87989 15.456 8.40196 16.3112 8.75412C17.1665 9.10628 18.0843 9.2812 19.0091 9.26829V7.31707C18.3553 7.32268 17.707 7.19592 17.1034 6.94442C16.4998 6.69292 15.9534 6.32189 15.4969 5.85366L13.6433 4C13.21 3.62402 12.656 3.41627 12.0823 3.41463C11.8246 3.39755 11.5665 3.44168 11.3291 3.54341C11.0918 3.64515 10.8818 3.80161 10.7165 4L7.98475 6.73171C7.80159 6.90926 7.65552 7.12143 7.55503 7.3559C7.45454 7.59037 7.40164 7.84247 7.39939 8.09756C7.3823 8.35526 7.42643 8.61335 7.52817 8.85073C7.6299 9.08812 7.78636 9.29806 7.98475 9.46341L11.1067 12.1951V17.0732H13.0579V11.0244L10.9116 8.78049ZM18.9116 10.2439C17.9468 10.2439 17.0037 10.53 16.2015 11.066C15.3993 11.602 14.7741 12.3639 14.4049 13.2552C14.0356 14.1465 13.939 15.1274 14.1273 16.0736C14.3155 17.0199 14.7801 17.889 15.4623 18.5712C16.1445 19.2535 17.0137 19.718 17.9599 19.9063C18.9062 20.0945 19.887 19.9979 20.7783 19.6287C21.6697 19.2595 22.4315 18.6342 22.9675 17.832C23.5035 17.0299 23.7896 16.0867 23.7896 15.1219C23.796 14.4796 23.6742 13.8424 23.4313 13.2477C23.1884 12.653 22.8294 12.1127 22.3751 11.6584C21.9209 11.2042 21.3806 10.8451 20.7859 10.6022C20.1911 10.3593 19.554 10.2375 18.9116 10.2439V10.2439ZM18.9116 18.5366C18.2362 18.5366 17.576 18.3363 17.0145 17.9611C16.453 17.5859 16.0153 17.0526 15.7569 16.4287C15.4984 15.8047 15.4308 15.1182 15.5626 14.4558C15.6943 13.7934 16.0195 13.185 16.4971 12.7074C16.9746 12.2299 17.583 11.9047 18.2454 11.7729C18.9078 11.6412 19.5944 11.7088 20.2183 11.9672C20.8422 12.2257 21.3755 12.6633 21.7507 13.2249C22.1259 13.7864 22.3262 14.4466 22.3262 15.1219C22.3153 16.0242 21.9521 16.8864 21.3141 17.5244C20.676 18.1624 19.8138 18.5257 18.9116 18.5366V18.5366Z"
                                        fill="#707070" />
                                    </svg></div>`;
                            }
                            else if (routeType == "bus") {
                                var routes = info.route.split("/")
                                for (var i=0; i<routes.length; i++) {
                                    routeIconsDiv[index-1].innerHTML += 
                                        `<div class="transportation" style="background: ${routeTextures[routeType].color}">
                                            <h1>${routes[i]}</h1>
                                        </div>`;
                                }
                            }
                            else if (routeType == "tram") {
                                routeIconsDiv[index-1].innerHTML += 
                                    `<div class="transportation" style="background: ${routeTextures[routeType].color}">
                                        <h1>${info.route}</h1>
                                    </div>`;
                            }
                            else if (routeType == "subway") {
                                console.log(info.route)
                                routeIconsDiv[index-1].innerHTML += 
                                    `<div class="transportation" style="background: ${routeTextures.subway[info.route].color}">
                                        <h1>${info.route}</h1>
                                    </div>`;
                            }
                        }

                        if (routeType == "pt") {
                            for (var i=0; i<info.legs.length; i++) {
                                addModeIcon(info.legs[i].mode.toLowerCase(), info.legs[i]);
                                if (i != info.legs.length -1) {
                                    routeIconsDiv[index-1].innerHTML += 
                                        `<div><svg width="8" height="13" viewBox="0 0 8 13" fill="none" xmlns="http://www.w3.org/2000/svg">
                                            <path
                                            d="M1.54958 -1.36256e-06C1.75249 0.0669132 1.89922 0.212233 2.04594 0.362284C3.87674 2.23657 5.70952 4.10882 7.54098 5.98108C7.79676 6.24265 7.85162 6.54884 7.68969 6.83069C7.65466 6.89152 7.6084 6.9483 7.55882 6.99899C5.67846 8.92329 3.79611 10.8462 1.91442 12.7705C1.7201 12.9693 1.4934 13.0544 1.22572 12.9638C0.981174 12.8814 0.835107 12.7009 0.791485 12.4414C0.757777 12.2413 0.816601 12.0649 0.944162 11.9121C0.979192 11.8702 1.01753 11.8317 1.0552 11.7925C2.74389 10.0662 4.43193 8.33998 6.12195 6.6144C6.15632 6.57925 6.20324 6.55695 6.24422 6.52856L6.24422 6.47178C6.20324 6.4434 6.15632 6.42109 6.12195 6.38594C4.42069 4.64887 2.7201 2.91044 1.02017 1.17202C0.76042 0.906386 0.71085 0.592767 0.879389 0.310239C0.977868 0.145319 1.13319 0.0648857 1.30173 -1.34089e-06L1.54958 -1.36256e-06Z"
                                            fill="#707070" />
                                        </svg></div>`;
                                }
                            }
                        }
                        else {
                            addModeIcon(routeType, info);
                        }
                    },
                    error: function(jqXHR, textStatus, err) {
                        res = false;
                    }
                });

                return res;
            }

            tries = 0;
            while (tries <= 3) {
                tries++;
                res = getAPIRoute(i);
                if (res)
                    break;
            }
        }

        // Default show 1st part trip
        var firstCard = document.querySelector(".trip-place")
        if (typeof firstCard.onclick == "function")
            firstCard.onclick.apply(firstCard);

        // Pull plan page down
        $("#planPage").animate({
            top: "0",
            bottom: "-200vh"
        }, 350, function () {
            $("#planPage").hide();
            $("#mapView").show();
        });
    }

    function dismissMapView() {
        // Pull plan page up
        $("#planPage").show();
        $("#planPage").animate({
            top: "0",
            bottom: "0"
        }, 350), function() {
            $("#mapView").hide();
        };
    }

    function showYourPosition(position) {  
        updatePosition = true;  
        // Mark marker
        if (yourMarker) {
            map.removeLayer(yourMarker);
        }
        
        yourMarker = new L.Marker([position.coords.latitude, position.coords.longitude], {bounceOnAdd: false, customId: "YouMarker"}).addTo(map);
        latLngStr = position.coords.latitude + "," + position.coords.longitude;

        post = latLngStr;
    }

    function positioningError(error) {

    }

    function showRoute(position1, position2) {
        // Routing display
        var today = new Date();
        var routeType = document.querySelector('input[name="transportMode"]:checked').value;
        if (routeType == "Public Transport") {
            routeType = "pt";
        }

        var position1 = position1.split(",");
        var position2 = position2.split(",");

        function decodeGeo(encodedRoute) {
            if (encodedRoute !== undefined || encodedRoute !== '' || encodedRoute != null ) {
                var routeGeo = L.Polyline.fromEncoded(encodedRoute, {
                    precision: 6
                });

                return routeGeo;
            }
        }

        $.ajax({
            url: `https://developers.onemap.sg/privateapi/routingsvc/route?start=${position1[0]},${position1[1]}&end=${position2[0]},${position2[1]}&routeType=${routeType}&token=${apiKey}&date=${String(today.getFullYear())}-${String(today.getMonth()+1)}-${String(today.getDate())}&time=${String(today.getHours())}:${String(today.getMinutes())}:${String(today.getSeconds())}&mode=TRANSIT`,
            success: function(result) {
                //Set result to a variable for writing
                var encodedRoute;
                var modes = [];

                // Remove previous markings and route paths
                if (startMarker) {
                    map.removeLayer(startMarker);
                }
                if (endMarker) {
                    map.removeLayer(endMarker);
                }
                pathPieces = [].slice.call(document.getElementsByTagName("path")).map(x => x.parentElement);
                for (var i=0; i<pathPieces.length; i++) {
                    pathPieces[i].remove();
                }

                startMarker = new L.Marker([position1[0], position1[1]], {bounceOnAdd: true}).addTo(map);
                endMarker = new L.Marker([position2[0], position2[1]], {bounceOnAdd: true}).addTo(map);
                 
                if (routeType == "pt") {
                    var allRoutes = result.plan.itineraries;
                    for (var i in allRoutes) {
                        var transportMeans = allRoutes[i].legs;
                        for (var j in transportMeans) {
                            var details = transportMeans[j];
                            var mode = details.mode.toLowerCase();

                            encodedRoute = details.legGeometry.points
                            var routeGeo = decodeGeo(encodedRoute);
                            modes = {endpoints: routeGeo._latlngs, mode: mode};

                            if (mode.toLowerCase == "subway") {
                                var subwayLine = details.route;
                                L.polyline(modes.endpoints, routeTextures.subway[subwayLine]).addTo(map);
                            }
                            else {
                                L.polyline(modes.endpoints, routeTextures[modes.mode]).addTo(map);
                            }
                        }

                        // Remove for the next time, only take 1st route
                        break
                    }
                }
                else {
                    encodedRoute = result.route_geometry;
                    var routeGeo = decodeGeo(encodedRoute);
                    modes = {endpoints: routeGeo._latlngs, mode: routeType.toUpperCase()};

                    L.polyline(modes.endpoints, routeTextures[modes.mode]).addTo(map);
                }
            }
        });
    }

    window.addEventListener('load', function () {
        getLocation();
        displayRouteDetails();
    });
</script>
{% endblock %}
